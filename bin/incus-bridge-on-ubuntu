#!/usr/bin/env bash
set -euo pipefail

# incus-bridge-on-ubuntu
# Creates br0 bridge for Incus VMs/containers on Ubuntu (netplan + networkd).

NETPLAN_FILE="/etc/netplan/01-incus-br0.yaml"

detect_primary_nic() {
    # Pick the first non-loopback, non-virtual ethernet device.
    ip -o link show | awk -F': ' '
        $2 !~ /^lo$/ && $2 ~ /^e/ {print $2; exit}
    '
}

primary_nic=$(detect_primary_nic)

if [ -z "$primary_nic" ]; then
    echo "Error: Could not detect a primary NIC."
    exit 1
fi

echo "Detected primary NIC: $primary_nic"

echo "Writing netplan file: $NETPLAN_FILE"

sudo tee "$NETPLAN_FILE" >/dev/null <<EOF
network:
  version: 2
  renderer: networkd

  ethernets:
    ${primary_nic}:
      dhcp4: false
      dhcp6: false

  bridges:
    br0:
      interfaces: [${primary_nic}]
      dhcp4: true
      dhcp6: true
EOF

echo "Applying netplan..."
sudo netplan apply

# Configure Incus default profile if needed
echo "Checking Incus default profile..."
if ! incus profile show default | grep -q "parent: br0"; then
    echo "Setting br0 as default Incus network..."
    incus profile device set default eth0 parent br0
else
    echo "Incus default profile already uses br0."
fi

echo "Done. Your host now uses br0 bridge, and Incus instances will obtain IP from router DHCP."
