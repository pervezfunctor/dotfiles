#!/usr/bin/env bash

set -euo pipefail

error_handler() {
  local exit_code=$?
  local line_number=$1
  fail "Command failed with exit code $exit_code at line $line_number"
  fail "Command: ${BASH_COMMAND}"
  exit $exit_code
}

trap 'error_handler $LINENO' ERR

SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_NAME

DOT_DIR=${DOT_DIR:-"$HOME/.ilm"}
# shellcheck disable=SC1091
source "$DOT_DIR/share/utils"

usage() {
  cat <<EOF
Usage: $SCRIPT_NAME [OPTIONS] USERNAME

Create a new user with sudo privileges or add sudo privileges to an existing user.

OPTIONS:
    -h, --help          Show this help message and exit

EXAMPLES:
    $SCRIPT_NAME newuser/existinguser

EOF
}

install_sudo() {
  if has_cmd apt-get; then
    apt-get update
    apt-get install -y sudo
    echo "sudo"
  elif has_cmd dnf; then
    dnf install -y sudo
    echo "wheel"
  elif has_cmd zypper; then
    zypper install -y sudo
    echo "wheel"
  elif has_cmd pacman; then
    pacman -Sy --noconfirm sudo
    echo "wheel"
  else
    die "Unsupported system. Cannot determine package manager."
  fi
}

add_user_to_sudo_group() {
  local sudo_group=$1

  usermod -aG "$sudo_group" "$USERNAME"

  if ! getent group "$sudo_group" | grep -q "\b${USERNAME}\b"; then
    warn "Verification failed: User '$USERNAME' was not added to group '$sudo_group'"
  else
    slog "User '$USERNAME' successfully added to group '$sudo_group'"
  fi
}

USERNAME=""
parse_args() {

  while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
      usage
      exit 0
      ;;
    -*)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    *)
      if [[ -z "$USERNAME" ]]; then
        USERNAME="$1"
      else
        fail "Multiple usernames provided. Only one username is allowed."
        usage
        exit 1
      fi
      ;;
    esac
    shift
  done
}

main() {
  check_root_user

  parse_args "$@"

  if [[ -z "$USERNAME" ]]; then
    fail "Username not provided."
    exit 1
  fi

  local sudo_group
  sudo_group=$(install_sudo)

  if id "$USERNAME" &>/dev/null; then
    slog "User '$USERNAME' already exists."
  else
    slog "Creating new user '$USERNAME'..."
    useradd -m "$USERNAME"
  fi

  passwd "$USERNAME"
  add_user_to_sudo_group "$sudo_group"

  slog "âœ… $USERNAME now has sudo privileges"
}

main "$@"
