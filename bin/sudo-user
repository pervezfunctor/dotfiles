#!/usr/bin/env bash

SCRIPT_NAME="$(basename "$0")"
readonly SCRIPT_NAME

DOT_DIR=${DOT_DIR:-"$HOME/.ilm"}
# shellcheck disable=SC1091
source "$DOT_DIR/share/utils"

usage() {
  cat <<EOF
Usage: $SCRIPT_NAME [OPTIONS] USERNAME

Create a new user with sudo privileges or add sudo privileges to an existing user.

OPTIONS:
    -h, --help          Show this help message and exit

EXAMPLES:
    $SCRIPT_NAME newuser
    $SCRIPT_NAME existinguser

EOF
}

install_sudo() {
  if is_apt; then
    apt-get update && apt-get install -y sudo
    echo "sudo"
  elif is_rh; then
    dnf install -y sudo
    echo "wheel"
  elif is_tw; then
    zypper install -y sudo
    echo "wheel"
  elif is_arch; then
    pacman -Sy --noconfirm sudo
    echo "wheel"
  else
    die "Unsupported system. Cannot determine package manager."
  fi
}

ensure_sudo_group() {
  local sudo_group=$1
  if ! getent group "$sudo_group" >/dev/null; then
    slog "Creating group $sudo_group"
    groupadd "$sudo_group" && slog "Group $sudo_group created!"
  fi
}

add_user_to_sudo_group() {
  local username=$1
  local sudo_group=$2

  usermod -aG "$sudo_group" "$username" || die "Failed to add user '$username' to group '$sudo_group'"
}

parse_args() {
  local username=""

  while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
      usage
      ;;
    -*)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    *)
      if [[ -z "$username" ]]; then
        username="$1"
      else
        fail "Multiple usernames provided. Only one username is allowed."
        usage
      fi
      shift
      ;;
    esac
  done
}

main() {
  check_root_user

  parse_args "$@"

  if [[ -z "$username" ]]; then
    fail "Username not provided."
    usage
  fi

  local sudo_group
  sudo_group=$(install_sudo)

  if id "$username" &>/dev/null; then
    slog "User '$username' already exists. Setting password..."
    passwd "$username" || die "Failed to set password for user '$username'"
  else
    slog "Creating new user '$username'..."
    useradd -m "$username" || die "Failed to create user '$username'"
  fi

  ensure_sudo_group "$sudo_group"
  add_user_to_sudo_group "$username" "$sudo_group"

  slog "âœ… $username now has sudo privileges"
}

main "$@"
