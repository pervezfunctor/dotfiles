#!/usr/bin/env bash
set -euo pipefail -o errtrace

DEVICE="${1:-}"
if [[ -z "$DEVICE" ]]; then
  echo "Usage: $0 <network-device>"
  exit 1
fi

if systemctl is-active --quiet NetworkManager; then
  echo "ðŸ§  Detected: NetworkManager"

  if ! command -v nmcli >/dev/null; then
    echo "âŒ NetworkManager is installed but nmcli not found (minimal image?)."
    exit 1
  fi

  if nmcli device show "$DEVICE" &>/dev/null; then
    echo "ðŸ”Œ Bringing up $DEVICE via NetworkManager"
    nmcli device connect "$DEVICE" || true
  fi

  if ! nmcli connection show | grep -q "$DEVICE"; then
    echo "âž• Creating new DHCP connection for $DEVICE"
    nmcli connection add type ethernet ifname "$DEVICE" con-name "dhcp-$DEVICE" dhcp4 yes
  fi

  echo "ðŸš€ Bringing up connection for $DEVICE"
  nmcli connection up "dhcp-$DEVICE"

elif systemctl is-active --quiet systemd-networkd; then
  echo "ðŸ§  Detected: systemd-networkd"

  NET_DIR="/etc/systemd/network"
  NET_FILE="$NET_DIR/20-dhcp-${DEVICE}.network"

  sudo mkdir -p "$NET_DIR"
  echo "ðŸ“„ Writing DHCP config to $NET_FILE"

  sudo tee "$NET_FILE" >/dev/null <<EOF
[Match]
Name=$DEVICE

[Network]
DHCP=yes
EOF

  echo "ðŸ” Restarting systemd-networkd"
  sudo systemctl restart systemd-networkd
  sudo ip link set "$DEVICE" up

else
  echo "âŒ Neither NetworkManager nor systemd-networkd is active."
  echo "Please enable one of them to manage networking."
  exit 1
fi

echo "âœ… DHCP setup complete for $DEVICE"
