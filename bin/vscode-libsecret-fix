#!/usr/bin/env bash

set -euo pipefail

vscode-libsecret-fix() {
  FILE="$HOME/.vscode/argv.json"
  TMP="$(mktemp)"

  if grep -q '"password-store"' "$FILE"; then
    echo "Key already exists in $FILE"
    exit 0
  fi

  # Find last non-comment, non-empty line before closing brace
  awk '
  /^\s*\/\// { print; next }                # keep comment lines
  /^\s*$/ { print; next }                   # keep blank lines
  /^\s*}/ {
    if (!inserted) {
      printf "  \"password-store\": \"libsecret\",\n"
      inserted = 1
    }
  }
  { print }
' "$FILE" >"$TMP"

  mv "$TMP" "$FILE"
  echo "Inserted \"password-store\": \"libsecret\" into $FILE"
}

vscode-libsecret-fix
