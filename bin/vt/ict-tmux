#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/incus-utils"
source "$(dirname "$0")/tmux-utils"

SESSION_NAME="ICT"

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTION]

Manage a tmux session with SSH connections to Incus LXC containers.

Options:
  create    Create a new tmux session with SSH connections to containers (default if no option)
  --select  Select containers interactively using fzf and create a tmux session
  attach    Attach to an existing session
  detach    Detach from the current session
  destroy   Kill the tmux session
  help      Display this help message

Examples:
  $(basename "$0")           # Create session or attach if exists
  $(basename "$0") create    # Force create a new session
  $(basename "$0") --select  # Select containers interactively and create session
  $(basename "$0") attach    # Attach to existing session
  $(basename "$0") detach    # Detach from current session
  $(basename "$0") destroy   # Kill the session
EOF
}

create_session() {
  local force="$1"
  shift

  local -a containers=("$@")

  if [[ ${#containers[@]} -eq 0 ]]; then
    containers=("${DISTRO_LIST_ict[@]}")
  fi

  tmux_session "$SESSION_NAME" "$force"

  slog "Creating tmux session '$SESSION_NAME' with SSH connections to ${#containers[@]} Incus container(s)..."

  local ssh_cmds=()
  create_commands ssh_cmds "ict" "${containers[@]}"

  start_sessions "ict" "${containers[@]}"

  if ! tmux_grid "$SESSION_NAME" "${ssh_cmds[@]}"; then
    fail "Failed to create tmux session '$SESSION_NAME' with SSH connections to containers."
    return 1
  fi

  if ! tmux attach-session -t "$SESSION_NAME"; then
    fail "Failed to attach to tmux session '$SESSION_NAME'."
    return 1
  fi
}

select_session() {
  local -a available_containers
  mapfile -t available_containers < <(ict_list)

  if [[ ${#available_containers[@]} -eq 0 ]]; then
    fail "No containers found. Please create containers first."
    exit 1
  fi

  local -a selected_containers
  mapfile -t selected_containers < <(select-multi "Select containers to connect to:" "${available_containers[@]}")

  if [[ ${#selected_containers[@]} -eq 0 ]]; then
    slog "No containers selected."
    exit 1
  fi

  create_session "true" "${selected_containers[@]}"
}

main() {
  ict_check_prerequisites
  check_tmux

  local command="${1:-}"

  case "$command" in
  create)
    create_session "true"
    ;;
  --select | -s | select)
    select_session
    ;;
  attach)
    attach_session "$SESSION_NAME"
    ;;
  detach)
    detach_session "$SESSION_NAME"
    ;;
  destroy)
    destroy_session "$SESSION_NAME"
    ;;
  help | --help | -h)
    usage
    ;;
  "")
    create_session "true"
    ;;
  *)
    fail "Unknown option: $command"
    usage
    exit 1
    ;;
  esac
}

main "$@"
