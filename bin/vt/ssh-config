#!/usr/bin/env bash
set -euo pipefail -o errtrace

CONFIG_FILE="${HOME}/.ssh/config"
CONF_DIR="${HOME}/.ssh/conf.d"

# Input validation functions
validate_host() {
  local host="$1"
  # Allow alphanumeric, hyphens, underscores, and dots
  if [[ ! "$host" =~ ^[a-zA-Z0-9._-]+$ ]]; then
    printf "Error: Invalid host format. Only alphanumeric characters, dots, hyphens, and underscores are allowed.\n" >&2
    return 1
  fi
}

validate_hostname() {
  local hostname="$1"
  # Basic IP or hostname validation
  if [[ ! "$hostname" =~ ^[a-zA-Z0-9.-]+$ ]] && [[ ! "$hostname" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    printf "Error: Invalid hostname format.\n" >&2
    return 1
  fi
}

validate_user() {
  local user="$1"
  # Allow alphanumeric, hyphens, and underscores (common username format)
  if [[ ! "$user" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    printf "Error: Invalid username format. Only alphanumeric characters, hyphens, and underscores are allowed.\n" >&2
    return 1
  fi
}

validate_port() {
  local port="$1"
  # Port must be a number between 1 and 65535
  if [[ ! "$port" =~ ^[0-9]+$ ]] || [[ "$port" -lt 1 ]] || [[ "$port" -gt 65535 ]]; then
    printf "Error: Invalid port number. Must be between 1 and 65535.\n" >&2
    return 1
  fi
}

validate_identity() {
  local identity="$1"
  # Check if identity file exists or can be expanded
  if [[ -n "$identity" ]]; then
    # Expand ~ to $HOME
    expanded_identity="${identity/#\~/$HOME}"
    # Check if file exists or if path looks reasonable
    if [[ ! -f "$expanded_identity" ]] && [[ ! "$expanded_identity" =~ ^/ ]]; then
      printf "Warning: Identity file '%s' does not exist. Using as specified.\n" "$identity" >&2
    fi
  fi
}

usage() {
  printf "Usage:\n"
  printf "  %s list\n" "$0"
  printf "  %s add --host <host> --ip <ip> --user <user> [--port <port>] [--identity <identity_file>]\n" "$0"
  printf "  %s remove <host>\n" "$0"
  printf "\n"
  printf "Examples:\n"
  printf "  %s list\n" "$0"
  printf "  %s add --host myvm --ip 192.168.1.10 --user ubuntu --port 22 --identity ~/.ssh/id_rsa\n" "$0"
  printf "  %s remove myvm\n" "$0"
  exit 1
}

ensure_config_file() {
  mkdir -p "${HOME}/.ssh"
  # Create file with secure permissions if it doesn't exist
  if [[ ! -f "$CONFIG_FILE" ]]; then
    touch "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"
  fi
}

ensure_conf_dir() {
  mkdir -p "$CONF_DIR"
  chmod 700 "$CONF_DIR"
}

# Function to extract include patterns from config file
get_include_files() {
  if [[ -f "$CONFIG_FILE" ]]; then
    awk '/^[[:space:]]*Include[[:space:]]+/ {
            # Remove the "Include" keyword and trim whitespace
            sub(/^[[:space:]]*Include[[:space:]]+/, "")
            include_path = $0
            # Expand ~ to $HOME
            gsub(/^~\//, ENVIRON["HOME"] "/", include_path)
            # Expand environment variables
            while (match(include_path, /\$[A-Za-z_][A-Za-z0-9_]*/)) {
                var = substr(include_path, RSTART+1, RLENGTH-1)
                gsub(/\$[A-Za-z_][A-Za-z0-9_]*/, ENVIRON[var], include_path)
            }
            print include_path
        }' "$CONFIG_FILE"
  fi
}

# Function to list hosts from a specific file
list_hosts_from_file() {
  local file="$1"
  if [[ -f "$file" ]]; then
    awk '
          /^Host[[:space:]]+/ {
              host=$2
              print host
          }
        ' "$file"
  fi
}

list_configs() {
  # List hosts from main config file
  list_hosts_from_file "$CONFIG_FILE"

  # List hosts from included files
  while IFS= read -r include_pattern; do
    if [[ -n "$include_pattern" ]]; then
      # Expand glob patterns
      for file in $include_pattern; do
        if [[ -f "$file" ]]; then
          list_hosts_from_file "$file"
        fi
      done
    fi
  done < <(get_include_files)
}

host_exists() {
  local host="$1"
  # Properly escape the host for regex matching
  local escaped_host
  escaped_host=$(printf '%s\n' "$host" | sed 's/[][\.^$*+?()|{}]/\\&/g')

  # Check main config file
  if [[ -f "$CONFIG_FILE" ]] && grep -qE "^Host[[:space:]]+${escaped_host}\$" "$CONFIG_FILE"; then
    return 0
  fi

  # Check included files
  while IFS= read -r include_pattern; do
    if [[ -n "$include_pattern" ]]; then
      # Expand glob patterns
      for file in $include_pattern; do
        if [[ -f "$file" ]] && grep -qE "^Host[[:space:]]+${escaped_host}\$" "$file"; then
          return 0
        fi
      done
    fi
  done < <(get_include_files)

  return 1
}

find_host_file() {
  local host="$1"
  local escaped_host
  escaped_host=$(printf '%s\n' "$host" | sed 's/[][\.^$*+?()|{}]/\\&/g')

  # Check main config file
  if [[ -f "$CONFIG_FILE" ]] && grep -qE "^Host[[:space:]]+${escaped_host}\$" "$CONFIG_FILE"; then
    printf "%s\n" "$CONFIG_FILE"
    return 0
  fi

  # Check included files
  while IFS= read -r include_pattern; do
    if [[ -n "$include_pattern" ]]; then
      # Expand glob patterns
      for file in $include_pattern; do
        if [[ -f "$file" ]] && grep -qE "^Host[[:space:]]+${escaped_host}\$" "$file"; then
          printf "%s\n" "$file"
          return 0
        fi
      done
    fi
  done < <(get_include_files)

  return 1
}

add_config() {
  local host="$1"
  local hostname="$2"
  local user="$3"
  local port="${4:-22}"
  local identity="$5"

  # Validate inputs
  validate_host "$host" || return 1
  validate_hostname "$hostname" || return 1
  validate_user "$user" || return 1
  validate_port "$port" || return 1
  validate_identity "$identity" || return 1

  if host_exists "$host"; then
    printf "Host '%s' already exists. Skipping (idempotent).\n" "$host"
    return 0
  fi

  # Ensure conf.d directory exists
  ensure_conf_dir

  # Create a separate file for this host in conf.d
  local host_file="${CONF_DIR}/${host}.conf"

  # Use atomic write operation with temporary file
  local temp_file
  temp_file=$(mktemp)

  # Write the host configuration
  {
    echo "Host $host"
    echo "    HostName $hostname"
    echo "    User $user"
    echo "    Port $port"
    echo "    IdentitiesOnly yes"
    if [[ -n "$identity" ]]; then
      echo "    IdentityFile $identity"
    fi
  } >"$temp_file"

  # Atomic move with proper permissions
  mv "$temp_file" "$host_file"
  chmod 600 "$host_file"

  printf "Added host '%s' to %s.\n" "$host" "$host_file"
}

remove_config() {
  local host="$1"

  # Validate input
  validate_host "$host" || return 1

  local host_file
  if ! host_file=$(find_host_file "$host"); then
    printf "Host '%s' not found. Skipping (idempotent).\n" "$host"
    return 0
  fi

  # If the host is in the main config file, use the original removal method
  if [[ "$host_file" == "$CONFIG_FILE" ]]; then
    # Use atomic write operation with secure temporary file
    local temp_file
    temp_file=$(mktemp)

    # Properly escape the host for awk
    local escaped_host
    escaped_host=$(printf '%s\n' "$host" | sed 's/[][\.^$*+?()|{}]/\\&/g')

    # Remove entire Host block (Host line + indented lines following)
    # until next Host or EOF.
    awk -v h="$escaped_host" '
          BEGIN {skip=0}
          $0 ~ "^Host[[:space:]]+"h"$" { skip=1; next }
          /^Host[[:space:]]+/ { skip=0 }
          skip==1 { next }
          { print }
        ' "$CONFIG_FILE" >"$temp_file"

    # Atomic move with proper permissions
    mv "$temp_file" "$CONFIG_FILE"
    chmod 600 "$CONFIG_FILE"

    printf "Removed host '%s' from %s.\n" "$host" "$CONFIG_FILE"
  else
    # If the host is in a conf.d file, remove the entire file
    rm "$host_file"
    printf "Removed host '%s' by deleting %s.\n" "$host" "$host_file"
  fi
}

main() {
  ensure_config_file

  case "${1:-}" in
  ls | list)
    list_configs
    ;;
  add)
    local host=""
    local ip=""
    local user=""
    local port="22"
    local identity=""

    shift
    while [[ $# -gt 0 ]]; do
      case "$1" in
      --host)
        host="$2"
        shift 2
        ;;
      --ip)
        ip="$2"
        shift 2
        ;;
      --user)
        user="$2"
        shift 2
        ;;
      --port)
        port="$2"
        shift 2
        ;;
      --identity)
        identity="$2"
        shift 2
        ;;
      *)
        usage
        ;;
      esac
    done

    if [[ -z "$host" || -z "$ip" || -z "$user" ]]; then
      usage
    fi

    add_config "$host" "$ip" "$user" "$port" "$identity"
    ;;
  remove)
    [[ $# -ne 2 ]] && usage
    remove_config "$2"
    ;;
  *)
    usage
    ;;
  esac
}

main "$@"
