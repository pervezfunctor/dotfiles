#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/dt-utils"
source "$(dirname "$0")/tmux-utils"

SESSION_NAME="DT"

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTION]

Manage a tmux session with connections to distrobox containers.

Options:
  create    Create a new tmux session with connections to containers (default if no option)
  --select  Select containers interactively using fzf and create a tmux session
  attach    Attach to an existing session
  detach    Detach from the current session
  destroy   Kill the tmux session
  help      Display this help message

Examples:
  $(basename "$0")           # Create session or attach if exists
  $(basename "$0") create    # Force create a new session
  $(basename "$0") --select  # Select containers interactively and create session
  $(basename "$0") attach    # Attach to existing session
  $(basename "$0") detach    # Detach from current session
  $(basename "$0") destroy   # Kill the session
EOF
}

check_distrobox() {
  has_cmd distrobox || die "distrobox is not installed. Please install it first."
}

dt_exists() {
  local container_name="$1"
  distrobox list | grep -q "^$container_name "
  return $?
}

dt_check_exists() {
  local container_name="$1"
  if ! dt_exists "$container_name"; then
    fail "Container '$container_name' does not exist"
    return 1
  fi
  return 0
}

create_command_dt() {
  local vm_name="$1"
  echo "distrobox enter -nw --clean-path --name ${vm_name}"
}

create_session() {
  local force="$1"
  shift

  local -a containers=("$@")

  if [[ ${#containers[@]} -eq 0 ]]; then
    containers=("${DISTRO_LIST_dt[@]}")
  fi

  tmux_session "$SESSION_NAME" "$force"

  slog "Creating tmux session '$SESSION_NAME' with connections to ${#containers[@]} Distrobox container(s)..."

  local -a container_names=()
  generate_names container_names "dt" "${containers[@]}"

  local ssh_cmds=()
  create_commands_generic ssh_cmds "dt" "${container_names[@]}"

  start_sessions "dt" "${container_names[@]}"

  if ! tmux_grid "$SESSION_NAME" "${ssh_cmds[@]}"; then
    fail "Failed to create tmux session '$SESSION_NAME' with SSH connections to containers."
    return 1
  fi

  if ! tmux attach-session -t "$SESSION_NAME"; then
    fail "Failed to attach to tmux session '$SESSION_NAME'."
    return 1
  fi
}

select_session() {
  local -a available_containers
  mapfile -t available_containers < <(dt list)

  if [[ ${#available_containers[@]} -eq 0 ]]; then
    fail "No containers found. Please create containers first."
    exit 1
  fi

  local -a selected_containers
  mapfile -t selected_containers < <(select-multi "Select containers to connect to:" "${available_containers[@]}")

  if [[ ${#selected_containers[@]} -eq 0 ]]; then
    slog "No containers selected."
    exit 1
  fi

  create_session "true" "${selected_containers[@]}"
}

main() {
  check_distrobox
  check_tmux

  local command="${1:-}"

  case "$command" in
  create | -c | --create | "")
    create_session "true"
    ;;
  --select | -s | select)
    select_session
    ;;
  attach)
    attach_session "$SESSION_NAME"
    ;;
  detach)
    detach_session "$SESSION_NAME"
    ;;
  destroy)
    destroy_session "$SESSION_NAME"
    ;;
  help | --help | -h)
    usage
    ;;
  *)
    fail "Unknown option: $command"
    usage
    exit 1
    ;;
  esac
}

main "$@"
