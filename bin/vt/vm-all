#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail

source "$(dirname "$0")/vm-utils"
source "$(dirname "$0")/all-utils"

all_create() {
  slog "Creating libvirt VMs (Ubuntu, Fedora, Alpine, Debian)..."

  for distro in "${VM_DISTRO_LIST[@]}"; do
    if vm_exists "${distro}-vm"; then
      warn "$distro VM already exists, skipping..."
    else
      vm-create --distro "$distro" --name "${distro}-vm"
    fi
  done

  success "All VMs created successfully!"
  slog "You can access them using: virsh console <vm-name>"
}

usage() {
  all_usage "libvirt" "VMs"
}

all_op() {
  local op="$1"
  slog "Performing operation '$op' on all VMs..."

  for vm in "${VM_DISTRO_LIST[@]}"; do
    if vm_exists "${vm}-vm"; then
      vm "$op" "${vm}-vm"
    else
      warn "VM ${vm}-vm does not exist, skipping..."
    fi
  done

  success "Performed operation '$op' on all VMs successfully!"
}

all_delete() {
  all_op "delete"
}

all_start() {
  all_op "start"
}

all_stop() {
  all_op "stop"
}

all_restart() {
  all_op "restart"
}

main() {
  virt_check_prerequisites
  all_parse_args "$@"
}

main "$@"
