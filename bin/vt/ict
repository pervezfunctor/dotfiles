#!/usr/bin/env bash

set -euo pipefail -o errtrace

# shellcheck disable=SC1091
source "$(dirname "$0")/incus-utils"

usage() {
  cat <<EOF
Usage: $0 <command> [container-name] [args...]

Manage Incus LXC containers similar to other container management tools.

COMMANDS:
    list                    List all Incus containers
    list-remote-images      List all remote images available for container creation
    status <name>           Show container status and info
    create [ict-create args]  Create a new Incus container (forwards all args to ict-create)
    create-all [ict-create-multi args]  Create multiple Incus containers (forwards all args to ict-create-multi)
    start [name...]         Start container(s) - if no names provided, select from list
    stop [name...]          Gracefully stop container(s) - if no names provided, select from list
    restart [name...]       Restart container(s) - if no names provided, select from list
    delete [name...]        Delete container(s) - if no names provided, select from list
    console <name>          Enter container shell
    exec <name> <cmd>       Execute command in container
    ip <name>               Get container IP address
    ssh <name> [username]   Connect to container via SSH
    info <name>             Show detailed container information
    config <name>           Show container configuration
    logs <n> [type]      Show container logs (instance, console, or system)
    usb-list             List all available USB devices on host
    usb-attached <n>     List USB devices attached to container
    usb-attach <n> <device> [name]  Attach USB device to container
    usb-detach <n> <device>         Detach USB device from container
    snapshot <name> [snap]  Create container snapshot
    restore <name> <snap>   Restore container from snapshot
    copy <src> <dest>       Copy container
    is-running <name>       Check if container is running (exit 0 if running, 1 if not)

EXAMPLES:
    $0 list                         # List all containers
    $0 status ubuntu                # Show status of 'ubuntu' container
    $0 create --distro ubuntu --name myubuntu  # Create Ubuntu container named 'myubuntu'
    $0 create --distro fedora --dotfiles shell-slim docker  # Create Fedora container with dotfiles and Docker
    $0 console ubuntu               # Enter 'ubuntu' container shell
    $0 exec ubuntu "ls -la"         # Run command in 'ubuntu' container
    $0 ip ubuntu                    # Get IP address of 'ubuntu' container
    $0 ssh ubuntu                   # SSH to 'ubuntu' container (auto-detect username)
    $0 ssh ubuntu root              # SSH to 'ubuntu' container as 'root' user
    $0 logs ubuntu                  # Show instance logs for 'ubuntu' container
    $0 logs ubuntu console          # Show console logs for 'ubuntu' container
    $0 logs ubuntu system           # Show system logs for 'ubuntu' container
    $0 snapshot ubuntu backup       # Create snapshot named 'backup'
    $0 delete old-container         # Delete 'old-container' completely
    $0 usb-list                     # List available USB devices
    $0 usb-attach ubuntu 1234:5678  # Attach USB device to container
    $0 usb-detach ubuntu my-usb     # Detach USB device from container
    $0 is-running ubuntu            # Check if ubuntu container is running

    # Multi-container operations:
    $0 start ubuntu fedora          # Start multiple containers
    $0 stop                         # Select containers to stop from menu
    $0 restart ubuntu               # Restart single container
    $0 delete ubuntu fedora arch     # Delete multiple containers

EOF
}

container_status() {
  local container_name="$1"
  ict_check_exists "$container_name"

  slog "Status for container '$container_name':"
  echo
  incus list type=container "$container_name"
  echo

  slog "Detailed information:"
  incus info "$container_name" | head -20
}

create_ict() {
  ict-create "$@"
}

start_ict() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  ict_check_running "$container_name" && {
    warn "Container '$container_name' is already running"
    return 0
  }

  slog "Starting container '$container_name'..."
  if incus start "$container_name"; then
    success "Container '$container_name' started"
    sleep 1
    incus list type=container "$container_name"
  else
    fail "Failed to start container '$container_name'"
    return 1
  fi
}

stop_ict() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  ict_check_running "$container_name" || return 0

  slog "Stopping container '$container_name'..."
  if incus stop "$container_name"; then
    success "Container '$container_name' stopped"
  else
    fail "Failed to stop container '$container_name'"
    return 1
  fi
}

restart_ict() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1
  ict_check_running "$container_name" || return 0

  slog "Restarting container '$container_name'..."
  if incus restart "$container_name"; then
    success "Container '$container_name' restarted"
    sleep 2
    incus list type=container "$container_name"
  else
    fail "Failed to restart container '$container_name'"
    return 1
  fi
}

delete_ict() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  warn "This will permanently delete container '$container_name' and all its data!"
  read -p "Are you sure? (y/N): " -r
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    slog "Deletion cancelled"
    return 0
  fi

  if ict_running "$container_name"; then
    slog "Stopping container first..."
    incus stop "$container_name" --force
  fi

  slog "Deleting container '$container_name'..."
  if incus delete "$container_name"; then
    success "Container '$container_name' deleted successfully"
  else
    fail "Failed to delete container '$container_name'"
    return 1
  fi
}

console_ict() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  ict_check_running "$container_name" || return 1

  # Try to find an appropriate user for this container
  local username
  username=$(detect_container_user "$container_name")

  # Check if the detected user exists in the container
  if incus exec "$container_name" -- id "$username" >/dev/null 2>&1; then
    slog "Entering shell of container '$container_name' as user '$username'..."
    incus exec "$container_name" -- su - "$username"
  else
    # Fall back to root if no suitable user found
    slog "No suitable user found, entering shell of container '$container_name' as root..."
    incus shell "$container_name"
  fi
}

exec_ict() {
  local container_name="$1"
  shift
  local command="$*"
  ict_check_exists "$container_name" || return 1
  ict_check_running "$container_name" || return 1

  slog "Executing command in container '$container_name': $command"
  incus exec "$container_name" -- "$@"
}

show_ict_info() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  slog "Detailed information for container '$container_name':"
  echo
  incus info "$container_name"
}

show_ict_config() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  slog "Configuration for container '$container_name':"
  echo
  incus config show "$container_name"
}

show_logs() {
  local container_name="$1"
  local log_type="${2:-console}"
  ict_check_exists "$container_name" || return 1

  local state
  state=$(ict_state "$container_name")

  case "$log_type" in
  console)
    slog "Showing console logs for container '$container_name'..."
    echo
    incus console "$container_name" --show-log
    ;;
  instance)
    slog "Showing instance logs for container '$container_name'..."
    echo
    incus info "$container_name" --show-log
    ;;
  system)
    if [[ "$state" != "RUNNING" ]]; then
      fail "Container '$container_name' is not running"
      slog "Start it with: $0 start $container_name"
      return 1
    fi

    slog "Showing system logs for container '$container_name'..."
    echo

    slog "=== Recent system messages (journalctl) ==="
    incus exec "$container_name" -- journalctl --no-pager -n 50 2>/dev/null || {
      slog "=== System log (/var/log/syslog) ==="
      incus exec "$container_name" -- tail -50 /var/log/syslog 2>/dev/null || {
        slog "=== System messages (/var/log/messages) ==="
        incus exec "$container_name" -- tail -50 /var/log/messages 2>/dev/null || {
          warn "Could not read system logs - container may not have systemd or standard log files"
        }
      }
    }
    ;;
  *)
    fail "Unknown log type: $log_type"
    slog "Available log types: instance, console, system"
    return 1
    ;;
  esac
}

create_snapshot() {
  local container_name="$1"
  local snapshot_name="${2:-snap-$(date +%Y%m%d-%H%M%S)}"
  ict_check_exists "$container_name" || return 1

  slog "Creating snapshot '$snapshot_name' for container '$container_name'..."
  if incus snapshot "$container_name" "$snapshot_name"; then
    success "Snapshot '$snapshot_name' created successfully"
  else
    fail "Failed to create snapshot '$snapshot_name'"
    return 1
  fi
}

restore_snapshot() {
  local container_name="$1"
  local snapshot_name="$2"
  ict_check_exists "$container_name" || return 1

  if [[ -z "$snapshot_name" ]]; then
    fail "Snapshot name required"
    return 1
  fi

  warn "This will restore container '$container_name' to snapshot '$snapshot_name'"
  warn "All changes since the snapshot will be lost!"
  read -p "Are you sure? (y/N): " -r
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    slog "Restore cancelled"
    return 0
  fi

  slog "Restoring container '$container_name' from snapshot '$snapshot_name'..."
  if incus restore "$container_name" "$snapshot_name"; then
    success "Container '$container_name' restored from snapshot '$snapshot_name'"
  else
    fail "Failed to restore container '$container_name' from snapshot '$snapshot_name'"
    return 1
  fi
}

copy_ict() {
  local source_ict="$1"
  local dest_ict="$2"
  ict_check_exists "$source_ict" || return 1
  ict_check_exists "$dest_ict" && {
    fail "Destination container '$dest_ict' already exists"
    return 1
  }

  if [[ -z "$dest_ict" ]]; then
    fail "Destination container name required"
    return 1
  fi

  if ! incus info "$source_ict" >/dev/null 2>&1; then
    fail "Source container '$source_ict' not found"
    return 1
  fi

  if incus info "$dest_ict" >/dev/null 2>&1; then
    fail "Destination container '$dest_ict' already exists"
    return 1
  fi

  slog "Copying container '$source_ict' to '$dest_ict'..."
  if incus copy "$source_ict" "$dest_ict"; then
    success "Container '$source_ict' copied to '$dest_ict'"
  else
    fail "Failed to copy container '$source_ict' to '$dest_ict'"
    return 1
  fi
}

is-running_ict() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1
  ict_check_running "$container_name"
}

# Handler functions for handle_one_argument
status_ict() {
  local container_name="$1"
  container_status "$container_name"
}

info_ict() {
  local container_name="$1"
  show_ict_info "$container_name"
}

config_ict() {
  local container_name="$1"
  show_ict_config "$container_name"
}

logs_ict() {
  local container_name="$1"
  shift
  show_logs "$container_name" "$@"
}

snapshot_ict() {
  local container_name="$1"
  shift
  create_snapshot "$container_name" "$@"
}

restore_ict() {
  local container_name="$1"
  shift
  restore_snapshot "$container_name" "$@"
}

usb_attached_ict() {
  local container_name="$1"
  list_ict_usb_devices "$container_name"
}

usb_attach_ict() {
  local container_name="$1"
  shift
  attach_usb_device "$container_name" "$@"
}

usb_detach_ict() {
  local container_name="$1"
  shift
  detach_usb_device "$container_name" "$@"
}

is_running_ict() {
  local container_name="$1"
  is-running_ict "$container_name"
}

# Main command handling
# USB device management functions
list_host_usb_devices() {
  slog "Available USB devices on host:"
  echo
  printf "%-3s %-6s %-9s %s\n" "Bus" "Device" "ID" "Description"
  printf "%-3s %-6s %-9s %s\n" "---" "------" "---------" "-----------"

  while IFS= read -r line; do
    if [[ "$line" =~ ^Bus\ ([0-9]+)\ Device\ ([0-9]+):\ ID\ ([0-9a-f]{4}):([0-9a-f]{4})\ (.*)$ ]]; then
      local bus="${BASH_REMATCH[1]}"
      local device="${BASH_REMATCH[2]}"
      local vendor="${BASH_REMATCH[3]}"
      local product="${BASH_REMATCH[4]}"
      local description="${BASH_REMATCH[5]}"
      printf "%-3s %-6s %s:%s %s\n" "$bus" "$device" "$vendor" "$product" "$description"
    fi
  done < <(lsusb)
  echo
  slog "Usage examples:"
  slog "  By USB ID: $0 usb-attach CONTAINER_NAME vendor:product"
  slog "  By Bus/Device: $0 usb-attach CONTAINER_NAME bus.device"
}

list_ict_usb_devices() {
  local container_name="$1"
  ict_check_exists "$container_name" || return 1

  slog "USB devices attached to container '$container_name':"
  echo
  incus config device list "$container_name" | grep -E "^usb" || {
    slog "No USB devices attached to container '$container_name'"
  }
}

attach_usb_device() {
  local container_name="$1"
  local device_spec="$2"
  local device_name="${3:-usb-$(date +%s)}"

  ict_check_exists "$container_name" || return 1

  local state
  state=$(ict_state "$container_name")

  if [[ "$state" != "RUNNING" ]]; then
    fail "Container '$container_name' must be running to attach USB devices"
    slog "Start it with: $0 start $container_name"
    return 1
  fi

  # Parse device specification
  local vendor_id product_id bus device
  if [[ "$device_spec" =~ ^([0-9a-f]{4}):([0-9a-f]{4})$ ]]; then
    vendor_id="${BASH_REMATCH[1]}"
    product_id="${BASH_REMATCH[2]}"
    slog "Attaching USB device $vendor_id:$product_id to container '$container_name' as '$device_name'..."
    incus config device add "$container_name" "$device_name" usb vendorid="$vendor_id" productid="$product_id"
  elif [[ "$device_spec" =~ ^([0-9]+)\.([0-9]+)$ ]]; then
    bus="${BASH_REMATCH[1]}"
    device="${BASH_REMATCH[2]}"
    slog "Attaching USB device bus $bus device $device to container '$container_name' as '$device_name'..."
    incus config device add "$container_name" "$device_name" usb busnum="$bus" devnum="$device"
  else
    fail "Invalid device specification: $device_spec"
    slog "Use format: vendor:product (e.g., 1234:5678) or bus.device (e.g., 1.2)"
    return 1
  fi

  if [[ $? -eq 0 ]]; then
    success "USB device attached successfully as '$device_name'"
  else
    fail "Failed to attach USB device"
    return 1
  fi
}

detach_usb_device() {
  local container_name="$1"
  local device_name="$2"

  ict_check_exists "$container_name" || return 1

  slog "Detaching USB device '$device_name' from container '$container_name'..."
  if incus config device remove "$container_name" "$device_name"; then
    success "USB device '$device_name' detached successfully"
  else
    fail "Failed to detach USB device '$device_name'"
    return 1
  fi
}

list_remote_images() {
  slog "Listing all remote images available for container creation..."
  echo
  incus image list images: --format csv | grep cloud | cut -d',' -f1
}

list_ict() {
  incus list type=container --format csv --columns n
}

ip_ict() {
  is-running_ict "$@" || return 1
  ict_ip "$@"
}

ssh_ict() {
  local container_name="$1"
  local username="${2:-$USER}"

  is-running_ict "$container_name" || return 1

  local ip
  if ! ip=$(ict_ip "$container_name"); then
    fail "Failed to get IP for container '$container_name'"
    return 1
  fi

  ssh -o "ConnectTimeout=15" "$username@$ip"
}

parse_args() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 1
  fi

  command="$1"
  shift

  incus_check

  case "$command" in
  ls | list)
    ict_list "$@"
    ;;
  lsi | list-remote-images)
    list_remote_images
    ;;
  status)
    handle_one_argument ict status "$@"
    ;;
  create)
    create_ict "$@"
    ;;
  create-all)
    ict-create-multi "$@"
    ;;
  start)
    handle_multiple_arguments ict start "$@"
    ;;
  shutdown | stop)
    handle_multiple_arguments ict stop "$@"
    ;;
  restart)
    handle_multiple_arguments ict restart "$@"
    ;;
  rm | delete)
    handle_multiple_arguments ict delete "$@"
    ;;
  console)
    handle_one_argument ict console "$@"
    ;;
  exec)
    handle_one_argument ict exec "$@"
    ;;
  ip)
    handle_one_argument ict ip "$@"
    ;;
  ssh)
    handle_one_argument ict ssh "$@"
    ;;
  info)
    handle_one_argument ict info "$@"
    ;;
  config)
    handle_one_argument ict config "$@"
    ;;
  logs)
    handle_one_argument ict logs "$@"
    ;;
  snapshot)
    handle_one_argument ict snapshot "$@"
    ;;
  restore)
    handle_one_argument ict restore "$@"
    ;;
  copy)
    copy_ict "$@"
    ;;
  usb-list)
    list_host_usb_devices
    ;;
  usb-attached)
    handle_one_argument ict usb_attached "$@"
    ;;
  usb-attach)
    handle_one_argument ict usb_attach "$@"
    ;;
  usb-detach)
    handle_one_argument ict usb_detach "$@"
    ;;
  is-running)
    handle_one_argument ict is_running "$@"
    ;;
  --help | -h)
    usage
    ;;
  *)
    fail "Unknown command: $command"
    usage
    exit 1
    ;;
  esac
}

main() {
  parse_args "$@"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
