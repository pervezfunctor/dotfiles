#!/usr/bin/env bash

set -euo pipefail

DOT_DIR=${DOT_DIR:-$HOME/.ilm}

# shellcheck disable=SC1091
source "$(dirname "$0")/vmu-utils"

unset DISTRO
unset VM_NAME
unset USERNAME
unset PASSWORD
unset DISK_IMG

SCRIPT_NAME="$(basename "$0")"

usage() {
  cat <<EOF
  Usage: $SCRIPT_NAME --distro DISTRO [OPTIONS]

  DESCRIPTION:
    Create a VM using virt-install and cloud-init for various Linux distributions.

  REQUIRED:
      --distro DISTRO     Distribution to install (alpine|debian|ubuntu|fedora|arch|tw|centos)

  RECOMMENDED:
      --ssh-port PORT     SSH port (default: random)
      --name NAME         VM name (default: distribution name)
      --username USER     VM username (default: distribution-specific)

  OPTIONS:
      --vcpus NUM         Number of vCPUs (default: 4)
      --memory MB         MEMORY in MB (default: 8192)
      --disk-size SIZE    Disk size (default: 20G)

      --ssh-key PATH      SSH public key path (default: auto-detect)
      --password PASS     User password (default: random)
      --ask-password      Prompt for password

      --console           Attach console to VM
      --spice             Attach spice to VM
      --help, -h          Show this help

  EXAMPLES:
      $SCRIPT_NAME --distro alpine
      $SCRIPT_NAME --distro debian --name my-debian --username admin --password mypass
      $SCRIPT_NAME --distro ubuntu --vcpus 4 --memory 4096 --disk-size 40G
      $SCRIPT_NAME --distro fedora --ssh-key ~/.ssh/my_key.pub
      $SCRIPT_NAME --distro arch --console --spice
      $SCRIPT_NAME --distro centos --name my-centos --username admin
      $SCRIPT_NAME --distro tw --ask-password
EOF
}

CPUS=4
MEMORY=8192
DISK_SIZE=20G
CONSOLE=false
SPICE=false
ASK_PASSWORD=false

cleanup() {
  frm "$DISK_IMG"
}

trap 'cleanup' ERR INT TERM

parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    --ask-password)
      ASK_PASSWORD=true
      shift
      ;;
    --distro)
      DISTRO="$2"
      shift 2
      ;;
    --name)
      VM_NAME="$2"
      shift 2
      ;;
    --vcpus)
      CPUS="$2"
      shift 2
      ;;
    --memory)
      MEMORY="$2"
      shift 2
      ;;
    --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    --ssh-key)
      SSH_KEY="$2"
      shift 2
      ;;
    --username)
      USERNAME="$2"
      shift 2
      ;;
    --password)
      PASSWORD="$2"
      shift 2
      ;;
    --ssh-port)
      SSH_PORT="$2"
      shift 2
      ;;
    --console)
      CONSOLE=true
      shift
      ;;
    --spice)
      SPICE=true
      shift
      ;;
    --help | -h)
      usage
      exit 0
      ;;
    *)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    esac
  done

  if [[ -z "${DISTRO:-}" ]]; then
    fail "Distro is required"
    usage
    exit 1
  fi

  if [[ -z "${SSH_PORT:-}" ]]; then
    SSH_PORT=$(find_free_port_random)
    warn "SSH port not provided, using random: $SSH_PORT"
    sleep 1
  fi

  VM_NAME=${VM_NAME:-$DISTRO-vmu}

  USERNAME="${USERNAME:-$USER}"

  if [[ "$ASK_PASSWORD" == true ]]; then
    read -r -s -p "Enter password for $USERNAME: " PASSWORD
    echo
  fi

  PASSWORD="${PASSWORD:-$(generate_password_for "$VM_NAME")}"

  BASE_DIR="${BASE_DIR:=$HOME/.vmus}"
  WORKDIR="$BASE_DIR/vmus/${VM_NAME}"
  BASE_IMG_DIR="$BASE_DIR/images/${DISTRO}"
  DISK_IMG="${WORKDIR}/${VM_NAME}.qcow2"
}

show_configuration() {
  echo
  printf '\033[1;36mâš™ï¸  CONFIGURATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s\033[0m\n' "$DISTRO"
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB MEMORY, %s disk\033[0m\n' "$CPUS" "$MEMORY" "$DISK_SIZE"
  printf '\033[1mSSH Port:\033[0m      \033[0;33m%s\033[0m\n' "$SSH_PORT"
  echo
  # printf "\033[1;36mPress enter to continue...\033[0m\n"
  # read -r
}

create_dirs() {
  frm "$WORKDIR"
  info "Creating directories: $BASE_IMG_DIR, $WORKDIR"
  mkdir -p "$BASE_IMG_DIR" "$WORKDIR"
}

check_prerequisites() {
  local missing=()
  for cmd in qemu-img virt-install virsh jq openssl wget trash ssh-keygen wget sha256sum; do
    has_cmd "$cmd" || missing+=("$cmd")
  done

  if ((${#missing[@]})); then
    echo -e "\n\033[1;31mâŒ Missing required commands\033[0m\n"
    echo -e "\033[1;34mðŸ“¦ Missing:\033[0m ${missing[*]}"
    echo -e "\033[1;34mðŸ’¡ Install them before running this script.\033[0m\n"
    exit 1
  fi

  if virsh --connect qemu:///session list --all --name 2>/dev/null | grep -q "^$VM_NAME$"; then
    die "VM '$VM_NAME' already exists"
  fi

  if ! [[ -f "$HOME/.ssh/id_ed25519.pub" ]]; then
    # mkdir -p ~/.ssh
    # chmod 700 "$HOME/.ssh"
    ssh-keygen -t ed25519 -f "${HOME}/.ssh/id_ed25519" -N "" -q
  fi
  SSH_KEY=$(<"$HOME/.ssh/id_ed25519.pub")
}

configure_distro() {
  case "$DISTRO" in
  alpine)
    IMG_URL="https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/generic_alpine-3.22.2-x86_64-uefi-cloudinit-r0.qcow2"
    BASE_IMG="${BASE_IMG_DIR}/generic_alpine-3.22.2-x86_64-bios-tiny-r0.qcow2"
    OS_VARIANT="alpinelinux3.21"
    CHECKSUM_URL="https://dl-cdn.alpinelinux.org/alpine/v3.22/releases/cloud/generic_alpine-3.22.2-x86_64-uefi-cloudinit-r0.qcow2.sha512"
    ;;
  debian)
    IMG_URL="https://cloud.debian.org/images/cloud/trixie/latest/debian-13-generic-amd64.qcow2"
    BASE_IMG="${BASE_IMG_DIR}/debian-13-generic-amd64.qcow2"
    OS_VARIANT="debian13"
    CHECKSUM_URL="https://cloud.debian.org/images/cloud/trixie/latest/SHA512SUMS"
    ;;
  ubuntu)
    IMG_URL="https://cloud-images.ubuntu.com/questing/current/questing-server-cloudimg-amd64.img"
    BASE_IMG="${BASE_IMG_DIR}/questing-server-cloudimg-amd64.img"
    OS_VARIANT="ubuntu25.10"
    CHECKSUM_URL="https://cloud-images.ubuntu.com/questing/current/SHA256SUMS"
    ;;
  fedora)
    IMG_URL="https://download.fedoraproject.org/pub/fedora/linux/releases/43/Cloud/x86_64/images/Fedora-Cloud-Base-Generic-43-1.6.x86_64.qcow2"
    BASE_IMG="${BASE_IMG_DIR}/Fedora-Cloud-Base-Generic-43-1.6.x86_64.qcow2"
    OS_VARIANT="fedora42"
    CHECKSUM_URL="https://mirror.hoster.kz/fedora/fedora/linux/releases/43/Cloud/x86_64/images/Fedora-Cloud-43-1.6-x86_64-CHECKSUM"
    ;;
  arch)
    IMG_URL="https://geo.mirror.pkgbuild.com/images/latest/Arch-Linux-x86_64-cloudimg.qcow2"
    BASE_IMG="${BASE_IMG_DIR}/Arch-Linux-x86_64-cloudimg.qcow2"
    OS_VARIANT="archlinux"
    CHECKSUM_URL="https://geo.mirror.pkgbuild.com/images/latest/Arch-Linux-x86_64-cloudimg.qcow2.SHA256"
    ;;
  tw)
    IMG_URL="https://download.opensuse.org/tumbleweed/appliances/openSUSE-Tumbleweed-Minimal-VM.x86_64-Cloud.qcow2"
    BASE_IMG="${BASE_IMG_DIR}/openSUSE-Tumbleweed-Minimal-VM.x86_64-Cloud.qcow2"
    OS_VARIANT="opensusetumbleweed"
    CHECKSUM_URL="https://download.opensuse.org/tumbleweed/appliances/openSUSE-Tumbleweed-Minimal-VM.x86_64-Cloud.qcow2.sha256"
    ;;
  centos)
    IMG_URL="https://cloud.centos.org/centos/9-stream/x86_64/images/CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2"
    BASE_IMG="${BASE_IMG_DIR}/CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2"
    OS_VARIANT="centos-stream9"
    CHECKSUM_URL="https://cloud.centos.org/centos/9-stream/x86_64/images/CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2.SHA256SUM"
    ;;
  *)
    fail "Unsupported distro: $DISTRO"
    usage
    ;;
  esac

  CHECKSUM_FILE="${BASE_IMG}.checksum"

  show_configuration
}

verify_checksum() {
  local img="$1"
  local sumfile="$2"
  local base_img
  base_img="$(basename "$img")"

  info "Verifying checksum for: $base_img"

  # Remove PGP signature from the checksum file
  grep -vE '^(-----BEGIN|-----END)' "$sumfile" >"${sumfile}.clean"
  mv "${sumfile}.clean" "$sumfile"

  local hash=""

  # 1. Fedora/Centos style: SHA256 (filename) = hash
  if grep -q "SHA256 (${base_img}) =" "$sumfile"; then
    hash="$(grep "SHA256 (${base_img}) =" "$sumfile" | awk -F'= ' '{print $2}')"
  # 2. GNU-style(ubuntu): <hash> [*]filename
  elif
    hash="$(grep -E "[[:space:]]\*?${base_img}$" "$sumfile" | awk '{print $1}' 2>/dev/null)"
    [[ -n "$hash" ]]
  then
    :
  # 3. Raw Alpine-style: single-line hash only
  elif [[ $(wc -l <"$sumfile") -eq 1 && $(wc -w <"$sumfile") -eq 1 ]]; then
    hash="$(cat "$sumfile")"
  # 4. No supported format matched
  else
    fail "Unsupported checksum format for $base_img"
    sleep 2
    warn "Skipping checksum verification..."
  fi

  case "${#hash}" in
  64)
    echo "${hash}  ${img}" | sha256sum -c - || die "SHA256 checksum mismatch"
    ;;
  128)
    echo "${hash}  ${img}" | sha512sum -c - || die "SHA512 checksum mismatch"
    ;;
  *)
    die "Unknown checksum length ${#hash}"
    ;;
  esac

  info "Checksum OK"
}

download_image() {
  mkdir -p "$BASE_IMG_DIR"

  if [[ ! -f "$BASE_IMG" ]]; then
    info "Downloading image: $IMG_URL"
    wget --continue --progress=bar:force -O "$BASE_IMG" "$IMG_URL" ||
      die "Image download failed"
  fi

  if [[ ! -f "$CHECKSUM_FILE" ]]; then
    info "Downloading checksum: $CHECKSUM_URL"
    wget --quiet -O "$CHECKSUM_FILE" "$CHECKSUM_URL" ||
      die "Checksum download failed"
  fi

  verify_checksum "$BASE_IMG" "$CHECKSUM_FILE"
}

create_disk() {
  info "Creating VM disk..."
  local ext
  ext=$(qemu-img info --output=json "$BASE_IMG" | jq -r '.format')
  qemu-img create -f qcow2 -F "$ext" -b "$BASE_IMG" "$DISK_IMG" "${DISK_SIZE}"
}

generate_cloud_init() {
  local PASSWORD_HASH cloud_init_dir
  PASSWORD_HASH=$(openssl passwd -6 "$PASSWORD")

  cloud_init_dir=$(mktemp -d)

  USER_DATA="${cloud_init_dir}/user-data"
  META_DATA="${cloud_init_dir}/meta-data"

  local -a packages=(
    "qemu-guest-agent"
    "bash"
    "curl"
  )

  local sudo_group="wheel"
  if [[ "$DISTRO" == "ubuntu" || "$DISTRO" == "debian" ]]; then
    sudo_group="sudo"
  fi

  local runcmd_lines=(
    "systemctl enable --now qemu-guest-agent || true"
  )

  if [[ "$DISTRO" == "alpine" ]]; then
    packages+=("openssh")
    runcmd_lines+=(
      "rc-update add qemu-guest-agent default"
      "service qemu-guest-agent start"
    )
  fi

  cat >"$USER_DATA" <<EOF
#cloud-config
hostname: $VM_NAME
manage_etc_hosts: true

users:
  - name: $USERNAME
    groups:
      - $sudo_group
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: $PASSWORD_HASH
    ssh_authorized_keys:
      - $SSH_KEY

package_update: true

packages:
$(for p in "${packages[@]}"; do printf "  - %s\n" "$p"; done)

runcmd:
$(printf "  - %s\n" "${runcmd_lines[@]}")
EOF

  cat >"$META_DATA" <<EOF
instance-id: $VM_NAME-$(date +%s)
local-hostname: $VM_NAME
EOF
}

create_vm() {
  info "Creating VM..."

  local -a virt_install_args
  virt_install_args=(
    --connect qemu:///session
    --name "$VM_NAME"
    --memory "$MEMORY"
    --vcpus "$CPUS"
    --os-variant "$OS_VARIANT"
    --disk "path=$DISK_IMG,format=qcow2,bus=virtio"
    --network "passt,model=virtio,portForward=${SSH_PORT}:22"
    --cloud-init "user-data=$USER_DATA,meta-data=$META_DATA"
    --virt-type kvm
    --import
  )

  if [[ "$CONSOLE" == true ]]; then
    virt_install_args+=("--console=pty,target_type=serial")
  else
    virt_install_args+=("--noautoconsole")
  fi

  if [[ "$SPICE" == true ]]; then
    virt_install_args+=("--graphics spice,gl=on,listen=none")
  fi

  echo "virt-install ${virt_install_args[*]}"
  echo

  echo "Command: virt-install ${virt_install_args[*]}"

  virt-install "${virt_install_args[@]}"
}

show_completion_info() {
  echo -e "\n\033[1;32mâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\033[0m\n"
  printf '\033[1;32mâ”‚\033[1;37m                       VM CREATED SUCCESSFULLY!             \033[1;32mâ”‚\033[0m\n'
  echo -e "\033[1;32mâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\033[0m\n"

  printf '\033[1;36mðŸ“‹ VM INFORMATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s\033[0m\n' "$DISTRO"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB MEMORY, %s disk\033[0m\n' "$CPUS" "$MEMORY" "$DISK_SIZE"
  echo

  printf '\033[1;36mðŸŒ NETWORK ACCESS:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mSSH Port Forward:\033[0m \033[0;33mlocalhost:%s â†’ VM:22\033[0m\n' "$SSH_PORT"
  printf '\033[1mSSH Command:\033[0m    \033[0;33mssh -p %s %s@localhost\033[0m\n' "$SSH_PORT" "$USERNAME"
  echo

  printf '\033[1;36mðŸ”§ VM MANAGEMENT:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mStart:\033[0m     \033[0;33mvmu start %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStop:\033[0m      \033[0;33mvmu shutdown %s\033[0m\n' "$VM_NAME"
  printf '\033[1mDelete:\033[0m    \033[0;33mvmu delete %s\033[0m\n' "$VM_NAME"
  printf '\033[1mConsole:\033[0m   \033[0;33mvmu console %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStatus:\033[0m    \033[0;33mvmu status %s\033[0m\n' "$VM_NAME"
  printf '\033[1mList VMs:\033[0m   \033[0;33mvmu list\033[0m\n'
  echo

  printf '\033[1;36mðŸ”§ TROUBLESHOOTING:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mConsole Access:\033[0m \033[0;33mvmu console %s\033[0m\n' "$VM_NAME"
  printf '\033[1;90m(Exit console with Ctrl+]\033[0m\n'
  echo

  printf '\033[1;32mâœ… VM "%s" is ready to use!\033[0m\n' "$VM_NAME"
  echo
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 1
  fi

  parse_args "$@"
  check_prerequisites
  configure_distro

  create_dirs
  download_image
  create_disk
  generate_cloud_init

  if create_vm; then
    register_vm_port "$VM_NAME" "$SSH_PORT" "$USERNAME"
    show_completion_info
  fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
