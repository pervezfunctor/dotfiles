#!/usr/bin/env bash

set -euo pipefail

DOT_DIR=${DOT_DIR:-$HOME/.ilm}

# shellcheck disable=SC1091
source "$(dirname "$0")/vmu-utils"

unset DISTRO
unset VM_NAME
unset USERNAME
unset PASSWORD
unset DISK_IMG

SCRIPT_NAME="$(basename "$0")"

usage() {
  cat <<EOF
  Usage: $SCRIPT_NAME --distro DISTRO [OPTIONS]

  DESCRIPTION:
    Create a VM using virt-install and cloud-init for various Linux distributions.

  REQUIRED:
      --distro DISTRO     Distribution to install (alpine|debian|ubuntu|fedora|arch|tw|centos)

  RECOMMENDED:
      --ssh-port PORT     SSH port (default: random)
      --name NAME         VM name (default: distribution name)
      --username USER     VM username (default: distribution-specific)

  OPTIONS:
      --vcpus NUM         Number of vCPUs (default: 4)
      --memory MB         MEMORY in MB (default: 8192)
      --disk-size SIZE    Disk size (default: 20G)

      --ssh-key PATH      SSH public key path (default: auto-detect)
      --password PASS     User password (default: random)
      --ask-password      Prompt for password

      --console           Attach console to VM
      --spice             Attach spice to VM
      --help, -h          Show this help

  EXAMPLES:
      $SCRIPT_NAME --distro alpine
      $SCRIPT_NAME --distro debian --name my-debian --username admin --password mypass
      $SCRIPT_NAME --distro ubuntu --vcpus 4 --memory 4096 --disk-size 40G
      $SCRIPT_NAME --distro fedora --ssh-key ~/.ssh/my_key.pub
      $SCRIPT_NAME --distro arch --console --spice
      $SCRIPT_NAME --distro centos --name my-centos --username admin
      $SCRIPT_NAME --distro tw --ask-password
EOF
}

CPUS=4
MEMORY=8192
DISK_SIZE=20G
CONSOLE=false
SPICE=false
ASK_PASSWORD=false

cleanup() {
  frm "$DISK_IMG"
}

trap 'cleanup' ERR INT TERM

setup_storage() {
  BASE_DIR="${BASE_DIR:=$HOME/.vmus}"
  WORKDIR="$BASE_DIR/vmus/${VM_NAME}"
  BASE_IMG_DIR="$BASE_DIR/images/${DISTRO}"
  DISK_IMG="${WORKDIR}/${VM_NAME}.qcow2"

  # frm "$WORKDIR"
  info "Creating directories: $BASE_IMG_DIR, $WORKDIR"
  mkdir -p "$BASE_IMG_DIR" "$WORKDIR"
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    --ask-password)
      ASK_PASSWORD=true
      shift
      ;;
    --distro)
      DISTRO="$2"
      shift 2
      ;;
    --name)
      VM_NAME="$2"
      shift 2
      ;;
    --vcpus)
      CPUS="$2"
      shift 2
      ;;
    --memory)
      MEMORY="$2"
      shift 2
      ;;
    --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    --ssh-key)
      SSH_KEY_PATH="$2"
      shift 2
      ;;
    --username)
      USERNAME="$2"
      shift 2
      ;;
    --password)
      PASSWORD="$2"
      shift 2
      ;;
    --ssh-port)
      SSH_PORT="$2"
      shift 2
      ;;
    --console)
      CONSOLE=true
      shift
      ;;
    --spice)
      SPICE=true
      shift
      ;;
    --help | -h)
      usage
      exit 0
      ;;
    *)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    esac
  done

  if [[ -z "${DISTRO:-}" ]]; then
    fail "Distro is required"
    usage
    exit 1
  fi

  if [[ -z "${SSH_PORT:-}" ]]; then
    SSH_PORT=$(find_free_port_random)
    warn "SSH port not provided, using random: $SSH_PORT"
    sleep 1
  fi

  VM_NAME=${VM_NAME:-$DISTRO-vmu}

  USERNAME="${USERNAME:-$USER}"

  if [[ "$ASK_PASSWORD" == true ]]; then
    read -r -s -p "Enter password for $USERNAME: " PASSWORD
    echo
  fi

  PASSWORD="${PASSWORD:-$(generate_password_for "$VM_NAME")}"

  SSH_KEY_PATH=$(ssh_key_path)
}

show_configuration() {
  echo
  printf '\033[1;36mâš™ï¸  CONFIGURATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s\033[0m\n' "$DISTRO"
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB MEMORY, %s disk\033[0m\n' "$CPUS" "$MEMORY" "$DISK_SIZE"
  printf '\033[1mSSH Port:\033[0m      \033[0;33m%s\033[0m\n' "$SSH_PORT"
  echo
  press_enter
}

check_prerequisites() {
  check_cmds qemu-img virt-install virsh jq openssl wget trash ssh-keygen wget sha256sum vme
}

download_image() {
  mkdir -p "$BASE_IMG_DIR"

  if [[ ! -f "$BASE_IMAGE" ]]; then
    info "Downloading image: $IMG_URL"
    wget --continue --progress=bar:force -O "$BASE_IMAGE" "$IMG_URL" ||
      die "Image download failed"
  fi

  if [[ ! -f "$CHECKSUM_FILE" ]]; then
    info "Downloading checksum: $CHECKSUM_URL"
    wget --quiet -O "$CHECKSUM_FILE" "$CHECKSUM_URL" ||
      die "Checksum download failed"
  fi

  verify_checksum "$BASE_IMAGE" "$CHECKSUM_FILE"
}

create_disk() {
  info "Creating VM disk..."
  local ext
  ext=$(qemu-img info --output=json "$BASE_IMAGE" | jq -r '.format')
  qemu-img create -f qcow2 -F "$ext" -b "$BASE_IMAGE" "$DISK_IMG" "${DISK_SIZE}"
}

create_vm() {
  info "Creating VM..."

  local -a virt_install_args
  virt_install_args=(
    --connect qemu:///session
    --name "$VM_NAME"
    --memory "$MEMORY"
    --vcpus "$CPUS"
    --os-variant "$OS_VARIANT"
    --disk "path=$DISK_IMG,format=qcow2,bus=virtio"
    --network "passt,model=virtio,portForward=${SSH_PORT}:22"
    --cloud-init "user-data=$USER_DATA,meta-data=$META_DATA"
    --virt-type kvm
    --import
  )

  if [[ "$CONSOLE" == true ]]; then
    virt_install_args+=("--console=pty,target_type=serial")
  else
    virt_install_args+=("--noautoconsole")
  fi

  if [[ "$SPICE" == true ]]; then
    virt_install_args+=("--graphics spice,gl=on,listen=none")
  fi

  echo "virt-install ${virt_install_args[*]}"
  echo

  echo "Command: virt-install ${virt_install_args[*]}"

  virt-install "${virt_install_args[@]}"
}

show_completion_info() {
  echo -e "\n\033[1;32mâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\033[0m\n"
  printf '\033[1;32mâ”‚\033[1;37m                       VM CREATED SUCCESSFULLY!             \033[1;32mâ”‚\033[0m\n'
  echo -e "\033[1;32mâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\033[0m\n"

  printf '\033[1;36mðŸ“‹ VM INFORMATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s\033[0m\n' "$DISTRO"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB MEMORY, %s disk\033[0m\n' "$CPUS" "$MEMORY" "$DISK_SIZE"
  echo

  printf '\033[1;36mðŸŒ NETWORK ACCESS:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mSSH Port Forward:\033[0m \033[0;33mlocalhost:%s â†’ VM:22\033[0m\n' "$SSH_PORT"
  printf '\033[1mSSH Command:\033[0m    \033[0;33mssh -p %s %s@localhost\033[0m\n' "$SSH_PORT" "$USERNAME"
  echo

  printf '\033[1;36mðŸ”§ VM MANAGEMENT:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mStart:\033[0m     \033[0;33mvmu start %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStop:\033[0m      \033[0;33mvmu shutdown %s\033[0m\n' "$VM_NAME"
  printf '\033[1mDelete:\033[0m    \033[0;33mvmu delete %s\033[0m\n' "$VM_NAME"
  printf '\033[1mConsole:\033[0m   \033[0;33mvmu console %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStatus:\033[0m    \033[0;33mvmu status %s\033[0m\n' "$VM_NAME"
  printf '\033[1mList VMs:\033[0m   \033[0;33mvmu list\033[0m\n'
  echo

  printf '\033[1;36mðŸ”§ TROUBLESHOOTING:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mConsole Access:\033[0m \033[0;33mvmu console %s\033[0m\n' "$VM_NAME"
  printf '\033[1;90m(Exit console with Ctrl+]\033[0m\n'
  echo

  printf '\033[1;32mâœ… VM "%s" is ready to use!\033[0m\n' "$VM_NAME"
  echo
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  parse_args "$@"
  check_prerequisites
  setup_storage
  configure_distribution
  show_configuration

  download_image
  create_disk
  generate_cloud_init

  if create_vm; then
    register_vm_port "$VM_NAME" "$SSH_PORT" "$USERNAME"
    show_completion_info
  fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
