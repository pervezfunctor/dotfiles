#!/usr/bin/env bash

# shellcheck disable=SC1091

set -e

DOT_DIR=${DOT_DIR:-$HOME/.ilm}
source "$(dirname "$0")/incus-utils"

OUTDIR="$HOME/.ssh/conf.d"
mkdir -p "$OUTDIR"

# Remove autogenerated Incus entries
rm -f "$OUTDIR"/incus.conf

# Collect all container info first
containers=()
while IFS=$'\t' read -r name type os ip; do
  containers+=("$name|$type|$os|$ip")
done < <(incus list --format json | jq -r '
  .[]
  | select(.status=="Running")
  | .name as $n
  | (.type // "container") as $t
  | (.config | .["image.os"] // "unknown") as $os
  | (.state.network | to_entries[] | .value.addresses[]?
        | select(.family=="inet")
        | select(.address | startswith("127.") | not)
        | .address
    ) as $ip
  | [$n, $t, $os, $ip] | @tsv
')

# Process each container
for container in "${containers[@]}"; do
  IFS='|' read -r name type os ip <<< "$container"
  [[ -n "$ip" ]] || continue

  # Try to detect the actual user with UID 1000 in the container
  # Use timeout to avoid hanging on problematic containers
  user=$(timeout 5 incus exec "$name" -- getent passwd 2>/dev/null | grep -E '^[^:]*:[^:]*:1000:' | cut -d: -f1 || echo "")

  # Fallback to OS-based detection if we can't get the user
  if [[ -z "$user" ]]; then
    case "$os" in
    Ubuntu) user="ubuntu" ;;
    Debian) user="debian" ;;
    Fedora) user="fedora" ;;
    Archlinux) user="arch" ;;
    Opensuse) user="opensuse" ;;
    CentOS) user="centos" ;;
    *) user="root" ;;
    esac
  fi

  # Append to single file: ~/.ssh/conf.d/incus.conf
  cat >>"$OUTDIR/incus.conf" <<EOF
Host $name
    HostName $ip
    User $user
    # Instance type: $type
    # OS: $os

EOF
done
