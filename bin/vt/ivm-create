#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/incus-utils"

trap 'echo "‚ùå  Error on line $LINENO"; exit 1' ERR

unset VM_NAME
unset DISTRO
unset RELEASE
unset USERNAME
unset PASSWORD
unset SSH_KEY_PATH
unset IMAGE_URL

VCPUS="3"
MEMORY_MB="4096"
DISK_SIZE="20GB"
BRIDGE_IF="incusbr0"

usage() {
  cat <<EOF
Usage: $0 --distro DISTRO [OPTIONS]

Create Incus virtual machines with cloud-init and SSH access.

REQUIRED:
    --distro DISTRO         Distribution (ubuntu, fedora, arch, debian, centos, tumbleweed, alpine)

OPTIONS:
    --name NAME             VM name (default: distro name)
    --release RELEASE       Distribution release (default: latest)
    --username USER         Username for VM (default: distro default)
    --password PASS         User password (default: vm name)
    --vcpus NUM             Number of vCPUs (default: 4)
    --memory MB             RAM in MB (default: 4096)
    --disk-size SIZE        Disk size (default: 20GB)
    --ssh-key PATH          SSH public key path (default: auto-detect)
    --bridge BRIDGE         Network bridge (default: incusbr0)
    --help, -h              Show this help

EXAMPLES:
    $0 --distro ubuntu
    $0 --distro fedora --name my-fedora --vcpus 4 --memory 4096
    $0 --distro debian --username admin --password mypass
    $0 --distro arch --release current --disk-size 40GB
    $0 --distro tumbleweed --name opensuse-vm --vcpus 2 --memory 4096

SUPPORTED DISTRIBUTIONS:
    ubuntu      - Ubuntu (plucky/25.04)
    fedora      - Fedora (latest)
    arch        - Arch Linux (current)
    debian      - Debian (13/trixie)
    centos      - CentOS Stream (9)
    tumbleweed  - openSUSE Tumbleweed (rolling release)
    alpine      - Alpine Linux (latest)
EOF
}

show_configuration() {
  echo
  printf '\033[1;36m‚öôÔ∏è  CONFIGURATION:\033[0m\n'
  printf '\033[0;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n'
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s %s\033[0m\n' "$DISTRO" "$RELEASE"
  printf '\033[1mVM Name:\033[0m        \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mUsername:\033[0m       \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m       \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m      \033[0;33m%s vCPUs, %sMB RAM, %s disk\033[0m\n' "$VCPUS" "$MEMORY_MB" "$DISK_SIZE"
  printf '\033[1mNetwork Bridge:\033[0m \033[0;33m%s\033[0m\n' "$BRIDGE_IF"
  echo
  press_enter
}

configure_distribution() {
  case "$DISTRO" in
  ubuntu)
    RELEASE=${RELEASE:-"plucky"}
    IMAGE_URL="images:ubuntu/${RELEASE}/cloud"
    ;;
  fedora)
    RELEASE=${RELEASE:-"43"}
    IMAGE_URL="images:fedora/${RELEASE}/cloud"
    ;;
  arch)
    RELEASE=${RELEASE:-"current"}
    IMAGE_URL="images:archlinux/${RELEASE}/cloud"
    ;;
  debian)
    RELEASE=${RELEASE:-"13"}
    IMAGE_URL="images:debian/${RELEASE}/cloud"
    ;;
  centos)
    RELEASE=${RELEASE:-"9-Stream"}
    IMAGE_URL="images:centos/${RELEASE}/cloud"
    ;;
  tumbleweed | tw)
    RELEASE=${RELEASE:-"current"}
    IMAGE_URL="images:opensuse/tumbleweed/cloud"
    ;;
  rocky)
    RELEASE=${RELEASE:-"9"}
    IMAGE_URL="images:rockylinux/${RELEASE}/cloud"
    ;;
  alpine)
    RELEASE=${RELEASE:-"3.22"}
    IMAGE_URL="images:alpine/${RELEASE}/cloud"
    ;;
  *)
    fail "Unsupported distribution: $DISTRO"
    fail "Supported distributions: ubuntu, fedora, arch, debian, centos, tumbleweed, rocky, alpine"
    exit 1
    ;;
  esac

  VM_NAME=${VM_NAME:-"${DISTRO}-ivm"}
  USERNAME=${USERNAME:=$USER}
  PASSWORD=${PASSWORD:-$(generate_password_for "$VM_NAME")}
  PASSWORD_HASH=$(openssl passwd -6 "$PASSWORD")

  show_configuration
}

generate_cloud_init_config() {
  slog "Generating cloud-init configuration..."

  CLOUD_INIT_DIR=$(mktemp -d)
  trap '[[ -n "$CLOUD_INIT_DIR" && -d "$CLOUD_INIT_DIR" ]] && rm -rf "$CLOUD_INIT_DIR"' EXIT

  local pub_key
  pub_key=$(cat "$SSH_KEY_PATH")

  local openssh_pkg
  if [[ "$DISTRO" == "arch" ]]; then
    openssh_pkg="openssh"
  else
    openssh_pkg="openssh-server"
  fi

  local -a packages=(
    "qemu-guest-agent"
    "bash"
    "curl"
    "$openssh_pkg"
  )

  local runcmd_lines=(
    "systemctl enable --now ssh || systemctl enable --now sshd || true"
  )

  if [[ "$DISTRO" == "alpine" ]]; then
    runcmd_lines=(
      "rc-update add sshd default"
      "service sshd start"
    )
  fi

  local sudo_groups="wheel"

  if [[ "$DISTRO" == "ubuntu" || "$DISTRO" == "debian" ]]; then
    sudo_groups="sudo"
  fi

  cat >"${CLOUD_INIT_DIR}/user-data" <<EOF
#cloud-config
hostname: $VM_NAME
manage_etc_hosts: true

users:
  - name: $USERNAME
    groups:
      - $sudo_groups
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: $PASSWORD_HASH
    ssh_authorized_keys:
      - $pub_key

package_update: true
package_upgrade: true

packages:
$(for pkg in "${packages[@]}"; do echo "  - $pkg"; done)

runcmd:
$(printf "  - %s\n" "${runcmd_lines[@]}")
EOF

  cat >"${CLOUD_INIT_DIR}/meta-data" <<EOF
instance-id: ${VM_NAME}-$(date +%s)
local-hostname: $VM_NAME
EOF

  if validate_cloud_init_yaml "${CLOUD_INIT_DIR}/user-data"; then
    success "Cloud-init configuration files created in: $CLOUD_INIT_DIR"
  else
    fail "Cloud-init configuration files might be invalid"
  fi
}

create_vm() {
  slog "Creating Incus VM '$VM_NAME'..."

  if incus_instance_exists "$VM_NAME"; then
    fail "instance '$VM_NAME' already exists"
    exit 1
  fi

  generate_cloud_init_config

  slog "Launching VM with image: $IMAGE_URL"

  local launch_cmd=(
    --config "limits.cpu=$VCPUS"
    --config "limits.memory=${MEMORY_MB}MB"
    --config "user.user-data=$(cat "${CLOUD_INIT_DIR}/user-data")"
    --config "user.meta-data=$(cat "${CLOUD_INIT_DIR}/meta-data")"
    --device "root,size=$DISK_SIZE"
    --config "security.secureboot=false"
    --network "$BRIDGE_IF"
  )

  if ! incus launch "$IMAGE_URL" "$VM_NAME" --vm "${launch_cmd[@]}"; then
    fail "Failed to create VM '$VM_NAME'"
    exit 1
  fi

  success "VM '$VM_NAME' created successfully"

  if [[ -n "$CLOUD_INIT_DIR" && -d "$CLOUD_INIT_DIR" ]]; then
    rm -rf "$CLOUD_INIT_DIR"
    slog "Cleaned up temporary cloud-init files"
  fi
}

add_ssh_config() {
  has_cmd ssh-config || return 0

  local ip
  ip=$(ivm_ip "$VM_NAME")

  slog "Adding SSH configuration for $VM_NAME..."
  if ssh-config add --host "$VM_NAME" --ip "$ip" --user "$USERNAME" --identity "${SSH_KEY_PATH%.pub}"; then
    printf '\033[1mSSH Config:\033[0m    \033[0;32mAdded to ~/.ssh/conf.d/%s.conf\033[0m\n' "$VM_NAME"
    printf '\033[1mSSH Shortcut:\033[0m  \033[0;33mssh %s\033[0m\n' "$VM_NAME"
  else
    warn "Failed to add SSH configuration"
  fi
}

show_completion_info() {
  slog "Waiting for VM to be ready. This could take a few minutes..."
  if ! wait_for_ip "ivm" "$VM_NAME"; then
    fail "Failed to get VM IP. Wait a few moments and try ivm ip $VM_NAME."
  fi

  echo
  printf '\033[1;32m‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ\033[0m\n'
  printf '\033[1;32m‚îÇ\033[1;37m                       VM CREATED SUCCESSFULLY!             \033[1;32m‚îÇ\033[0m\n'
  printf '\033[1;32m‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ\033[0m\n'
  echo

  printf '\033[1;36müìã VM INFORMATION:\033[0m\n'
  printf '\033[0;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n'
  printf '\033[1mVM Name:\033[0m       \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mDistribution:\033[0m  \033[0;33m%s %s\033[0m\n' "$DISTRO" "$RELEASE"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB RAM, %s disk\033[0m\n' "$VCPUS" "$MEMORY_MB" "$DISK_SIZE"
  printf '\033[1mType:\033[0m          \033[0;33mVirtual Machine (full virtualization)\033[0m\n'
  echo

  printf '\033[1;36müåê NETWORK ACCESS:\033[0m\n'
  printf '\033[0;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n'

  local ip
  if ip=$(ivm_ip "$VM_NAME" 2>/dev/null); then
    printf '\033[1mIP Address:\033[0m   \033[0;33m%s\033[0m\n' "$ip"
    printf '\033[1mSSH Command:\033[0m  \033[0;33mssh %s@%s\033[0m\n' "$USERNAME" "$ip"
  else
    printf '\033[1mGet IP Address:\033[0m \033[0;33mivm ip %s\033[0m\n' "$VM_NAME"
  fi
  echo

  printf '\033[1;36müîß VM MANAGEMENT:\033[0m\n'
  printf '\033[0;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n'
  printf '\033[1mStop:\033[0m     \033[0;33mivm stop %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStart:\033[0m    \033[0;33mivm start %s\033[0m\n' "$VM_NAME"
  printf '\033[1mDelete:\033[0m   \033[0;33mivm delete %s\033[0m\n' "$VM_NAME"
  printf '\033[1mShell:\033[0m    \033[0;33mincus exec %s -- /bin/bash\033[0m\n' "$VM_NAME"
  printf '\033[1mExecute:\033[0m  \033[0;33mincus exec %s -- <command>\033[0m\n' "$VM_NAME"
  printf '\033[1mStatus:\033[0m   \033[0;33mivm status %s\033[0m\n' "$VM_NAME"
  echo

  printf '\033[1;36müîß TROUBLESHOOTING:\033[0m\n'
  printf '\033[0;36m‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\033[0m\n'
  printf '\033[1mConsole:\033[0m   \033[0;33mivm console %s\033[0m\n' "$VM_NAME"
  printf '\033[1mInfo:\033[0m      \033[0;33mivm info %s\033[0m\n' "$VM_NAME"
  printf '\033[1;90m(Exit console with Ctrl+A then Q)\033[0m\n'
  echo

  success "VM '$VM_NAME' is ready to use!"
  echo
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    --distro)
      DISTRO="$2"
      shift 2
      ;;
    --name)
      VM_NAME="$2"
      shift 2
      ;;
    --release)
      RELEASE="$2"
      shift 2
      ;;
    --username)
      USERNAME="$2"
      shift 2
      ;;
    --password)
      PASSWORD="$2"
      shift 2
      ;;
    --vcpus)
      VCPUS="$2"
      shift 2
      ;;
    --memory)
      MEMORY_MB="$2"
      shift 2
      ;;
    --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    --ssh-key)
      SSH_KEY_PATH="$2"
      shift 2
      ;;
    --bridge)
      BRIDGE_IF="$2"
      shift 2
      ;;
    --help | -h)
      usage
      exit 0
      ;;
    *)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    esac
  done

  if [[ -z "${DISTRO:-}" ]]; then
    fail "Distribution is required. Use --distro option."
    usage
    exit 1
  fi
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 0
  fi

  slog "Starting Incus VM creation..."
  ivm_check_prerequisites
  parse_args "$@"

  if [[ -z "${SSH_KEY_PATH:-}" ]]; then
    SSH_KEY_PATH=$(ssh_key_path)
  fi

  file_exists "$SSH_KEY_PATH" || die "SSH public key not found at: $SSH_KEY_PATH"

  configure_distribution
  if create_vm; then
    show_completion_info
    # add_ssh_config
  fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
