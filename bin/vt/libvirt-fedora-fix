#!/bin/bash

# fix libvirt NAT (virbr0) masquerading on Fedora using Firewalld Direct Rules

set -e

# Ensure firewalld is active
echo "Ensuring firewalld is running..."
sudo systemctl enable --now firewalld

# Enable IP forwarding persistently
echo "Enabling IP forwarding..."
echo 'net.ipv4.ip_forward=1' | sudo tee /etc/sysctl.d/99-ipforward.conf
sudo sysctl --system

# Add NAT masquerade rule as a firewalld direct rule (persistent)
echo "Adding Firewalld Direct Rule for libvirt NAT masquerade..."
sudo firewall-cmd --permanent --direct --add-rule ipv4 nat POSTROUTING 0 -s 192.168.124.0/24 -o enp1s0 -j MASQUERADE

# Ensure virbr0 is in trusted zone (so firewalld doesn't block it)
echo "Assigning virbr0 to trusted zone..."
sudo firewall-cmd --permanent --zone=trusted --add-interface=virbr0

# Reload firewalld to apply changes
echo "Reloading firewalld..."
sudo firewall-cmd --reload

# Display applied direct rules for confirmation
echo "Applied Direct Rules:"
sudo firewall-cmd --direct --get-all-rules

# Ensure IP forwarding is ON
echo "Enabling IP forwarding..."
sudo sysctl -w net.ipv4.ip_forward=1

echo "Libvirt NAT fix applied permanently via Firewalld Direct Rules!"

cat <<EOF
# if above does not work you might need
sudo sed -i '/^#*firewall_backend=/c\firewall_backend="iptables"' /etc/libvirt/libvirtd.conf
sudo systemctl restart libvirtd
EOF
