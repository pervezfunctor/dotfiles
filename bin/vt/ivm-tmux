#!/usr/bin/env bash

# shellcheck disable=SC1091

# Support all virtual machines created by ivm-all

set -euo pipefail -o errtrace

source "$(dirname "$0")/incus-utils"
source "$(dirname "$0")/tmux-utils"

SESSION_NAME="IVM"

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTION]

Manage a tmux session with SSH connections to Incus VMs.

Options:
  create    Create a new tmux session with SSH connections to VMs (default if no option)
  attach    Attach to an existing session
  detach    Detach from the current session
  destroy   Kill the tmux session
  help      Display this help message

Examples:
  $(basename "$0")           # Create session or attach if exists
  $(basename "$0") create    # Force create a new session
  $(basename "$0") attach    # Attach to existing session
  $(basename "$0") detach    # Detach from current session
  $(basename "$0") destroy   # Kill the session
EOF
}

create_command_ivm() {
  local vm_name="$1"
  local username="$USER"
  echo "ivm ssh ${vm_name} ${username}"
}

create_session() {
  local force="$1"
  shift

  local -a vms=("$@")

  if [[ ${#vms[@]} -eq 0 ]]; then
    vms=("${DISTRO_LIST_ivm[@]}")
  fi

  tmux_session "$SESSION_NAME" "$force"

  slog "Creating tmux session '$SESSION_NAME' with SSH connections to ${#vms[@]} Incus VM(s)..."

  local -a vm_names=()
  generate_names vm_names "ivm" "${vms[@]}"

  local ssh_cmds=()
  create_commands_generic ssh_cmds "ivm" "${vm_names[@]}"

  start_sessions "ivm" "${vm_names[@]}"

  if ! tmux_grid "$SESSION_NAME" "${ssh_cmds[@]}"; then
    fail "Failed to create tmux session '$SESSION_NAME' with SSH connections to VMs."
    return 1
  fi

  if ! tmux attach-session -t "$SESSION_NAME"; then
    fail "Failed to attach to tmux session '$SESSION_NAME'."
    return 1
  fi
}

main() {
  ivm_check_exists_prerequisites
  check_tmux

  local command="${1:-}"

  case "$command" in
  create | "" | -c | --create)
    create_session "true"
    ;;
  attach | -a | --attach)
    attach_session "$SESSION_NAME"
    ;;
  detach | -d | --detach)
    detach_session "$SESSION_NAME"
    ;;
  destroy | -x | --destroy)
    destroy_session "$SESSION_NAME"
    ;;
  help | --help | -h)
    usage
    ;;
  *)
    fail "Unknown option: $command"
    usage
    exit 1
    ;;
  esac
}

main "$@"
