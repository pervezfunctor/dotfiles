#!/bin/bash

set -euo pipefail

# shellcheck disable=SC1091
source "$(dirname "$0")/ict-utils"

create_all() {
    slog "Creating Incus LXC containers (Debian, Ubuntu, Fedora, Arch, Tumbleweed)..."

    if ct_exists "debian-ct"; then
        slog "Instance 'debian-ct' already exists, skipping..."
    else
        slog "Creating Debian container: debian-ct"
        ict-create --distro debian --name debian-ct || return 1
    fi

    if ct_exists "ubuntu-ct"; then
        slog "Instance 'ubuntu-ct' already exists, skipping..."
    else
        slog "Creating Ubuntu container: ubuntu-ct"
        ict-create --distro ubuntu --name ubuntu-ct || return 1
    fi

    if ct_exists "fedora-ct"; then
        slog "Instance 'fedora-ct' already exists, skipping..."
    else
        slog "Creating Fedora container: fedora-ct"
        ict-create --distro fedora --name fedora-ct || return 1
    fi

    if ct_exists "arch-ct"; then
        slog "Instance 'arch-ct' already exists, skipping..."
    else
        slog "Creating Arch container: arch-ct"
        ict-create --distro arch --name arch-ct || return 1
    fi

    if ct_exists "debian-ct"; then
        slog "Instance 'debian-ct' already exists, skipping..."
    else
        slog "Creating Debian container: debian-ct"
        ict-create --distro debian --name debian-ct || return 1
    fi

    if ct_exists "tumbleweed-ct"; then
        slog "Instance 'tumbleweed-ct' already exists, skipping..."
    else
        slog "Creating Tumbleweed container: tumbleweed-ct"
        ict-create --distro tumbleweed --name tumbleweed-ct || return 1
    fi

    slog "Listing created containers:"
    incus list type=container

    success "All containers created successfully!"
    slog "You can access them using: ict ssh <container-name>"
}

delete_all() {
    slog "Deleting all containers..."
    for ct in debian-ct ubuntu-ct fedora-ct arch-ct tumbleweed-ct; do
        if ct_exists "$ct"; then
            slog "Deleting container: $ct"
            ict delete "$ct"
        fi
    done
    success "All containers deleted successfully!"
}

start_all() {
    slog "Starting all containers..."
    for ct in debian-ct ubuntu-ct fedora-ct arch-ct tumbleweed-ct; do
        if ct_exists "$ct"; then
            slog "Starting container: $ct"
            ict start "$ct"
        fi
    done
    success "All containers started successfully!"
}

stop_all() {
    slog "Stopping all containers..."
    for ct in debian-ct ubuntu-ct fedora-ct arch-ct tumbleweed-ct; do
        if ct_exists "$ct"; then
            slog "Stopping container: $ct"
            ict stop "$ct"
        fi
    done
    success "All containers stopped successfully!"
}

restart_all() {
    slog "Restarting all containers..."
    for ct in debian-ct ubuntu-ct fedora-ct arch-ct tumbleweed-ct; do
        if ct_exists "$ct"; then
            slog "Restarting container: $ct"
            ict restart "$ct"
            sleep 1
        fi
    done
    success "All containers restarted successfully!"
}

usage() {
    cat <<EOF
Usage: $(basename "$0") [OPTION]

Manage all Incus LXC containers created by ict-create.

Options:
  --delete  Delete all containers created by ict-create
  --start   Start all containers created by ict-create
  --stop    Stop all containers created by ict-create
  --restart Restart all containers created by ict-create
  --help    Display this help message
EOF
}

main() {
    check_incus

    if [[ $# -eq 0 ]]; then
        create_all
        exit 0
    fi

    if [[ "$1" == "--delete" ]]; then
        delete_all
    elif [[ "$1" == "--start" ]]; then
        start_all
    elif [[ "$1" == "--stop" ]]; then
        stop_all
    elif [[ "$1" == "--restart" ]]; then
        restart_all
    else
        fail "Unknown option: $1"
        usage
        exit 1
    fi
}

main "$@"
