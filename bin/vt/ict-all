#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail

source "$(dirname "$0")/incus-utils"
source "$(dirname "$0")/all-utils"

check_prerequisites() {
  incus_check
  has_cmd ict-create || die "ict-create is not in PATH."
  has_cmd ict || die "ict is not in PATH."
}

ICT_DISTRO_LIST=("debian" "ubuntu" "fedora" "arch" "tw")

all_create() {
  slog "Creating Incus LXC containers (Debian, Ubuntu, Fedora, Arch, Tumbleweed)..."

  for ct in "${ICT_DISTRO_LIST[@]}"; do
    if ! ict_exists "${ct}-ict"; then
      ict-create --distro "$ct" --name "${ct}-ict"
    fi
  done

  success "All containers created successfully!"
  slog "You can access them using: ict ssh <container-name>"
  slog "Or use ict-tmux to manage all containers at once."
}

all_op() {
  local op="$1"
  slog "Performing operation '$op' on all containers..."

  for ct in "${ICT_DISTRO_LIST[@]}"; do
    if ict_exists "${ct}-ict"; then
      ict "$op" "${ct}-ict"
    else
      warn "Container ${ct}-ict does not exist, skipping..."
    fi
  done

  success "Performed operation '$op' on all containers successfully!"
}

all_delete() {
  all_op "delete"
}

all_start() {
  all_op "start"
}

all_stop() {
  all_op "stop"
}

all_restart() {
  all_op "restart"
}

usage() {
  all_usage "incus" "LXC containers"
}

main() {
  check_prerequisites
  all_parse_args "$@"
}

main "$@"
