#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail

source "$(dirname "$0")/dt-utils"
source "$(dirname "$0")/all-utils"

DT_DISTRO_LIST=("ubuntu" "arch" "fedora" "tw" "nix" "centos" "alpine")

check_prerequisites() {
  has_cmd distrobox || die "distrobox is not installed. Please install it first with: $0 install."
  has_cmd dt || die "dt is not in PATH. It should be in the same directory as this script."
}

all_create() {
  slog "Creating Distrobox containers (Ubuntu, Arch, Fedora, Tumbleweed, NixOS, CentOS, Alpine)..."

  for d in "${DT_DISTRO_LIST[@]}"; do
    dt create "$d" "${d}-dt"
  done

  success "All containers created successfully!"
  slog "You can access them using: dt enter <container-name>"
}

all_op() {
  local op="$1"
  slog "Performing operation '$op' on all containers..."

  for ct in "${DT_DISTRO_LIST[@]}"; do
    if dt_exists "$ct-dt"; then
      dt "$op" "$ct-dt"
    else
      slog "Container $ct-dt does not exist, skipping..."
    fi
  done

  success "Performed operation '$op' on all containers successfully!"
}

all_delete() {
  all_op "delete"
}

all_start() {
  all_op "start"
}

all_stop() {
  all_op "stop"
}

all_restart() {
  all_op "restart"
}

usage() {
  all_usage "Distrobox" "containers"
}

main() {
  check_prerequisites
  all_parse_args "$@"
}

main "$@"
