#!/usr/bin/env bash

set -euo pipefail

# shellcheck disable=SC1091
source "$(dirname "$0")/vm-utils"

unset USERNAME
unset PASSWORD
unset DISTRO

VCPUS="4"
MEMORY="8192"
DISK_SIZE="30G"
BRIDGE="default"
OS_VARIANT="linux"
ASK_PASSWORD=false
INTERACTIVE=false

cleanup_on_error() {
  warn "Cleaning up due to error..."

  if [[ -d "$WORK_DIR" ]]; then
    sudo rm -rf "$WORK_DIR" 2>/dev/null
  fi
  stop_sudo_keep_alive
}

trap cleanup_on_error ERR
trap 'cleanup_on_error; exit 1' INT TERM

LIBVIRT_BASE_DIR="/var/lib/libvirt/images"
BASE_IMG_DIR="${LIBVIRT_BASE_DIR}/base-images"

libvirt_storage_setup() {
  sudo mkdir -p "$BASE_IMG_DIR"

  sudo chown -R "$USER":kvm "$BASE_IMG_DIR"
  sudo chmod -R 755 "$BASE_IMG_DIR"

  sudo mkdir -p /var/lib/libvirt/boot # bug in libvirt/virt-install?
}

setup_storage() {
  WORK_DIR="${LIBVIRT_BASE_DIR}/${VM_NAME}"

  sudo mkdir -p "$WORK_DIR"
  sudo chown -R "$USER":kvm "$WORK_DIR"
  sudo chmod -R 755 "$WORK_DIR"
}

show_configuration() {
  echo
  printf '\033[1;36mâš™ï¸  CONFIGURATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s %s\033[0m\n' "$DISTRO" "$RELEASE"
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB RAM, %s disk\033[0m\n' "$VCPUS" "$MEMORY" "$DISK_SIZE"
  if [[ -n "$BRIDGE" ]] && [[ "$BRIDGE" != "default" ]]; then
    printf '\033[1mNetwork Bridge:\033[0m \033[0;33m%s\033[0m\n' "$BRIDGE"
  fi
  echo
  press_enter
}

download_base_image() {
  if [ -f "${BASE_IMAGE}" ]; then
    info "Base image '${BASE_IMAGE}' already exists. Skipping download."
    return 0
  fi

  slog "Downloading base image from $IMG_URL..."
  if ! sudo wget -q --show-progress "$IMG_URL" -O "${BASE_IMAGE}"; then
    fail "Failed to download base image."
  else
    sudo chown root:kvm "${BASE_IMAGE}"
    sudo chmod 644 "${BASE_IMAGE}"
    success "Base image downloaded successfully."
  fi

  if [[ ! -f "$CHECKSUM_FILE" ]]; then
    info "Downloading checksum: $CHECKSUM_URL"
    sudo wget --quiet -O "$CHECKSUM_FILE" "$CHECKSUM_URL" ||
      die "Checksum download failed"
  fi

  verify_checksum "$BASE_IMAGE" "$CHECKSUM_FILE"
}

check_prerequisites() {
  if ! groups "$USER" | grep -q '\blibvirtd\?\b'; then
    fail "Error: User '$USER' is not in the 'libvirt' group." >&2
    fail "Please run: 'sudo usermod -aG libvirt \$USER' and then log out and back in." >&2
    exit 1
  fi

  if virsh dominfo "${VM_NAME}" &>/dev/null; then
    fail "Error: A VM named '${VM_NAME}' already exists." >&2
    fail "Please remove it with: virsh destroy ${VM_NAME} && virsh undefine ${VM_NAME}" >&2
    exit 1
  fi

  if [ -f "${VM_DISK}" ]; then
    fail "Error: A disk file at '${VM_DISK}' already exists." >&2
    fail "Please remove it with: sudo rm -f ${VM_DISK}" >&2
    exit 1
  fi
}

create_disk() {
  slog "Creating and resizing disk for ${VM_NAME} at ${VM_DISK}..."
  sudo qemu-img create -f qcow2 -b "${BASE_IMAGE}" -F qcow2 "${VM_DISK}" "${DISK_SIZE}"
  success "Disk created successfully."
}

create_vm() {
  slog "Creating VM '${VM_NAME}'..."

  if virt-install \
    --connect qemu:///system \
    --name "${VM_NAME}" \
    --memory "${MEMORY}" \
    --vcpus "${VCPUS}" \
    --os-variant "${OS_VARIANT}" \
    --disk path="${VM_DISK}",device=disk,bus=virtio,format=qcow2 \
    --network network="${BRIDGE}",model=virtio \
    --cloud-init user-data="${USER_DATA}",meta-data="${META_DATA}" \
    --import \
    --video=virtio \
    --graphics none \
    --console pty,target_type=serial \
    --noautoconsole; then
    success "VM creation process started for '${VM_NAME}'."
    return 0
  else
    return 1
  fi
}

show_completion_info() {
  slog "Waiting for VM to be ready. This could take a few minutes..."
  if ! wait_for_ip "vme" --ask "$VM_NAME"; then
    fail "VM did not get an IP in time. Try 'vme show-ip $VM_NAME' later."
    info "If you still can't connect, Use 'vme console $VM_NAME' to access it."
  fi

  echo
  printf '\033[1;32mâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\033[0m\n'
  printf '\033[1;32mâ”‚\033[1;37m                       VM CREATED SUCCESSFULLY!             \033[1;32mâ”‚\033[0m\n'
  printf '\033[1;32mâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\033[0m\n'
  echo

  printf '\033[1;36mðŸ“‹ VM INFORMATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB RAM, %s disk\033[0m\n' "$VCPUS" "$MEMORY" "$DISK_SIZE"
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s\033[0m\n' "$DISTRO"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  echo

  printf '\033[1;36mðŸŒ NETWORK ACCESS:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'

  local ip
  if ip=$(vm_ip "$VM_NAME" 2>/dev/null); then
    printf '\033[1mIP Address:\033[0m   \033[0;33m%s\033[0m\n' "$ip"
    printf '\033[1mSSH Command:\033[0m  \033[0;33mvme ssh %s\033[0m\n' "$VM_NAME"
    printf '\033[1mSSH Command:\033[0m  \033[0;33mssh %s@%s\033[0m\n' "$USERNAME" "$ip"
    echo
  else
    printf '\033[1mGet IP Address:\033[0m \033[0;33mvirsh domifaddr %s --source agent\033[0m\n' "$VM_NAME"
  fi
  echo

  printf '\033[1;36mðŸ”§ VM MANAGEMENT:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mStart:\033[0m      \033[0;33mvme start %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStop:\033[0m       \033[0;33mvme shutdown %s\033[0m\n' "$VM_NAME"
  printf '\033[1mDelete:\033[0m     \033[0;33mvme delete %s\033[0m\n' "$VM_NAME"
  printf '\033[1mAutostart:\033[0m  \033[0;33mvme autostart %s\033[0m\n' "$VM_NAME"
  echo

  printf '\033[1;36mðŸ”§ TROUBLESHOOTING:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mConsole:\033[0m   \033[0;33mvme console %s\033[0m\n' "$VM_NAME"
  printf '\033[0;90m(Exit console with Ctrl+])\033[0m\n'
  echo

  success "VM '${VM_NAME}' creation process completed successfully!"
  echo
}

usage() {
  cat <<EOF
Usage: $0 --distro DISTRO [OPTIONS]
   or: $0 --interactive

Create libvirt virtual machines with cloud-init and SSH access.

REQUIRED:
    --distro DISTRO         Distribution (arch, ubuntu, debian, fedora, tumbleweed, centos, rocky, alpine)
    --interactive           Run in interactive mode (prompts for all options)

OPTIONS:
    --name NAME             VM name (default: distro-vme)
    --release RELEASE       Distribution release (default: latest)
    --username USER         Username for VM (default: current user)
    --password PASS         User password (default: auto-generated)
    --ask-password          Prompt for password input
    --vcpus NUM             Number of vCPUs (default: 4)
    --memory MB             RAM in MB (default: 8192)
    --disk-size SIZE        Disk size (default: 30G)
    --bridge BRIDGE         Network bridge (default: default)
    --help, -h              Show this help

EXAMPLES:
    $0 --distro ubuntu
    $0 --distro fedora --name my-fedora --vcpus 4 --memory 4096
    $0 --distro debian --username admin --password mypass
    $0 --distro arch --release current --disk-size 40G
    $0 --distro tumbleweed --name opensuse-vm --vcpus 2 --memory 4096
    $0 --interactive

SUPPORTED DISTRIBUTIONS:
    arch        - Arch Linux (latest)
    ubuntu      - Ubuntu (plucky/25.10)
    debian      - Debian (13/trixie)
    fedora      - Fedora (43)
    tumbleweed  - openSUSE Tumbleweed (rolling release)
    centos      - CentOS Stream (9-Stream)
    rocky       - Rocky Linux (9)
    alpine      - Alpine Linux (3.22)
EOF
}

parse_args() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 1
  fi

  while [[ $# -gt 0 ]]; do
    case "$1" in
    --distro)
      DISTRO="$2"
      shift 2
      ;;
    --name)
      VM_NAME="$2"
      shift 2
      ;;
    --release)
      RELEASE="$2"
      shift 2
      ;;
    --username)
      USERNAME="$2"
      shift 2
      ;;
    --password)
      PASSWORD="$2"
      shift 2
      ;;
    --ask-password)
      ASK_PASSWORD=true
      shift
      ;;
    --vcpus)
      VCPUS="$2"
      shift 2
      ;;
    --memory)
      MEMORY="$2"
      shift 2
      ;;
    --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    --bridge)
      BRIDGE="$2"
      shift 2
      ;;
    --interactive)
      INTERACTIVE=true
      shift
      ;;
    --help | -h)
      usage
      exit 0
      ;;
    *)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    esac
  done

  if [[ "$INTERACTIVE" == true ]]; then
    return 0
  fi

  if [[ -z "${DISTRO:-}" ]]; then
    fail "Distribution is required. Use --distro option."
    usage
    exit 1
  fi

  VM_NAME="${VM_NAME:-${DISTRO}-vme}"

  is_empty "${USERNAME:-}" && USERNAME="$USER"

  if [[ "$ASK_PASSWORD" == true ]]; then
    read -r -s -p "Enter password for user: " PASSWORD
    echo
  fi
  is_empty "${PASSWORD:-}" && PASSWORD=$(generate_password_for "$VM_NAME")

  SSH_KEY_PATH=$(ssh_key_path)
  file_exists "$SSH_KEY_PATH" || die "SSH public key not found at: $SSH_KEY_PATH"

}

main() {
  virt_check_prerequisites
  libvirt_storage_setup

  parse_args "$@"

  if [[ "$INTERACTIVE" == true ]]; then
    check_cmd whiptail
    interactive_mode
  fi

  setup_storage
  configure_distribution
  BASE_IMAGE="${BASE_IMG_DIR}/$(basename "$IMG_URL")"
  VM_DISK="${WORK_DIR}/${VM_NAME}.qcow2"

  check_prerequisites

  show_configuration
  slog "Starting VM creation process for '${VM_NAME}'..."
  echo

  download_base_image
  generate_cloud_init
  create_disk

  if create_vm; then
    show_completion_info
  fi
}

interactive_mode() {
  if ! DISTRO=$(whiptail --title "Select Distribution" --menu "Choose a distribution" 18 60 8 \
    "arch" "Arch Linux" \
    "ubuntu" "Ubuntu" \
    "debian" "Debian" \
    "fedora" "Fedora" \
    "tumbleweed" "openSUSE Tumbleweed" \
    "centos" "CentOS Stream" \
    "rocky" "Rocky Linux" \
    "alpine" "Alpine Linux" 3>&1 1>&2 2>&3); then

    exit 1
  fi

  if [[ -z "$VM_NAME" ]]; then
    while true; do
      if ! VM_NAME=$(whiptail --title "VM Name" --inputbox "Enter the VM name" 10 60 "${DISTRO}-vme" 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if [[ ! "$VM_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        whiptail --title "Invalid Input" --msgbox "VM name can only contain letters, numbers, hyphens, and underscores." 8 78
      else
        break
      fi
    done
  fi

  if [[ -z "$USERNAME" ]]; then
    while true; do
      if ! USERNAME=$(whiptail --title "Username" --inputbox "Enter the username" 10 60 "${USER}" 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if ! [[ -z "$USERNAME" ]] || ! [[ "$USERNAME" =~ ^[a-z_][a-z0-9_-]*$ ]]; then
        whiptail --title "Invalid Input" --msgbox "Username must start with a lowercase letter or underscore,\nand contain only lowercase letters, numbers, underscores, and hyphens." 10 78
      else
        break
      fi
    done
  fi

  if [[ -z "${PASSWORD:-}" ]]; then
    while true; do
      if ! PASSWORD=$(whiptail --title "Password" --passwordbox "Enter the password" 10 60 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if [ -z "$PASSWORD" ]; then
        whiptail --title "Invalid Input" --msgbox "Password cannot be empty." 8 78
        continue
      fi

      if ! CONFIRM_PASSWORD=$(whiptail --title "Confirm Password" --passwordbox "Confirm the password" 10 60 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if [ "$PASSWORD" != "$CONFIRM_PASSWORD" ]; then
        whiptail --title "Error" --msgbox "Passwords do not match. Please try again." 8 78
      else
        break
      fi
    done
  fi

  if [[ -z "$VCPUS" ]]; then
    while true; do
      if ! VCPUS=$(whiptail --title "vCPUs" --inputbox "Enter the number of vCPUs" 10 60 "4" 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if ! [[ "$VCPUS" =~ ^[0-9]+$ ]]; then
        whiptail --title "Invalid Input" --msgbox "vCPUs must be a number." 8 78
      elif [[ "$VCPUS" -lt 1 ]]; then
        whiptail --title "Invalid Input" --msgbox "vCPUs must be at least 1." 8 78
      else
        break
      fi
    done
  fi

  if [[ -z "$MEMORY" ]]; then
    while true; do
      if ! MEMORY=$(whiptail --title "Memory" --inputbox "Enter the memory in MB" 10 60 "8192" 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if ! [[ "$MEMORY" =~ ^[0-9]+$ ]]; then
        whiptail --title "Invalid Input" --msgbox "Memory must be a number." 8 78
      elif [[ "$MEMORY" -lt 512 ]]; then
        whiptail --title "Invalid Input" --msgbox "Memory must be at least 512 MB." 8 78
      else
        break
      fi
    done
  fi

  if [[ -z "$DISK_SIZE" ]]; then
    while true; do
      if ! DISK_SIZE=$(whiptail --title "Disk Size" --inputbox "Enter the disk size (e.g., 30G)" 10 60 "30G" 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if ! [[ "$DISK_SIZE" =~ ^[0-9]+[GM]$ ]]; then
        whiptail --title "Invalid Input" --msgbox "Disk size must end with G or M (e.g., 30G, 512M)." 8 78
      else
        break
      fi
    done
  fi

  if [[ -z "$BRIDGE" ]]; then
    while true; do
      if ! BRIDGE=$(whiptail --title "Bridge" --inputbox "Enter the bridge name" 10 60 "default" 3>&1 1>&2 2>&3); then
        exit 1
      fi
      if ! virsh net-list --all --name | grep -q "^$BRIDGE$"; then
        whiptail --title "Invalid Input" --msgbox "Bridge '$BRIDGE' not found." 8 78
      else
        break
      fi
    done
  fi

  whiptail --title "Summary" --msgbox "
Distribution: $DISTRO
Release:     ${RELEASE:-auto}
VM Name:     $VM_NAME
Username:    $USERNAME
vCPUs:       $VCPUS
Memory:      $MEMORY MB
Disk Size:   $DISK_SIZE
" 18 60

}

main "$@"
