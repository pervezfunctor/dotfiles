#!/usr/bin/env bash

set -euo pipefail

# shellcheck disable=SC1091
source "$(dirname "$0")/vm-utils"

unset USERNAME
unset PASSWORD
unset DISTRO

VCPUS="4"
MEMORY="8192"
DISK_SIZE="30G"
BRIDGE="default"
OS_VARIANT="linux"
ASK_PASSWORD=false

check_whiptail() {
  if ! has_cmd whiptail; then
    fail "whiptail is not installed. Please install it to use interactive mode."
    exit 1
  fi
}

setup_storage() {
  local base_dir IMG_DIR

  base_dir="/var/lib/libvirt/images"

  IMG_DIR="${base_dir}/base-images"
  WORK_DIR="${base_dir}/${VM_NAME}"

  sudo mkdir -p "$IMG_DIR" "$WORK_DIR"

  sudo chown -R "$USER":kvm "$IMG_DIR"
  sudo chmod -R 755 "$IMG_DIR"

  sudo chown -R "$USER":kvm "$WORK_DIR"
  sudo chmod -R 755 "$WORK_DIR"

  sudo mkdir -p /var/lib/libvirt/boot # bug in libvirt/virt-install?

  BASE_IMAGE="${IMG_DIR}/${BASE_IMAGE_NAME}"
  VM_DISK="${WORK_DIR}/${VM_NAME}.qcow2"
}

cleanup_on_error() {
  warn "Cleaning up due to error..."

  if [[ -d "$WORK_DIR" ]]; then
    sudo rm -rf "$WORK_DIR" 2>/dev/null
  fi

  keep_sudo_running
}

trap cleanup_on_error ERR
trap 'cleanup_on_error; exit 1' INT TERM

configure_arch() {
  VM_NAME=${VM_NAME:-"arch-vme"}
  RELEASE=${RELEASE:="latest"}
  BASE_IMAGE_NAME="Arch-Linux-x86_64-cloudimg.qcow2"
  DOWNLOAD_URL="https://geo.mirror.pkgbuild.com/images/latest/${BASE_IMAGE_NAME}"
  OS_VARIANT="archlinux"
}

configure_ubuntu() {
  VM_NAME=${VM_NAME:-"ubuntu-vme"}
  RELEASE=${RELEASE:="plucky"}
  BASE_IMAGE_NAME="${RELEASE}-server-cloudimg-amd64.img"
  DOWNLOAD_URL="https://cloud-images.ubuntu.com/${RELEASE}/current/${BASE_IMAGE_NAME}"
  OS_VARIANT="ubuntu25.10"
}

configure_debian() {
  VM_NAME=${VM_NAME:="debian-vme"}
  RELEASE=${RELEASE:="trixie"} # 13
  BASE_IMAGE_NAME="debian-13-generic-amd64.qcow2"
  DOWNLOAD_URL="https://cloud.debian.org/images/cloud/trixie/latest/${BASE_IMAGE_NAME}"
  OS_VARIANT="debian13"
}

configure_fedora() {
  VM_NAME=${VM_NAME:="fedora-vme"}
  RELEASE=${RELEASE:=43}
  BASE_IMAGE_NAME="Fedora-Cloud-Base-Generic-43-1.6.x86_64.qcow2"
  DOWNLOAD_URL="https://download.fedoraproject.org/pub/fedora/linux/releases/${RELEASE}/Cloud/x86_64/images/${BASE_IMAGE_NAME}"
  OS_VARIANT="fedora${RELEASE}"

  if [[ "$RELEASE" -ne 43 ]]; then
    warn "Only Fedora 43 is supported. Installing Fedora 43."
  fi
}

configure_tw() {
  VM_NAME=${VM_NAME:-tw-vme}
  RELEASE=${RELEASE:=latest}
  BASE_IMAGE_NAME="openSUSE-Tumbleweed-Minimal-VM.x86_64-Cloud.qcow2"
  DOWNLOAD_URL="https://download.opensuse.org/tumbleweed/appliances/${BASE_IMAGE_NAME}"
  OS_VARIANT="opensusetumbleweed"
}

configure_centos() {
  VM_NAME=${VM_NAME:-centos-vme}
  RELEASE=${RELEASE:-"9-Stream"}
  BASE_IMAGE_NAME="CentOS-Stream-GenericCloud-9-latest.x86_64.qcow2"
  DOWNLOAD_URL="https://cloud.centos.org/centos/${RELEASE}/x86_64/images/${BASE_IMAGE_NAME}"
  OS_VARIANT="centos-stream9"
}

configure_rocky() {
  VM_NAME=${VM_NAME:-rocky-vme}
  RELEASE=${RELEASE:-"9"}
  BASE_IMAGE_NAME="Rocky-9-GenericCloud.latest.x86_64.qcow2"
  DOWNLOAD_URL="https://download.rockylinux.org/pub/rocky/${RELEASE}/images/x86_64/${BASE_IMAGE_NAME}"
  OS_VARIANT="rocky-linux-9"
}

configure_alpine() {
  VM_NAME=${VM_NAME:-alpine-vme}
  RELEASE=${RELEASE:-"3.22.2"}
  BASE_IMAGE_NAME="generic_alpine-${RELEASE}-x86_64-uefi-cloudinit-r0.qcow2"
  DOWNLOAD_URL="https://dl-cdn.alpinelinux.org/alpine/v${RELEASE}/releases/cloud/${BASE_IMAGE_NAME}"
  OS_VARIANT="alpinelinux3.22"
}

show_configuration() {
  echo
  printf '\033[1;36mâš™ï¸  CONFIGURATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s %s\033[0m\n' "$DISTRO" "$RELEASE"
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB RAM, %s disk\033[0m\n' "$VCPUS" "$MEMORY" "$DISK_SIZE"
  printf '\033[1mNetwork Bridge:\033[0m \033[0;33m%s\033[0m\n' "$BRIDGE"
  echo
  # printf "\033[1;36mPress enter to continue...\033[0m\n"
  # read -r
}

configure_distribution() {
  case "$DISTRO" in
  arch)
    configure_arch
    ;;
  ubuntu)
    configure_ubuntu
    ;;
  debian)
    configure_debian
    ;;
  fedora)
    configure_fedora
    ;;
  tw | tumbleweed)
    configure_tw
    ;;
  centos)
    configure_centos
    ;;
  rocky)
    configure_rocky
    ;;
  alpine)
    configure_alpine
    ;;
  *)
    fail "Unknown distribution: $DISTRO"
    fail "Supported distributions: arch, ubuntu, debian, fedora, tumbleweed, centos, rocky, alpine"
    usage
    exit 1
    ;;
  esac

  is_empty "${USERNAME:-}" && USERNAME="$USER"
  is_empty "${PASSWORD:-}" && PASSWORD=$(generate_password_for "$VM_NAME")
  PASSWORD_HASH=$(openssl passwd -6 "$PASSWORD")

  show_configuration
}

download_base_image() {
  if [ -f "${BASE_IMAGE}" ]; then
    info "Base image '${BASE_IMAGE}' already exists. Skipping download."
    return 0
  fi

  slog "Downloading base image from $DOWNLOAD_URL..."
  if ! sudo wget -q --show-progress "$DOWNLOAD_URL" -O "${BASE_IMAGE}"; then
    fail "Failed to download base image."
  else
    sudo chown root:kvm "${BASE_IMAGE}"
    sudo chmod 644 "${BASE_IMAGE}"
    success "Base image downloaded successfully."
  fi
}

generate_cloud_init() {
  slog "Generating cloud-init configuration..."

  local cloud_init_dir
  cloud_init_dir=$(mktemp -d)

  USER_DATA="${cloud_init_dir}/user-data"
  META_DATA="${cloud_init_dir}/meta-data"

  local pub_key
  pub_key=$(cat "$SSH_KEY_PATH")

  local openssh_pkg
  case "$DISTRO" in
  arch | tw | tumbleweed)
    openssh_pkg="openssh"
    ;;
  *)
    openssh_pkg="openssh-server"
    ;;
  esac

  local -a packages=(
    "qemu-guest-agent"
    "bash"
    "curl"
    "$openssh_pkg"
  )

  local -a runcmd_lines
  if [[ "$DISTRO" == "alpine" ]]; then
    runcmd_lines=(
      "rc-update add qemu-guest-agent default || true"
      "service qemu-guest-agent start || true"
      "rc-update add sshd default || true"
      "service sshd start || true"
    )
  else
    runcmd_lines=(
      "systemctl enable --now qemu-guest-agent || true"
      "systemctl enable --now ssh || systemctl enable --now sshd || true"
    )
  fi

  local sudo_groups
  if [[ "$DISTRO" == "ubuntu" || "$DISTRO" == "debian" ]]; then
    sudo_groups="sudo"
  else
    sudo_groups="wheel"
  fi

  cat >"${USER_DATA}" <<EOF
#cloud-config
hostname: $VM_NAME
manage_etc_hosts: true

users:
  - name: $USERNAME
    groups:
      - $sudo_groups
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: $PASSWORD_HASH
    ssh_authorized_keys:
      - $pub_key

package_update: true

packages:
$(for p in "${packages[@]}"; do printf "  - %s\n" "$p"; done)

runcmd:
$(printf "  - %s\n" "${runcmd_lines[@]}")
EOF

  cat >"${META_DATA}" <<EOF
instance-id: ${VM_NAME}-$(date +%s)
local-hostname: $VM_NAME
EOF

  success "Cloud-init configuration generated"
}

check_prerequisites() {
  if ! groups "$USER" | grep -q '\blibvirtd\?\b'; then
    fail "Error: User '$USER' is not in the 'libvirt' group." >&2
    fail "Please run: 'sudo usermod -aG libvirt \$USER' and then log out and back in." >&2
    exit 1
  fi

  if virsh dominfo "${VM_NAME}" &>/dev/null; then
    fail "Error: A VM named '${VM_NAME}' already exists." >&2
    fail "Please remove it with: virsh destroy ${VM_NAME} && virsh undefine ${VM_NAME}" >&2
    exit 1
  fi

  if [ -f "${VM_DISK}" ]; then
    fail "Error: A disk file at '${VM_DISK}' already exists." >&2
    fail "Please remove it with: sudo rm -f ${VM_DISK}" >&2
    exit 1
  fi
}

create_disk() {
  slog "Creating and resizing disk for ${VM_NAME} at ${VM_DISK}..."
  sudo qemu-img create -f qcow2 -b "${BASE_IMAGE}" -F qcow2 "${VM_DISK}" "${DISK_SIZE}"
  success "Disk created successfully."
}

create_vm() {
  slog "Creating VM '${VM_NAME}'..."

  if virt-install \
    --connect qemu:///system \
    --name "${VM_NAME}" \
    --memory "${MEMORY}" \
    --vcpus "${VCPUS}" \
    --os-variant "${OS_VARIANT}" \
    --disk path="${VM_DISK}",device=disk,bus=virtio,format=qcow2 \
    --network network="${BRIDGE}",model=virtio \
    --cloud-init user-data="${USER_DATA}",meta-data="${META_DATA}" \
    --import \
    --video=virtio \
    --graphics none \
    --console pty,target_type=serial \
    --noautoconsole; then
    success "VM creation process started for '${VM_NAME}'."
    return 0
  else
    return 1
  fi
}

wait_for_ip() {
  local vm_name="$1"

  printf '\033[1;36mðŸ” Wait for IP address? (Y/n):\033[0m ' >&2
  read -t 5 -r response || response="y"

  case "$response" in
  n | N)
    slog "Skipping IP wait. You can get the IP later with: virsh domifaddr $vm_name --source agent"
    return 1
    ;;
  *)
    if wait_until 30 2 bash -c "virsh domstate $vm_name | grep -q running"; then
      slog "VM is running"
    else
      return 1
    fi

    if wait_until 60 2 vm_ip "$vm_name" >/dev/null; then
      slog "VM has IP address"
      sleep 1
    else
      return 1
    fi

    return 0
    ;;
  esac
}

add_ssh_config() {
  has_cmd ssh-config || return 0

  local ip
  ip=$(vm_ip "$VM_NAME")

  slog "Adding SSH configuration for $VM_NAME..."
  if ssh-config add --host "$VM_NAME" --ip "$ip" --user "$USERNAME" --identity "${SSH_KEY_PATH%.pub}"; then
    printf '\033[1mSSH Config:\033[0m    \033[0;32mAdded to ~/.ssh/conf.d/%s.conf\033[0m\n' "$VM_NAME"
    printf '\033[1mSSH Shortcut:\033[0m  \033[0;33mssh %s\033[0m\n' "$VM_NAME"
  else
    warn "Failed to add SSH configuration"
  fi
}

show_completion_info() {
  slog "Waiting for VM to be ready. This could take a few minutes..."
  if ! wait_for_ip "$VM_NAME"; then
    fail "VM did not get an IP in time. Try 'vme show-ip $VM_NAME' later."
    info "If you still can't connect, Use 'vme console $VM_NAME' to access it."
  fi

  echo
  printf '\033[1;32mâ•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®\033[0m\n'
  printf '\033[1;32mâ”‚\033[1;37m                       VM CREATED SUCCESSFULLY!             \033[1;32mâ”‚\033[0m\n'
  printf '\033[1;32mâ•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯\033[0m\n'
  echo

  printf '\033[1;36mðŸ“‹ VM INFORMATION:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mVM Name:\033[0m      \033[0;33m%s\033[0m\n' "$VM_NAME"
  printf '\033[1mDistribution:\033[0m   \033[0;33m%s %s\033[0m\n' "$DISTRO" "$RELEASE"
  printf '\033[1mUsername:\033[0m      \033[0;33m%s\033[0m\n' "$USERNAME"
  printf '\033[1mPassword:\033[0m      \033[0;33m%s\033[0m\n' "$PASSWORD"
  printf '\033[1mResources:\033[0m     \033[0;33m%s vCPUs, %sMB RAM, %s disk\033[0m\n' "$VCPUS" "$MEMORY" "$DISK_SIZE"
  printf '\033[1mType:\033[0m          \033[0;33mVirtual Machine (full virtualization)\033[0m\n'
  echo

  printf '\033[1;36mðŸŒ NETWORK ACCESS:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'

  local ip
  if ip=$(vm_ip "$VM_NAME" 2>/dev/null); then
    printf '\033[1mIP Address:\033[0m   \033[0;33m%s\033[0m\n' "$ip"
    printf '\033[1mSSH Command:\033[0m  \033[0;33mvme ssh %s\033[0m\n' "$VM_NAME"
    printf '\033[1mSSH Command:\033[0m  \033[0;33mssh %s@%s\033[0m\n' "$USERNAME" "$ip"
    echo
  else
    printf '\033[1mGet IP Address:\033[0m \033[0;33mvirsh domifaddr %s --source agent\033[0m\n' "$VM_NAME"
  fi
  echo

  printf '\033[1;36mðŸ”§ VM MANAGEMENT:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mStart:\033[0m      \033[0;33mvme start %s\033[0m\n' "$VM_NAME"
  printf '\033[1mStop:\033[0m       \033[0;33mvme shutdown %s\033[0m\n' "$VM_NAME"
  printf '\033[1mDelete:\033[0m     \033[0;33mvme delete %s\033[0m\n' "$VM_NAME"
  printf '\033[1mAutostart:\033[0m  \033[0;33mvme autostart %s\033[0m\n' "$VM_NAME"
  echo

  printf '\033[1;36mðŸ“Š VM DETAILS:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mInfo:\033[0m        \033[0;33mvme info %s\033[0m\n' "$VM_NAME"
  printf '\033[1mList VMs:\033[0m    \033[0;33mvme list\033[0m\n'
  echo

  printf '\033[1;36mðŸ”§ TROUBLESHOOTING:\033[0m\n'
  printf '\033[0;36mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n'
  printf '\033[1mConsole:\033[0m   \033[0;33mvme console %s\033[0m\n' "$VM_NAME"
  printf '\033[0;90m(Exit console with Ctrl+])\033[0m\n'
  echo

  success "VM '${VM_NAME}' creation process completed successfully!"
  echo
}

usage() {
  cat <<EOF
Usage: $0 --distro DISTRO [OPTIONS]

Create libvirt virtual machines with cloud-init and SSH access.

REQUIRED:
    --distro DISTRO         Distribution (arch, ubuntu, debian, fedora, tumbleweed, centos, rocky, alpine)

OPTIONS:
    --name NAME             VM name (default: distro-vme)
    --release RELEASE       Distribution release (default: latest)
    --username USER         Username for VM (default: current user)
    --password PASS         User password (default: auto-generated)
    --ask-password          Prompt for password input
    --vcpus NUM             Number of vCPUs (default: 4)
    --memory MB             RAM in MB (default: 8192)
    --disk-size SIZE        Disk size (default: 30G)
    --bridge BRIDGE         Network bridge (default: default)
    --help, -h              Show this help

EXAMPLES:
    $0 --distro ubuntu
    $0 --distro fedora --name my-fedora --vcpus 4 --memory 4096
    $0 --distro debian --username admin --password mypass
    $0 --distro arch --release current --disk-size 40G
    $0 --distro tumbleweed --name opensuse-vm --vcpus 2 --memory 4096

SUPPORTED DISTRIBUTIONS:
    arch        - Arch Linux (latest)
    ubuntu      - Ubuntu (plucky/25.10)
    debian      - Debian (13/trixie)
    fedora      - Fedora (43)
    tumbleweed  - openSUSE Tumbleweed (rolling release)
    centos      - CentOS Stream (9-Stream)
    rocky       - Rocky Linux (9)
    alpine      - Alpine Linux (3.22)
EOF
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
    --distro)
      DISTRO="$2"
      shift 2
      ;;
    --name)
      VM_NAME="$2"
      shift 2
      ;;
    --release)
      RELEASE="$2"
      shift 2
      ;;
    --username)
      USERNAME="$2"
      shift 2
      ;;
    --password)
      PASSWORD="$2"
      shift 2
      ;;
    --ask-password)
      ASK_PASSWORD=true
      shift
      ;;
    --vcpus)
      VCPUS="$2"
      shift 2
      ;;
    --memory)
      MEMORY="$2"
      shift 2
      ;;
    --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    --bridge)
      BRIDGE="$2"
      shift 2
      ;;
    --help | -h)
      usage
      exit 0
      ;;
    *)
      fail "Unknown option: $1"
      usage
      exit 1
      ;;
    esac
  done

  if [[ -z "${DISTRO:-}" ]]; then
    fail "Distribution is required. Use --distro option."
    usage
    exit 1
  fi

  if [[ "$ASK_PASSWORD" == true ]]; then
    read -r -s -p "Enter password for user: " PASSWORD
    echo
  fi
}

main() {
  virt_check_prerequisites

  if [ $# -eq 0 ]; then
    check_whiptail
    interactive_mode
  else
    parse_args "$@"
  fi

  configure_distribution
  setup_storage
  SSH_KEY_PATH=$(ssh_key_path)

  check_prerequisites

  slog "Starting VM creation process for '${VM_NAME}'..."
  echo

  info "Using vCPUs: ${VCPUS}"
  info "Using memory: ${MEMORY} MB"
  info "Using disk size: ${DISK_SIZE}"
  echo
  sleep 1

  download_base_image
  generate_cloud_init
  create_disk
  if create_vm; then
    show_completion_info
    add_ssh_config
  fi
}

interactive_mode() {
  if ! DISTRO=$(whiptail --title "Select Distribution" --menu "Choose a distribution" 18 60 8 \
    "arch" "Arch Linux" \
    "ubuntu" "Ubuntu" \
    "debian" "Debian" \
    "fedora" "Fedora" \
    "tumbleweed" "openSUSE Tumbleweed" \
    "centos" "CentOS Stream" \
    "rocky" "Rocky Linux" \
    "alpine" "Alpine Linux" 3>&1 1>&2 2>&3); then

    exit 1
  fi

  while true; do
    if ! VM_NAME=$(whiptail --title "VM Name" --inputbox "Enter the VM name" 10 60 "${DISTRO}-vme" 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if [ -z "$VM_NAME" ]; then
      whiptail --title "Invalid Input" --msgbox "VM name cannot be empty." 8 78
    else
      break
    fi
  done

  while true; do
    if ! USERNAME=$(whiptail --title "Username" --inputbox "Enter the username" 10 60 "${USER}" 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if [ -z "$USERNAME" ]; then
      whiptail --title "Invalid Input" --msgbox "Username cannot be empty." 8 78
    else
      break
    fi
  done

  while true; do
    if ! PASSWORD=$(whiptail --title "Password" --passwordbox "Enter the password" 10 60 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if [ -z "$PASSWORD" ]; then
      whiptail --title "Invalid Input" --msgbox "Password cannot be empty." 8 78
      continue
    fi

    if ! CONFIRM_PASSWORD=$(whiptail --title "Confirm Password" --passwordbox "Confirm the password" 10 60 3>&1 1>&2 2>&3); then
      exit 1
    fi

    if [ "$PASSWORD" != "$CONFIRM_PASSWORD" ]; then
      whiptail --title "Error" --msgbox "Passwords do not match. Please try again." 8 78
    else
      break
    fi
  done

  while true; do
    if ! VCPUS=$(whiptail --title "vCPUs" --inputbox "Enter the number of vCPUs" 10 60 "4" 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if ! [[ "$VCPUS" =~ ^[0-9]+$ ]]; then
      whiptail --title "Invalid Input" --msgbox "vCPUs must be a number." 8 78
    elif [[ "$VCPUS" -lt 1 ]]; then
      whiptail --title "Invalid Input" --msgbox "vCPUs must be at least 1." 8 78
    else
      break
    fi
  done

  while true; do
    if ! MEMORY=$(whiptail --title "Memory" --inputbox "Enter the memory in MB" 10 60 "8192" 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if ! [[ "$MEMORY" =~ ^[0-9]+$ ]]; then
      whiptail --title "Invalid Input" --msgbox "Memory must be a number." 8 78
    elif [[ "$MEMORY" -lt 512 ]]; then
      whiptail --title "Invalid Input" --msgbox "Memory must be at least 512 MB." 8 78
    else
      break
    fi
  done

  while true; do
    if ! DISK_SIZE=$(whiptail --title "Disk Size" --inputbox "Enter the disk size (e.g., 30G)" 10 60 "30G" 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if ! [[ "$DISK_SIZE" =~ ^[0-9]+[GM]$ ]]; then
      whiptail --title "Invalid Input" --msgbox "Disk size must end with G or M (e.g., 30G, 512M)." 8 78
    else
      break
    fi
  done

  while true; do
    if ! BRIDGE=$(whiptail --title "Bridge" --inputbox "Enter the bridge name" 10 60 "default" 3>&1 1>&2 2>&3); then
      exit 1
    fi
    if ! virsh net-list --all --name | grep -q "^$BRIDGE$"; then
      whiptail --title "Invalid Input" --msgbox "Bridge '$BRIDGE' not found." 8 78
    else
      break
    fi
  done

  whiptail --title "Summary" --msgbox "
  Distribution: $DISTRO
  VM Name:   $VM_NAME
  Username:  $USERNAME
  vCPUs:     $VCPUS
  Memory:    $MEMORY MB
  Disk Size: $DISK_SIZE
  " 15 60
}

main "$@"
