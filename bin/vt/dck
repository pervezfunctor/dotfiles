#!/bin/bash

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

# Check if Docker is installed and running
check_docker() {
    if ! command -v docker >/dev/null 2>&1; then
        log_error "docker command not found. Please install Docker first."
        log_info "You can install it with: $0 install"
        return 1
    fi

    if ! docker info >/dev/null 2>&1; then
        log_error "Docker daemon is not running or not accessible."
        log_info "Start Docker with: sudo systemctl start docker"
        log_info "Or add your user to docker group: sudo usermod -aG docker \$USER"
        return 1
    fi
    return 0
}

# Show Docker status on startup
if check_docker; then
    docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedAt}}" 2>/dev/null | head -10 || true
else
    echo
    exit 1
fi

usage() {
    cat <<EOF
Usage: $0 <command> [container-name] [args...]

Manage Docker containers similar to other container management tools.

COMMANDS:
    install                 Install Docker using ilmi
    list                    List all Docker containers
    status <name>           Show container status and info
    create <distro> [name]  Create a new Docker container
    start <name>            Start a container
    stop <name>             Stop a container
    restart <name>          Restart a container
    delete <name>           Delete a container completely
    shell <name>            Enter container shell
    exec <name> <cmd>       Execute command in container
    logs <name>             Show container logs
    pull <image>            Pull Docker image
    images                  List Docker images
    cleanup                 Remove stopped containers and orphaned data

SUPPORTED DISTROS:
    ubuntu, debian, arch, fedora, rocky, tumbleweed, alpine,
    centos, nixos

EXAMPLES:
    $0 install                      # Install Docker
    $0 list                         # List all containers
    $0 status ubuntu                # Show status of 'ubuntu' container
    $0 create ubuntu myubuntu       # Create Ubuntu container named 'myubuntu'
    $0 create fedora                # Create Fedora container with default name
    $0 shell ubuntu                 # Enter 'ubuntu' container shell
    $0 exec ubuntu "ls -la"         # Run command in 'ubuntu' container
    $0 pull ubuntu:22.04            # Pull specific Ubuntu image
    $0 delete old-container         # Delete 'old-container' completely

EOF
}

list_containers() {
    check_docker || return 1
    log_info "Listing all Docker containers..."
    echo
    docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.Ports}}\t{{.CreatedAt}}"
}

install_docker() {
    log_info "Installing Docker using ilmi..."

    # Check if ilmi is available
    if ! command -v ilmi >/dev/null 2>&1; then
        log_error "ilmi not found. Installing it first..."

        # Install ilmi
        if command -v curl >/dev/null 2>&1; then
            bash -c "$(curl -sSL https://dub.sh/aPKPT8V)" -- docker
        elif command -v wget >/dev/null 2>&1; then
            bash -c "$(wget -qO- https://dub.sh/aPKPT8V)" -- docker
        else
            log_error "Neither curl nor wget found. Please install one of them first."
            return 1
        fi
    else
        # Use existing ilmi
        ilmi docker
    fi

    if command -v docker >/dev/null 2>&1; then
        log_success "Docker installed successfully!"
        echo
        log_info "Installed tools include:"
        command -v docker >/dev/null 2>&1 && log_info "  ✓ docker"
        command -v docker-compose >/dev/null 2>&1 && log_info "  ✓ docker-compose"
        echo
        log_info "You can now use:"
        log_info "  $0 list                    # List containers"
        log_info "  $0 create ubuntu           # Create Ubuntu container"
        log_info "  $0 shell ubuntu            # Enter container"
        echo
        if ! docker info >/dev/null 2>&1; then
            log_warn "Docker daemon is not running or not accessible."
            log_info "Start Docker with: sudo systemctl start docker"
            log_info "Add your user to docker group: sudo usermod -aG docker \$USER"
            log_info "Then log out and back in for group changes to take effect."
        fi
    else
        log_error "Docker installation failed. Please check the output above for errors."
        return 1
    fi
}

container_status() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    log_info "Status for container '$container_name':"
    echo
    docker ps -a --filter "name=^${container_name}$" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.Ports}}\t{{.CreatedAt}}"
    echo

    log_info "Container details:"
    docker inspect "$container_name" --format "{{json .}}" | jq -r '
        "ID: " + .Id[:12] + "\n" +
        "Image: " + .Config.Image + "\n" +
        "State: " + .State.Status + "\n" +
        "Started: " + .State.StartedAt + "\n" +
        "IP Address: " + (.NetworkSettings.IPAddress // "N/A") + "\n" +
        "Ports: " + ((.NetworkSettings.Ports // {}) | keys | join(", "))
    ' 2>/dev/null || docker inspect "$container_name" | head -20
}

create_container() {
    local distro="$1"
    local container_name="${2:-$distro}"
    check_docker || return 1

    # Check if container already exists
    if docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' already exists"
        return 1
    fi

    log_info "Creating $distro Docker container: $container_name"

    local image_name
    case "$distro" in
    ubuntu)
        image_name="ubuntu:latest"
        ;;
    debian)
        image_name="debian:latest"
        ;;
    arch | archlinux)
        image_name="archlinux:latest"
        ;;
    fedora)
        image_name="fedora:latest"
        ;;
    rocky)
        image_name="rockylinux:9"
        ;;
    tumbleweed | tw)
        image_name="opensuse/tumbleweed:latest"
        ;;
    alpine)
        image_name="alpine:latest"
        ;;
    centos)
        image_name="centos:stream9"
        ;;
    nixos)
        image_name="nixos/nix:latest"
        ;;
    *)
        log_error "Unsupported distro: $distro"
        log_info "Supported distros: ubuntu, debian, arch, fedora, rocky, tumbleweed, alpine, centos, nixos"
        return 1
        ;;
    esac

    log_info "Pulling image: $image_name"
    if ! docker pull "$image_name"; then
        log_error "Failed to pull image: $image_name"
        return 1
    fi

    log_info "Creating container with interactive shell..."

    # Try bash first, then sh as fallback
    if docker run -dit --name "$container_name" "$image_name" /bin/bash >/dev/null 2>&1; then
        log_success "Container '$container_name' created successfully with bash"
    else
        # If bash failed, try sh (but first remove any partially created container)
        docker rm "$container_name" 2>/dev/null || true
        if docker run -dit --name "$container_name" "$image_name" /bin/sh >/dev/null 2>&1; then
            log_success "Container '$container_name' created successfully with sh"
        else
            log_error "Failed to create container '$container_name'"
            return 1
        fi
    fi

    # Verify container is running
    sleep 1
    local state
    state=$(docker inspect "$container_name" --format "{{.State.Status}}" 2>/dev/null)

    if [[ "$state" == "running" ]]; then
        log_info "Container status:"
        docker ps --filter "name=^${container_name}$" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedAt}}"
    else
        log_warn "Container created but not running. Status: $state"
        log_info "You may need to start it manually: $0 start $container_name"
    fi
}

start_container() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    local state
    state=$(docker inspect "$container_name" --format "{{.State.Status}}")

    if [[ "$state" == "running" ]]; then
        log_warn "Container '$container_name' is already running"
        return 0
    fi

    log_info "Starting container '$container_name'..."
    if docker start "$container_name"; then
        log_success "Container '$container_name' started"
        docker ps --filter "name=^${container_name}$" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedAt}}"
    else
        log_error "Failed to start container '$container_name'"
        return 1
    fi
}

stop_container() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    local state
    state=$(docker inspect "$container_name" --format "{{.State.Status}}")

    if [[ "$state" != "running" ]]; then
        log_warn "Container '$container_name' is not running"
        return 0
    fi

    log_info "Stopping container '$container_name'..."
    if docker stop "$container_name"; then
        log_success "Container '$container_name' stopped"
    else
        log_error "Failed to stop container '$container_name'"
        return 1
    fi
}

restart_container() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    log_info "Restarting container '$container_name'..."
    if docker restart "$container_name"; then
        log_success "Container '$container_name' restarted"
        sleep 1
        docker ps --filter "name=^${container_name}$" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedAt}}"
    else
        log_error "Failed to restart container '$container_name'"
        return 1
    fi
}

delete_container() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    log_warn "This will permanently delete container '$container_name' and all its data!"
    read -p "Are you sure? (y/N): " -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log_info "Deletion cancelled"
        return 0
    fi

    local state
    state=$(docker inspect "$container_name" --format "{{.State.Status}}")
    if [[ "$state" == "running" ]]; then
        log_info "Stopping container first..."
        docker stop "$container_name"
    fi

    log_info "Deleting container '$container_name'..."
    if docker rm "$container_name"; then
        log_success "Container '$container_name' deleted successfully"
    else
        log_error "Failed to delete container '$container_name'"
        return 1
    fi
}

enter_shell() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    local state
    state=$(docker inspect "$container_name" --format "{{.State.Status}}")

    if [[ "$state" != "running" ]]; then
        log_error "Container '$container_name' is not running"
        log_info "Start it with: $0 start $container_name"
        return 1
    fi

    log_info "Entering shell of container '$container_name'..."
    # Try bash first, then sh as fallback
    if ! docker exec -it "$container_name" /bin/bash 2>/dev/null; then
        docker exec -it "$container_name" /bin/sh
    fi
}

exec_in_container() {
    local container_name="$1"
    shift
    local command="$*"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    local state
    state=$(docker inspect "$container_name" --format "{{.State.Status}}")

    if [[ "$state" != "running" ]]; then
        log_error "Container '$container_name' is not running"
        log_info "Start it with: $0 start $container_name"
        return 1
    fi

    log_info "Executing command in container '$container_name': $command"
    docker exec "$container_name" sh -c "$command"
}

show_logs() {
    local container_name="$1"
    check_docker || return 1

    if ! docker ps -a --format "{{.Names}}" | grep -q "^${container_name}$"; then
        log_error "Container '$container_name' not found"
        return 1
    fi

    log_info "Showing logs for container '$container_name'..."
    echo
    docker logs "$container_name"
}

pull_image() {
    local image_name="$1"
    check_docker || return 1

    log_info "Pulling Docker image: $image_name"
    if docker pull "$image_name"; then
        log_success "Image '$image_name' pulled successfully"
    else
        log_error "Failed to pull image '$image_name'"
        return 1
    fi
}

list_images() {
    check_docker || return 1
    log_info "Listing Docker images..."
    echo
    docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}"
}

cleanup_containers() {
    check_docker || return 1
    log_info "Cleaning up stopped containers and orphaned data..."

    # List stopped containers
    local stopped_containers
    stopped_containers=$(docker ps -a --filter "status=exited" --format "{{.Names}}")

    if [[ -n "$stopped_containers" ]]; then
        log_info "Stopped containers found:"
        echo "$stopped_containers"
        echo

        read -p "Remove all stopped containers? (y/N): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            while IFS= read -r container; do
                if [[ -n "$container" ]]; then
                    log_info "Removing stopped container: $container"
                    docker rm "$container" 2>/dev/null || true
                fi
            done <<<"$stopped_containers"
        fi
    else
        log_info "No stopped containers found"
    fi

    # Clean up dangling images
    log_info "Checking for dangling images..."
    local dangling_images
    dangling_images=$(docker images -f "dangling=true" -q)

    if [[ -n "$dangling_images" ]]; then
        log_info "Dangling images found"
        read -p "Remove dangling images? (y/N): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            # shellcheck disable=SC2086
            docker rmi $dangling_images 2>/dev/null || true
            log_success "Dangling images removed"
        fi
    else
        log_info "No dangling images found"
    fi

    # Clean up unused volumes
    log_info "Checking for unused volumes..."
    read -p "Remove unused volumes? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        docker volume prune -f 2>/dev/null || true
        log_success "Unused volumes removed"
    fi

    log_success "Cleanup complete"
}

# Main command handling
if [[ $# -eq 0 ]]; then
    usage
    exit 1
fi

command="$1"
container_name="${2:-}"

case "$command" in
install)
    install_docker
    ;;
list)
    list_containers
    ;;
status)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    container_status "$container_name"
    ;;
create)
    [[ -z "$container_name" ]] && {
        log_error "Distro name required"
        usage
        exit 1
    }
    create_container "$container_name" "${3:-}"
    ;;
start)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    start_container "$container_name"
    ;;
stop)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    stop_container "$container_name"
    ;;
restart)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    restart_container "$container_name"
    ;;
delete)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    delete_container "$container_name"
    ;;
shell)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    enter_shell "$container_name"
    ;;
exec)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    [[ $# -lt 3 ]] && {
        log_error "Command required"
        usage
        exit 1
    }
    exec_in_container "$container_name" "${@:3}"
    ;;
logs)
    [[ -z "$container_name" ]] && {
        log_error "Container name required"
        usage
        exit 1
    }
    show_logs "$container_name"
    ;;
pull)
    [[ -z "$container_name" ]] && {
        log_error "Image name required"
        usage
        exit 1
    }
    pull_image "$container_name"
    ;;
images)
    list_images
    ;;
cleanup)
    cleanup_containers
    ;;
--help | -h)
    usage
    ;;
*)
    log_error "Unknown command: $command"
    usage
    exit 1
    ;;
esac
