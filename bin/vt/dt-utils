#!/usr/bin/env bash

# shellcheck disable=SC1091

source "$DOT_DIR/share/utils"
source "$(dirname "$0")/vt-utils"

if [[ -z ${DT_ROOT_ARGS+x} ]]; then
  DT_ROOT_ARGS=()
fi

dt_distrobox() {
  command distrobox "${DT_ROOT_ARGS[@]}" "$@"
}

dt_set_root_args() {
  DT_ROOT_ARGS=("$@")
}

dt_enable_root_mode() {
  dt_set_root_args --root
}

dt_disable_root_mode() {
  dt_set_root_args
}

dt_exists() {
  local container_name="$1"
  dt_distrobox list | grep -q "\b${container_name}\b" || return 1
}

dt_check_exists() {
  local container_name="$1"
  dt_exists "$container_name" || die "Container '$container_name' not found"
}

dt_list() {
  slog "Listing all distrobox containers..."

  echo
  dt_distrobox list

  if has_cmd podman; then
    echo
    echo
    echo
    slog "Podman container details:"
    podman ps -a --filter "label=manager=distrobox" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedHuman}}" 2>/dev/null || true
  elif has_cmd docker; then
    echo
    echo
    echo
    slog "Docker container details:"
    docker ps -a --filter "label=manager=distrobox" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedAt}}" 2>/dev/null || true
  fi
}

dt_state() {
  local container_name="$1"

  dt_check_exists "$container_name"

  slog "Status for container '$container_name':"

  local engine
  engine=$(dt_distrobox list | grep "\b${container_name}\b" | awk '{print $NF}' | head -1)
  if [[ -n "$engine" ]]; then
    slog "Container engine details:"
    if has_cmd podman; then
      podman ps -a --filter "name=${container_name}" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedHuman}}" 2>/dev/null || true
    elif has_cmd docker; then
      docker ps -a --filter "name=${container_name}" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.CreatedAt}}" 2>/dev/null || true
    fi
  fi
}
