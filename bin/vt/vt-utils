#!/usr/bin/env bash

# shellcheck disable=SC1091

DOT_DIR=${DOT_DIR:-$HOME/.ilm}
source "$DOT_DIR/share/utils"

is_net_service_running() {
  if ! has_cmd ss; then
    fail "ss command not found. Please install it first."
    return 1
  fi

  local service=${1:-ssh}
  sudo ss -tlnp | grep -q "$service"
}

check_tmux() {
  has_cmd tmux && return 0

  fail "tmux is not installed. Please install it first."
  exit 1
}

default_username() {
  local distro="$1"

  local username

  case "$distro" in
  ubuntu*) username="ubuntu" ;;
  fedora*) username="fedora" ;;
  centos*) username="centos" ;;
  debian*) username="debian" ;;
  arch*) username="arch" ;;
  alpine*) username="alpine" ;;
  nix*) username="nixos" ;;
  rocky*) username="rocky" ;;
  tumbleweed* | tw*) username="opensuse" ;;
  *)
    username="$USER"
    ;;
  esac

  echo "$username"
}

add_ssh_config() {
  local vm_name="$1"
  local port="$2"
  local user="$3"

  if [[ -z "$vm_name" || -z "$port" || -z "$user" ]]; then
    echo "Usage: add_ssh_config <vm_name> <port> <user>" >&2
    return 1
  fi

  local ssh_config="$HOME/.ssh/config"

  mkdir -p "$HOME/.ssh"
  touch "$ssh_config"

  if grep -qE "^Host[[:space:]]+$vm_name\$" "$ssh_config"; then
    echo "Host $vm_name already exists in SSH config" >&2
    return 0
  fi

  {
    echo "Host $vm_name"
    echo "    HostName 127.0.0.1"
    echo "    User $user"
    echo "    Port $port"
    echo "    IdentityFile ~/.ssh/id_rsa"
    echo "    StrictHostKeyChecking no"
    echo "    UserKnownHostsFile /dev/null"
    echo
  } >>"$ssh_config"

  echo "Added SSH config for $vm_name (port $port, user $user)"
}

add_port_command() {
  local ssh_config="$HOME/.ssh/config"
  touch "$ssh_config"

  if grep -qE "^Host[[:space:]]+\\*-vmu$" "$ssh_config"; then
    return
  fi

  cat <<'EOF' >>"$ssh_config"
Host *-vmu
  HostName 127.0.0.1
  ProxyCommand sh -c 'port=$(grep -m1 "^%h " ~/.vm-ports | awk "{print \$2}"); exec nc 127.0.0.1 $port'
  StrictHostKeyChecking no
  UserKnownHostsFile=/dev/null
  LogLevel ERROR
EOF
}

get_host_nic() {
  ip route show default | awk '/default/ {print $5}'
}

