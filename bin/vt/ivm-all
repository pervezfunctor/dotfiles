#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/incus-utils"
source "$(dirname "$0")/all-utils"

all_create() {
  slog "Creating Incus VMs (Debian, Ubuntu, Fedora, Arch, Tumbleweed)..."
  echo

  for distro in "${DISTRO_LIST_ivm[@]}"; do
    if ivm_exists "${distro}-ivm"; then
      warn "$distro VM already exists, skipping..."
    else
      ivm-create --distro "$distro" --name "${distro}-ivm"
    fi
  done

  echo
  success "All VMs created successfully!"
  slog "You can access them using: incus console <vm-name> <username>"
  echo
}

all_op() {
  local op="$1"
  shift

  slog "Performing operation '$op' on all VMs..."
  echo

  for vm in "${DISTRO_LIST_ivm[@]}"; do
    if ivm_exists "${vm}-ivm"; then
      ivm "$op" "${vm}-ivm" "$@"
    else
      warn "VM ${vm}-ivm does not exist, skipping..."
    fi
  done

  echo
  success "Performed operation '$op' on all VMs successfully!"
  echo
}

all_delete() {
  all_op "delete" "$@"
}

all_start() {
  all_op "start" "$@"
}

all_stop() {
  all_op "stop" "$@"
}

all_restart() {
  all_op "restart" "$@"
}

all_exec() {
  all_op "exec" "$@"
}

usage() {
  all_usage "incus" "VMs"
}

main() {
  all_parse_args "$@"
}

main "$@"
