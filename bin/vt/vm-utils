#!/bin/bash

# shellcheck disable=SC1091
source "$(dirname "$0")/vt-utils"

check_libvirt() {
  local missing_tools=()
  for tool in virsh virt-install qemu-img wget mkisofs; do
    if ! has_cmd "$tool"; then
      missing_tools+=("$tool")
    fi
  done

  if [[ ${#missing_tools[@]} -gt 0 ]]; then
    fail "Missing required tools: ${missing_tools[*]}"
    fail "Install with: $INSTALL_CMD"
    exit 1
  fi

  if ! systemctl is-active --quiet libvirtd; then
    fail "libvirtd service is not running"
    fail "Start with: sudo systemctl start libvirtd"
    exit 1
  fi

  if ! groups | grep -q libvirt; then
    fail "User not in libvirt group. You may need sudo for virsh commands"
    fail "Add user to group: sudo usermod -a -G libvirt \$USER"
    exit 1
  fi

}

list_vms() {
  slog "Listing all VMs..."
  echo
  if has_cmd virsh; then
    virsh list --all
  else
    fail "virsh command not found. Please install virtualization tools first."
    slog "You can install them with: $0 install"
    return 1
  fi
}

check_vm_prerequisites() {
  check_libvirt

  if ! has_cmd vm-create; then
    fail "vm-create is not in PATH."
    exit 1
  fi

  if ! has_cmd vm; then
    fail "vm is not in PATH."
    exit 1
  fi
}

vm_exists() {
  virsh list --all | grep -q "$1" >/dev/null
}

has_vm() {
  virsh dominfo "$1" &>/dev/null
}

check_vm() {
  local vm_name="$1"

  has_vm "$vm_name" && return 0

  fail "VM '$vm_name' not found"
  return 1
}

get_vm_state() {
  virsh domstate "$vm_name"
}

get_vm_ip() {
  local vm_name="$1"

  if ! virsh dominfo "$vm_name" &>/dev/null; then
    return 1
  fi

  local state
  state=$(virsh domstate "$vm_name")

  if [[ "$state" != "running" ]]; then
    return 2
  fi

  local ip
  ip=$(virsh domifaddr "$vm_name" --source agent | awk '/enp|eth/ {sub(/\/.*/, "", $4); print $4}')

  if [[ -z "$ip" ]]; then
    ip=$(virsh net-dhcp-leases default 2>/dev/null | grep "$vm_name" | awk '{print $5}' | cut -d'/' -f1 | head -1)
  fi

  if [[ -z "$ip" ]]; then
    return 3
  fi

  echo "$ip"
  return 0
}

ip_errors() {
  local ret=$1
  local vm_name=$2

  if [[ $ret -eq 1 ]]; then
    fail "VM '$vm_name' not found"
    return 1
  elif [[ $ret -eq 2 ]]; then
    fail "VM '$vm_name' is not running"
    return 1
  elif [[ $ret -eq 3 ]]; then
    fail "Could not determine IP address for VM '$vm_name'"
    return 1
  fi

}

ssh_to_vm() {
  local vm_name="$1"
  local username="${2:-}"
  check_vm "$vm_name" || return 1

  if [[ -z "$vm_name" ]]; then
    fail "VM name not provided. Usage: vm ssh <vm_name> [username]"
    return 1
  fi

  if [[ -z "$username" ]]; then
    fail "Username not provided. Usage: vm ssh $vm_name <username>"
    return 1
  fi

  local state
  state=$(virsh domstate "$vm_name")

  if [[ "$state" != "running" ]]; then
    fail "VM '$vm_name' is not running"
    slog "Start it with: $0 start $vm_name"
    return 1
  fi

  local ip
  ip=$(get_vm_ip "$vm_name")
  local ret=$?
  ip_errors "$ret" "$vm_name"

  slog "Connecting to $vm_name ($ip) as $username..."
  ssh "$username@$ip"
}
