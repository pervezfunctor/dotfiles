#!/usr/bin/env bash
set -euo pipefail

harden_sshd() {
    mkdir -p /etc/ssh/sshd_config.d

    cat >/etc/ssh/sshd_config.d/99-hardening.conf <<EOF
# Enforce modern SSH security settings
Protocol 2
PermitRootLogin no
PasswordAuthentication no
KbdInteractiveAuthentication no
ChallengeResponseAuthentication no
PermitEmptyPasswords no
UsePAM yes
PubkeyAuthentication yes

# Optional: reduce attack surface
X11Forwarding no
AllowAgentForwarding no
AllowTcpForwarding no
AllowStreamLocalForwarding no
AllowUsers *
EOF
}

restart_ssh() {
    if systemctl list-unit-files | grep -q '^sshd.'; then
        systemctl restart sshd
    elif systemctl list-unit-files | grep -q '^ssh.'; then
        systemctl restart ssh
    else
        echo "Warning: SSH service not found."
    fi
}

main() {
    harden_sshd
    restart_ssh
    echo "SSH hardening applied."
}

main
