#!/usr/bin/env bash

set -euo pipefail

# shellcheck disable=SC1091
source "$(dirname "$0")/incus-utils"
# shellcheck disable=SC1091
source "$(dirname "$0")/vt-utils"

ALL_DISTRIBUTIONS=("ubuntu" "fedora" "arch" "debian" "centos" "tumbleweed" "rocky" "alpine")

create_all_vms() {
  # shellcheck disable=SC2034
  local additional_args=("$@")
  create_all_vt "ivm-create" SELECTED_DISTRIBUTIONS additional_args
}

main() {
  if [[ $# -eq 0 ]]; then
    ivm-create --help
    exit 1
  fi
  if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    ivm-create --help
    exit 0
  fi

  # shellcheck disable=SC2034
  mapfile -t SELECTED_DISTRIBUTIONS < <(select_distributions "${ALL_DISTRIBUTIONS[@]}")

  create_all_vms "$@"
}

main "$@"
