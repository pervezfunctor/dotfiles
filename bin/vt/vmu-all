#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/vm-utils"
source "$(dirname "$0")/all-utils"

all_op() {
  local op="$1"
  shift

  slog "Performing operation '$op' on all VMU VMs..."
  echo

  for vm in "${DISTRO_LIST_vmu[@]}"; do
    if virsh --connect qemu:///session dominfo "${vm}-vmu" &>/dev/null; then
      vmu "$op" "${vm}-vmu" "$@"
    else
      warn "VM ${vm}-vmu does not exist, skipping..."
    fi
  done

  echo
  success "Performed operation '$op' on all VMU VMs successfully!"
  echo
}

all_create() {
  slog "Creating 4 user-mode VMs (Ubuntu, Fedora, Arch, Debian)..."
  echo

  for distro in "${DISTRO_LIST_vmu[@]}"; do
    if virsh --connect qemu:///session dominfo "${distro}-vmu" &>/dev/null; then
      warn "$distro VMU already exists, skipping..."
    else
      vmu-create --distro "$distro" --name "${distro}-vmu"
    fi
  done

  echo
  success "All VMU VMs created successfully!"
  slog "You can access them using: vmu ssh <vm-name>"
  echo
}

all_delete() {
  all_op "delete" "$@"
}

all_start() {
  all_op "start" "$@"
}

all_stop() {
  all_op "stop" "$@"
}

all_restart() {
  all_op "restart" "$@"
}

all_exec() {
  all_op "exec" "$@"
}

all_list() {
  slog "Listing all VMU VMs..."
  echo
  vmu list
  echo
}

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTION]

"vmu" {user-mode VMs} for various Linux distributions.

Options:
  create    # Create all "vmu" {user-mode VMs} for various Linux distributions.(default if no option)
  list      # List all "vmu" {user-mode VMs}
  exec      # Execute a command in all "vmu" {user-mode VMs} for various Linux distributions.
  delete    # Delete all "vmu" {user-mode VMs} for various Linux distributions.
  start     # Start all "vmu" {user-mode VMs} for various Linux distributions.
  stop      # Stop all "vmu" {user-mode VMs} for various Linux distributions.
  restart   # Restart all "vmu" {user-mode VMs} for various Linux distributions.
  --help    # Display this help message

Examples:
  $(basename "$0")           # Create {user-mode VMs} for various Linux distributions.or attach if exists
  $(basename "$0") create    # Force create a new set of {user-mode VMs} for various Linux distributions.}
  $(basename "$0") list      # List all {user-mode VMs} for various Linux distributions.
  $(basename "$0") delete    # Delete all {user-mode VMs} for various Linux distributions.}
  $(basename "$0") start     # Start all {user-mode VMs} for various Linux distributions.
  $(basename "$0") stop      # Stop all {user-mode VMs} for various Linux distributions.
  $(basename "$0") restart   # Restart all {user-mode VMs} for various Linux distributions.}
EOF
}

main() {
  # Check if vmu command exists
  if ! has_cmd vmu; then
    fail "vmu command is not available. Please ensure vmu is in your PATH."
    exit 1
  fi

  # Check prerequisites for VMU
  for cmd in virsh trash virt-cat vmu-create; do
    if ! has_cmd "$cmd"; then
      fail "Required command '$cmd' is not available."
      exit 1
    fi
  done

  all_parse_args "$@"
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
