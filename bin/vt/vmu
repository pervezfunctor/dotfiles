#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/vm-utils"

trap 'echo "‚ùå  Error on line $LINENO"; exit 1' ERR

cmd_vmu() {
  virsh --connect qemu:///session "$@"
}

check_prerequisites() {
  for cmd in virsh trash virt-cat vmu-create; do
    if ! has_cmd "$cmd"; then
      echo "Error: Required command '$cmd' is not available."
      exit 1
    fi
  done
}

usage() {
  cat <<EOF
Usage: $0 <command> [vm-name]

Description:
  Manage VMs created with vmu-create script. These are user-mode VMs, not full libvirt VMs.

COMMANDS:
    list                          List all VMs
    create  ARGS                  Create a new VM, see vmu create --help for options
    create-all  ARGS              Create multiple VMs, see vmu-create-multi --help for options
    autostart <vm-name>           Set VM to start on boot
    start <vm-name>               Start a VM
    shutdown <vm-name>            Gracefully stop a VM
    restart <vm-name>             Restart a VM
    kill <vm-name>                Force stop a VM
    delete <vm-name>              Delete a VM completely
    console <vm-name>             Connect to VM console
    ssh <vm-name> [username]      Connect to VM via SSH
    info <vm-name>                Show VM status and info
    logs <vm-name>                Show cloud-init logs
    output-logs <vm-name>         Show cloud-init output logs
    disk <vm-name>                Show VM disk usage
    is-running <vm-name>          Check if VM is running (returns exit code)
    exec <vm-name> <command>      Execute a command inside a running VM
    cmd <virsh-args>              Run virsh command with qemu:///session connection

EXAMPLES:
    $0 list                       # List all VMs
    $0 ssh dev username           # SSH into 'dev' VM with username 'username'
    $0 exec debian "ls -l"        # Execute 'ls -l' command in 'debian' VM
    $0 show-ip debian             # Show IP address of 'debian' VM
    $0 status debian              # Show status of 'debian' VM
    $0 create debian              # Create debian VM
    $0 start debian               # Start 'debian' VM
    $0 delete old-vm              # Delete 'old-vm' completely
EOF
}

disk_vmu() {
  virsh --connect qemu:///session domblklist "$1"
}

status_vmu() {
  virsh --connect qemu:///session dominfo "$1"
}

autostart_vmu() {
  virsh --connect qemu:///session autostart "$1"
}

start_vmu() {
  virsh --connect qemu:///session start "$1"
}

is_running_vmu() {
  virsh --connect qemu:///session domstate "$1" | grep -q "^running$"
}

shutdown_vmu() {
  virsh --connect qemu:///session shutdown "$1"
}

reboot_vmu() {
  virsh --connect qemu:///session reboot "$1"
}

force_stop_vmu() {
  virsh --connect qemu:///session destroy "$1"
}

delete_vmu() {
  local vda
  vda=$(virsh --connect qemu:///session domblklist "$1" | grep vda | awk '{print $2}')

  virsh --connect qemu:///session destroy "$1" >/dev/null 2>&1 || true
  virsh --connect qemu:///session undefine "$1" >/dev/null 2>&1 || true
  virsh --connect qemu:///session managedsave-remove "$1" >/dev/null 2>&1 || true

  if [[ -n "$vda" ]]; then
    dir=$(dirname "$vda")

    echo "Found vm directory: $dir"
    read -p "Delete dir? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      echo "Deleting $dir"
      trash "$dir"
    fi
  fi
  # remove from .vmu-ports
  sed -i "/^$1 /d" "$VMU_PORTS_FILE"
}

logs_vmu() {
  virt-cat --connect qemu:///session -d "$1" /var/log/cloud-init.log
}

output_logs_vmu() {
  virt-cat --connect qemu:///session -d "$1" /var/log/cloud-init-output.log
}

console_vmu() {
  virsh --connect qemu:///session console "$1"
}

ssh_vmu() {
  local VM="$1"
  if [ -z "$VM" ]; then
    echo "Usage: vmu ssh <vm-name>"
    exit 1
  fi

  if [[ ! -f ~/.vmu-ports ]]; then
    echo "No VMs found"
    exit 1
  fi

  local entry
  entry=$(grep -m1 "^$VM " ~/.vmu-ports) || {
    echo "VM $VM not found"
    exit 1
  }

  local port user
  port=$(echo "$entry" | awk '{print $2}')
  user=$(echo "$entry" | awk '{print $3}')

  ssh -p "$port" "$user"@127.0.0.1
}

exec_vmu() {
  local VM="$1"
  local CMD="${*:2}"

  if [ -z "$VM" ] || [ -z "$CMD" ]; then
    echo "Usage: vmu exec <vm-name> <command>"
    exit 1
  fi

  if ! is_running_vmu "$VM"; then
    echo "Error: VM '$VM' is not running"
    exit 1
  fi

  if [[ ! -f ~/.vmu-ports ]]; then
    echo "No VMs found"
    exit 1
  fi

  local entry
  entry=$(grep -m1 "^$VM " ~/.vmu-ports) || {
    echo "VM $VM not found"
    exit 1
  }

  local port user
  port=$(echo "$entry" | awk '{print $2}')
  user=$(echo "$entry" | awk '{print $3}')

  ssh -p "$port" "$user"@127.0.0.1 "$CMD"
}

list_all_vmu() {
  virsh --connect qemu:///session list --all
}

list_vmu() {
  virsh --connect qemu:///session list --all | awk 'NR>2 && $0 !~ /^[-[:space:]]*$/ {print $2}'
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 1
  fi

  check_prerequisites

  local command
  command="$1"
  shift

  case "$command" in
  list | ls)
    list_all_vmu
    ;;
  cmd)
    cmd_vmu "$@"
    ;;
  disk)
    disk_vmu "$@"
    ;;
  info | status)
    status_vmu "$@"
    ;;
  create | new)
    "$(dirname "$0")/vmu-create" "$@"
    ;;
  create-all)
    "$(dirname "$0")/vmu-create-multi" "$@"
    ;;
  autostart)
    handle_multiple_arguments vmu autostart "$@"
    ;;
  start | boot)
    handle_multiple_arguments vmu start "$@"
    ;;
  stop | shutdown)
    handle_multiple_arguments vmu shutdown "$@"
    ;;
  restart | reboot)
    handle_multiple_arguments vmu reboot "$@"
    ;;
  destroy | kill | force-stop)
    handle_multiple_arguments vmu force_stop "$@"
    ;;
  delete | rm)
    handle_multiple_arguments vmu delete "$@"
    ;;
  console)
    console_vmu "$@"
    ;;
  ssh)
    ssh_vmu "$@"
    ;;
  logs)
    logs_vmu "$@"
    ;;
  output-logs)
    output_logs_vmu "$@"
    ;;
  is-running)
    is_running_vmu "$@"
    ;;
  exec)
    exec_vmu "$@"
    ;;
  --help | -h)
    usage
    ;;
  *)
    echo "Error: Unknown command: $command"
    usage
    ;;
  esac
}

main "$@"
