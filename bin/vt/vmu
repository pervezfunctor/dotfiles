#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

source "$(dirname "$0")/vm-utils"
source "$(dirname "$0")/vt-utils"

trap 'echo "‚ùå  Error on line $LINENO"; exit 1' ERR

cmd_vmu() {
  virsh --connect qemu:///session "$@"
}

check_prerequisites() {
  for cmd in virsh trash virt-cat vmu-create; do
    if ! has_cmd "$cmd"; then
      fail "Required command '$cmd' is not available."
      exit 1
    fi
  done
}

usage() {
  cat <<EOF
Usage: $0 <command> [vm-name]

Description:
  Manage VMs created with vmu-create script. These are user-mode VMs, not full libvirt VMs.

COMMANDS:
    list                          List all VMs
    create  ARGS                  Create a new VM, see vmu create --help for options
    create-all  ARGS              Create multiple VMs, see vmu-create-multi --help for options
    autostart <vm-name>           Set VM to start on boot
    start [vm-name...]             Start VM(s) - if no names provided, select from list
    stop [vm-name...]              Gracefully stop VM(s) - if no names provided, select from list
    restart [vm-name...]           Restart VM(s) - if no names provided, select from list
    kill [vm-name...]              Force stop VM(s) - if no names provided, select from list
    delete [vm-name...]            Delete VM(s) completely - if no names provided, select from list
    console [vm-name]              Connect to VM console - if no name provided, select from list
    ssh [vm-name] [username]       Connect to VM via SSH - if no name provided, select from list
    info [vm-name]                 Show VM status and info - if no name provided, select from list
    logs [vm-name]                 Show cloud-init logs - if no name provided, select from list
    output-logs [vm-name]          Show cloud-init output logs - if no name provided, select from list
    disk [vm-name]                 Show VM disk usage - if no name provided, select from list
    is-running [vm-name]           Check if VM is running (returns exit code) - if no name provided, select from list
    exec [vm-name] <command>       Execute a command inside a running VM - if no name provided, select from list
    cmd <virsh-args>              Run virsh command with qemu:///session connection

EXAMPLES:
    $0 list                       # List all VMs
    $0 ssh dev username           # SSH into 'dev' VM with username 'username'
    $0 exec debian "ls -l"        # Execute 'ls -l' command in 'debian' VM
    $0 info debian                # Show status of 'debian' VM
    $0 console                   # Select VM to connect to console from menu
    $0 create debian              # Create debian VM
    $0 start debian               # Start 'debian' VM
    $0 delete old-vm              # Delete 'old-vm' completely
EOF
}

disk_vmu() {
  virsh --connect qemu:///session domblklist "$1"
}

status_vmu() {
  virsh --connect qemu:///session dominfo "$1"
}

autostart_vmu() {
  virsh --connect qemu:///session autostart "$1"
}

start_vmu() {
  virsh --connect qemu:///session start "$1"
}

is-running_vmu() {
  virsh --connect qemu:///session domstate "$1" | grep -q "^running$"
}

stop_vmu() {
  virsh --connect qemu:///session shutdown "$1"
}

restart_vmu() {
  virsh --connect qemu:///session reboot "$1"
}

kill_vmu() {
  virsh --connect qemu:///session destroy "$1"
}

delete_vmu() {
  local vda
  vda=$(virsh --connect qemu:///session domblklist "$1" | grep vda | awk '{print $2}')

  virsh --connect qemu:///session destroy "$1" >/dev/null 2>&1 || true
  virsh --connect qemu:///session undefine "$1" >/dev/null 2>&1 || true
  virsh --connect qemu:///session managedsave-remove "$1" >/dev/null 2>&1 || true

  if [[ -n "$vda" ]]; then
    dir=$(dirname "$vda")

    slog echo "Found vm directory: $dir"
    read -p "Delete dir? (y/N): " -r
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      warn "Deleting $dir"
      trash "$dir"
    fi
  fi
  # remove from .vmu-ports
  sed -i "/^$1 /d" "$VMU_PORTS_FILE"
}

logs_vmu() {
  virt-cat --connect qemu:///session -d "$1" /var/log/cloud-init.log
}

output_logs_vmu() {
  virt-cat --connect qemu:///session -d "$1" /var/log/cloud-init-output.log
}

console_vmu() {
  virsh --connect qemu:///session console "$1"
}

ssh_vmu() {
  local VM="$1"
  local user="${2:-}"

  if [ -z "$VM" ]; then
    info echo "Usage: vmu ssh <vm-name> [username]"
    exit 1
  fi

  if [[ ! -f ~/.vmu-ports ]]; then
    fail "No VMs found"
    exit 1
  fi

  local entry
  entry=$(grep -m1 "^$VM " ~/.vmu-ports) || {
    fail "VM $VM not found"
    exit 1
  }

  local port vm_user
  port=$(echo "$entry" | awk '{print $2}')
  vm_user=$(echo "$entry" | awk '{print $3}')

  # Use provided username if given, otherwise use the one from the ports file
  user="${user:-$vm_user}"

  ssh -p "$port" "$user"@127.0.0.1
}

exec_vmu() {
  local VM="$1"
  shift
  local CMD="$*"

  if [ -z "$VM" ] || [ -z "$CMD" ]; then
    die "Usage: vmu exec <vm-name> <command>"
  fi

  if ! is-running_vmu "$VM"; then
    die "Error: VM '$VM' is not running"
  fi

  if [[ ! -f ~/.vmu-ports ]]; then
    die "No VMs found"
  fi

  local entry
  entry=$(grep -m1 "^$VM " ~/.vmu-ports) || {
    die "VM $VM not found"
  }

  local port user
  port=$(echo "$entry" | awk '{print $2}')
  user=$(echo "$entry" | awk '{print $3}')

  ssh -p "$port" "$user"@127.0.0.1 "$CMD"
}

list_all_vmu() {
  virsh --connect qemu:///session list --all
}

list_vmu() {
  virsh --connect qemu:///session list --all | awk 'NR>2 && $0 !~ /^[-[:space:]]*$/ {print $2}'
}

ip_vmu() {
  warn "This runs on localhost"
  ip -brief a
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    exit 1
  fi

  check_prerequisites

  local command vm_name
  command="$1"
  vm_name="${2:-}"
  shift

  case "$command" in
  list | ls)
    list_all_vmu
    ;;
  cmd)
    cmd_vmu "$@"
    ;;
  disk)
    handle_one_argument vmu disk "$vm_name"
    ;;
  info | status)
    handle_one_argument vmu status "$vm_name"
    ;;
  create | new)
    vmu-create "$@"
    ;;
  create-all)
    vmu-create-multi "$@"
    ;;
  autostart)
    handle_multiple_arguments vmu autostart "$@"
    ;;
  start | boot)
    handle_multiple_arguments vmu start "$@"
    ;;
  stop | shutdown)
    handle_multiple_arguments vmu stop "$@"
    ;;
  restart | reboot)
    handle_multiple_arguments vmu restart "$@"
    ;;
  destroy | kill | force-stop)
    handle_multiple_arguments vmu kill "$@"
    ;;
  delete | rm)
    handle_multiple_arguments vmu delete "$@"
    ;;
  console)
    handle_one_argument vmu console "$vm_name"
    ;;
  ssh)
    handle_one_argument vmu ssh "$vm_name"
    ;;
  logs)
    handle_one_argument vmu logs "$vm_name"
    ;;
  output-logs)
    handle_one_argument vmu output_logs "$vm_name"
    ;;
  is-running)
    handle_one_argument vmu is-running "$vm_name"
    ;;
  exec)
    handle_one_argument vmu exec "$vm_name"
    ;;
  --help | -h)
    usage
    ;;
  *)
    fail "Error: Unknown command: $command"
    usage
    ;;
  esac
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
