#! /usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail

export DOT_DIR=${DOT_DIR:-$HOME/.ilm}
source "$DOT_DIR/share/utils"

enable_password_auth() {
    local port="${1:-2222}"

    local tmp
    tmp="$(mktemp)"

    cat >"$tmp" <<EOF
Port $port
PermitRootLogin no
PasswordAuthentication yes
PubkeyAuthentication yes
EOF

    mkdir -p /etc/ssh/sshd_config.d
    local file="/etc/ssh/sshd_config.d/99-password.conf"
    if ! cmp -s "$tmp" "$file"; then
        sudo cp -f "$tmp" "$file"
    fi

    rm -f "$tmp"
}

main () {
    local port="${1}"
    enable_password_auth "$port"
}

main "$@"
