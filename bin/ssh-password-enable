#!/usr/bin/env bash

set -euo pipefail

SSHD_CONFIG="/etc/ssh/sshd_config"
BACKUP="/etc/ssh/sshd_config.bak.$(date +%F-%H%M%S)"

echo "[INFO] Backing up $SSHD_CONFIG to $BACKUP"
sudo cp -a "$SSHD_CONFIG" "$BACKUP"

sudo chmod u+w "$SSHD_CONFIG"

if grep -qE '^[#[:space:]]*PasswordAuthentication' "$SSHD_CONFIG"; then
    echo "[INFO] Updating existing PasswordAuthentication directive..."
    sudo sed -i 's/^[#[:space:]]*PasswordAuthentication.*/PasswordAuthentication yes/' "$SSHD_CONFIG"
else
    echo "[INFO] Adding PasswordAuthentication directive..."
    echo "PasswordAuthentication yes" | sudo tee -a "$SSHD_CONFIG" >/dev/null
fi

# Ensure ChallengeResponseAuthentication is disabled for password login
if grep -qE '^[#[:space:]]*ChallengeResponseAuthentication' "$SSHD_CONFIG"; then
    sudo sed -i 's/^[#[:space:]]*ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' "$SSHD_CONFIG"
else
    echo "ChallengeResponseAuthentication no" | sudo tee -a "$SSHD_CONFIG" >/dev/null
fi

# Restore correct permissions
sudo chmod 644 "$SSHD_CONFIG"

echo "[INFO] Restarting SSH service..."
if command -v systemctl >/dev/null 2>&1; then
    sudo systemctl restart sshd || sudo systemctl restart ssh
else
    sudo service ssh restart || sudo service sshd restart
fi

echo "[SUCCESS] Password authentication has been enabled."
