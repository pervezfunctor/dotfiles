#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

export DOT_DIR=${DOT_DIR:-"$HOME/.ilm"}

# shellcheck disable=SC1091
source "${DOT_DIR}/share/utils"

readonly HOMEBREW_DIR="/var/home/linuxbrew"
readonly BREW_PREFIX="$HOMEBREW_DIR/.linuxbrew"
readonly PROFILE_FILE="/etc/profile.d/homebrew.sh"

get_user_info() {
  local user_name
  user_name=${SUDO_USER:-$(logname 2>/dev/null || echo "$USER")}

  if ! id -u "$user_name" >/dev/null 2>&1; then
    die "User '$user_name' does not exist"
  fi

  echo "$user_name"
}

setup_homebrew_directory() {
  local user_name="$1"

  slog "Setting up Homebrew directory: $HOMEBREW_DIR"

  if [[ ! -d "$HOMEBREW_DIR" ]]; then
    sudo mkdir -p "$HOMEBREW_DIR" || die "Failed to create Homebrew directory"
    slog "Created Homebrew directory"
  else
    slog "Homebrew directory already exists"
  fi

  sudo chown -R "$user_name":"$user_name" "$HOMEBREW_DIR" ||
    die "Failed to set directory ownership"

  success "Homebrew directory ready"
}

install_homebrew() {
  local user_name="$1"

  slog "Installing Homebrew for user: $user_name"

  if [[ -x "$BREW_PREFIX/bin/brew" ]]; then
    slog "Homebrew already installed"
  else
    slog "Cloning Homebrew repository"

    sudo -u "$user_name" bash -c "
      set -euo pipefail
      git clone --depth=1 https://github.com/Homebrew/brew \"$BREW_PREFIX\"
    " || die "Failed to clone Homebrew"
  fi

  slog "Updating Homebrew"

  sudo -u "$user_name" bash -c "
    set -euo pipefail
    eval \"\$($BREW_PREFIX/bin/brew shellenv)\"
    brew update --quiet
  " || die "Failed to update Homebrew"

  success "Homebrew installation complete"
}

setup_profile_snippet() {
  slog "Configuring profile snippet: $PROFILE_FILE"

  local snippet="eval \"\$($BREW_PREFIX/bin/brew shellenv)\""

  # If file exists and contains correct snippet, skip
  if sudo test -f "$PROFILE_FILE"; then
    if sudo grep -Fq "$snippet" "$PROFILE_FILE"; then
      slog "Profile snippet already exists"
      return 0
    fi
    slog "Updating existing snippet"
  fi

  # Write snippet
  echo "$snippet" | sudo tee "$PROFILE_FILE" >/dev/null ||
    die "Failed to write profile snippet"

  sudo chmod 644 "$PROFILE_FILE"

  success "Profile snippet installed"
}

verify_installation() {
  local user_name="$1"

  slog "Verifying Homebrew installation"

  sudo -u "$user_name" bash -c "
    set -euo pipefail
    source \"$PROFILE_FILE\"
    brew --version >/dev/null
  " || die "Homebrew verification failed"

  success "Homebrew verification successful"
}

main() {
  slog "Starting Homebrew installation"

  has_cmd git

  local user_name
  user_name=$(get_user_info)

  setup_homebrew_directory "$user_name"
  install_homebrew "$user_name"
  setup_profile_snippet
  verify_installation "$user_name"

  success "Homebrew installed at $BREW_PREFIX"
  slog "Logout/login or source your shell to activate brew."
}

is_std_atomic || die "Not an atomic system. Exiting."
main "$@"
