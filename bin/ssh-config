#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="${HOME}/.ssh/config"

SCRIPT="$(basename "$0")"

echo "$SCRIPT"

usage() {
  printf "Usage:\n"
  printf "  %s list\n" "$SCRIPT"
  printf "  %s add --host <host> --user <user> [--port <port>] [--identity <identity_file>]\n" "$SCRIPT"
  printf "  %s remove <host>\n" "$SCRIPT"
  printf "\n"
  printf "Examples:\n"
  printf "  %s list\n" "$SCRIPT"
  printf "  %s add --host myvm --user ubuntu --port 22 --identity ~/.ssh/id_rsa\n" "$SCRIPT"
  printf "  %s remove myvm\n" "$SCRIPT"
  exit 1
}

ensure_config_file() {
  mkdir -p "${HOME}/.ssh"
  touch "$CONFIG_FILE"

  if ! grep -qE "^Include[[:space:]]+~/.ssh/conf.d/*.conf$" "$CONFIG_FILE"; then
    echo "Include ~/.ssh/conf.d/*.conf" >>"$CONFIG_FILE"
  fi
}

list_configs() {
  awk '
      /^Host[[:space:]]+/ {
          host=$2
          print host
      }
    ' "$CONFIG_FILE"
}

host_exists() {
  grep -qE "^Host[[:space:]]+$1\$" "$CONFIG_FILE"
}

add_config() {
  local host="$1"
  local user="$2"
  local port="${3:-22}"
  local identity="${4:-}"

  if host_exists "$host"; then
    printf "Host '%s' already exists. Skipping (idempotent).\n" "$host"
    return 0
  fi

  {
    echo ""
    echo "Host $host"
    echo "    HostName $host"
    echo "    User $user"
    echo "    Port $port"
    echo "    IdentitiesOnly yes"
    if [[ -n "$identity" ]]; then
      echo "    IdentityFile $identity"
    fi
  } >>"$CONFIG_FILE"

  printf "Added host '%s'.\n" "$host"
}

remove_config() {
  local host="$1"

  if ! host_exists "$host"; then
    printf "Host '%s' not found. Skipping (idempotent).\n" "$host"
    return 0
  fi

  # Remove entire Host block (Host line + indented lines following)
  # until next Host or EOF.
  awk -v h="$host" '
      BEGIN {skip=0}
      $0 ~ "^Host[[:space:]]+"h"$" { skip=1; next }
      /^Host[[:space:]]+/ { skip=0 }
      skip==1 { next }
      { print }
    ' "$CONFIG_FILE" >"${CONFIG_FILE}.tmp"

  mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

  printf "Removed host '%s'.\n" "$host"
}

main() {
  ensure_config_file

  case "${1:-}" in
  ls | list)
    list_configs
    ;;
  add)
    local host=""
    local user=""
    local port="22"
    local identity=""

    shift
    while [[ $# -gt 0 ]]; do
      case "$1" in
      --host)
        host="$2"
        shift 2
        ;;
      --user)
        user="$2"
        shift 2
        ;;
      --port)
        port="$2"
        shift 2
        ;;
      --identity)
        identity="$2"
        shift 2
        ;;
      *)
        usage
        ;;
      esac
    done

    if [[ -z "$host" || -z "$user" ]]; then
      usage
    fi

    add_config "$host" "$user" "$port" "$identity"
    ;;
  remove)
    [[ $# -ne 2 ]] && usage
    remove_config "$2"
    ;;
  *)
    usage
    ;;
  esac
}

main "$@"
