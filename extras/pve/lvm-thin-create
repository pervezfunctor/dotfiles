#!/bin/bash
set -euo pipefail -o errtrace

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print colored output
print_step() {
  echo -e "${BLUE}==>${NC} ${CYAN}$1${NC}"
}

print_success() {
  echo -e "${GREEN}✅${NC} $1"
}

print_error() {
  echo -e "${RED}❌ Error:${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}⚠️ Warning:${NC} $1"
}

print_header() {
  local text="$1"
  local width=61
  local padding=$(((width - ${#text}) / 2))
  local formatted_text
  formatted_text=$(printf "%*s%s%*s" $padding "" "$text" $((width - padding - ${#text})) "")
  echo -e "${PURPLE}╭─────────────────────────────────────────────────────────────╮${NC}"
  echo -e "${PURPLE}│${NC}$(printf "%-61s" "$formatted_text")${PURPLE}│${NC}"
  echo -e "${PURPLE}╰─────────────────────────────────────────────────────────────╯${NC}"
}

usage() {
  echo -e "${PURPLE}Usage:${NC} $0 --disk /dev/sdX --name NAME"
  echo -e "${PURPLE}Options:${NC}"
  echo "  --disk, -d  Path to the disk (e.g., /dev/sdX)"
  echo "  --name, -n  Name for the LVM volume group and thin pool"
}

parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    --disk)
      DISK="$2"
      shift 2
      ;;
    --name)
      NAME="$2"
      shift 2
      ;;
    *)
      print_error "Unknown option: $1"
      usage
      exit 1
      ;;
    esac
  done
}

main() {
  parse_args "$@"

  if ! [ -b "$DISK" ]; then
    print_error "$DISK is not a block device"
    exit 1
  fi

  if pvs | grep -q "$DISK"; then
    print_error "$DISK already in use as a PV"
    exit 1
  fi

  local VG="vg_$NAME"
  local THIN="thin_$NAME"

  print_header "LVM Thin Pool Creation"
  echo

  print_step "Checking disk: $DISK"
  print_success "Disk is available and ready"
  echo

  print_step "Wiping disk: $DISK"
  wipefs -a "$DISK"
  sgdisk --zap-all "$DISK"
  print_success "Disk wiped successfully"
  echo

  print_step "Creating LVM PV, VG, and thin pool..."
  pvcreate "$DISK"
  print_success "Physical volume created"
  vgcreate "$VG" "$DISK"
  print_success "Volume group '$VG' created"
  lvcreate -L 100%FREE --thinpool "$THIN" "$VG"
  print_success "Thin pool '$THIN' created"
  echo

  print_step "Adding to Proxmox storage configuration..."
  pvesm add lvmthin "$NAME" --vgname "$VG" --thinpool "$THIN" --content rootdir,images
  print_success "Storage '$NAME' added to Proxmox"
  echo

  print_header "LVM Thin Pool Created Successfully!"
  echo -e "${GREEN}✅${NC} LVM Thin pool '${YELLOW}$NAME${NC}' created on ${YELLOW}$DISK${NC}"
  echo -e "${BLUE}Volume Group:${NC} $VG"
  echo -e "${BLUE}Thin Pool:${NC} $THIN"
  echo -e "${BLUE}Storage Name:${NC} $NAME"
}

main "$@"
