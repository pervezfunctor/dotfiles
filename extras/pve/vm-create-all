#!/usr/bin/env bash

set -euo pipefail

SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
readonly SCRIPT_NAME

# Source utils for shared functions
SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
# shellcheck disable=SC1091
source "$SCRIPT_DIR/utils"

# Logging functions
log_info() {
  echo "â„¹ï¸  [INFO] $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_warn() {
  echo "âš ï¸  [WARN] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
}

log_error() {
  echo "âŒ [ERROR] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
}

log_success() {
  echo "âœ… [SUCCESS] $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

# Template ID mapping
declare -A TEMPLATE_MAPPING=(
  ["debian"]="201"
  ["fedora"]="202"
  ["ubuntu"]="203"
  ["alpine"]="204"
  ["centos"]="205"
  ["tumbleweed"]="206"
  ["arch"]="207"
)

# Default values
DEFAULT_START_VM_ID=111
DEFAULT_VM_NAME="{distro}-vm"

# Display usage information
display_usage() {
  cat <<EOF
ðŸš€ Usage: $SCRIPT_NAME [OPTIONS]

ðŸ“‹ Description:
  Creates VMs from all available VM templates using the qm clone command.
  Supported distributions: debian, fedora, ubuntu, alpine, centos, tumbleweed, arch

ðŸ“‹ Options:
  -s, --storage STORAGE            ðŸ’¾ Proxmox storage target for cloned VMs
  -i, --start-vm-id START_VM_ID    ðŸ”¢ Starting VM ID (default: $DEFAULT_START_VM_ID)
  -f, --failed-only                 ðŸš¨ Only create VMs for distributions that failed previously
  -l, --list                        ðŸ“‹ List supported distributions and their template/VM ID mappings
  -n, --name NAME                   ðŸ·ï¸  Custom name pattern for VMs (default: $DEFAULT_VM_NAME)
  -c, --cpu CORES                  ðŸ”§ Number of CPU cores
  -m, --memory MEMORY              ðŸ’¾ Memory size in MB
  -d, --disk-size SIZE             ðŸ’¿ Disk size in GB
  -u, --username USERNAME          ðŸ‘¤ Cloud-init username
  -p, --password PASSWORD          ðŸ” Cloud-init password
  -k, --ssh-key SSH_KEY            ðŸ”‘ SSH public key for cloud-init
  -h, --help                        â“ Display this help message

ðŸ“ Examples:
  $SCRIPT_NAME                                    # Create all VMs with defaults
  $SCRIPT_NAME -i 121                             # Create all VMs starting from VM ID 121
  $SCRIPT_NAME -s local-zfs -i 151                # Use custom storage and start from VM ID 151
  $SCRIPT_NAME -f                                 # Only retry failed distributions
  $SCRIPT_NAME -n "my-{distro}-vm"                # Create all VMs with custom name pattern
  $SCRIPT_NAME -c 4 -m 4096 -d 32               # Create all VMs with 4 cores, 4GB RAM, 32GB disk
  $SCRIPT_NAME --list                             # List template/VM ID mappings

EOF
}

# Parse command line arguments
parse_arguments() {
  PROXMOX_STORAGE=""
  START_VM_ID="$DEFAULT_START_VM_ID"
  FAILED_ONLY=false
  LIST_ONLY=false
  CPU_CORES=""
  MEMORY_SIZE=""
  DISK_SIZE=""
  USERNAME=""
  PASSWORD=""
  SSH_KEY=""
  VM_NAME=""

  while [[ "$#" -gt 0 ]]; do
    case $1 in
    -s | --storage)
      PROXMOX_STORAGE="$2"
      shift 2
      ;;
    -i | --start-vm-id)
      START_VM_ID="$2"
      shift 2
      ;;
    -f | --failed-only)
      FAILED_ONLY=true
      shift
      ;;
    -l | --list)
      LIST_ONLY=true
      shift
      ;;
    -n | --name)
      VM_NAME="$2"
      shift 2
      ;;
    -c | --cpu)
      CPU_CORES="$2"
      shift 2
      ;;
    -m | --memory)
      MEMORY_SIZE="$2"
      shift 2
      ;;
    -d | --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    -u | --username)
      USERNAME="$2"
      shift 2
      ;;
    -p | --password)
      PASSWORD="$2"
      shift 2
      ;;
    -k | --ssh-key)
      SSH_KEY="$2"
      shift 2
      ;;
    -h | --help)
      display_usage
      exit 0
      ;;
    *)
      log_error "Unknown parameter: $1"
      display_usage
      exit 1
      ;;
    esac
  done
}

# List supported distributions and their template/VM ID mappings
list_distributions() {
  echo "ðŸ“‹ Supported distributions and their template/VM ID mappings:"
  echo ""
  echo "  Starting VM ID: $START_VM_ID (VMs will be assigned incrementally)"
  echo ""

  local vm_id=$START_VM_ID
  for distro in "${!TEMPLATE_MAPPING[@]}"; do
    local template_id="${TEMPLATE_MAPPING[$distro]}"
    echo "  ðŸ§ $distro (Template ID: $template_id â†’ VM ID: $vm_id)"
    ((vm_id++))
  done
  echo ""
}

# Check if a VM template exists
template_exists() {
  local distro="$1"
  local template_id="${TEMPLATE_MAPPING[$distro]}"

  if qm list 2>/dev/null | awk -v id="$template_id" '$1 == id { found=1 } END { exit !found }'; then
    return 0
  else
    return 1
  fi
}

# Get distributions to process
get_distributions_to_process() {
  local distributions_to_process=()
  local vm_id=$START_VM_ID

  if [[ "$FAILED_ONLY" == "true" ]]; then
    # Only include distributions that don't have VMs yet but have templates
    for distro in "${!TEMPLATE_MAPPING[@]}"; do
      if template_exists "$distro" && ! vm_exists "$vm_id"; then
        distributions_to_process+=("$distro")
      fi
      ((vm_id++))
    done
  else
    # Include all supported distributions that have templates
    for distro in "${!TEMPLATE_MAPPING[@]}"; do
      if template_exists "$distro"; then
        distributions_to_process+=("$distro")
      fi
      ((vm_id++))
    done
  fi

  echo "${distributions_to_process[@]}"
}

# Create VM for a single distribution by delegating to vm-create script
create_vm() {
  local distro="$1"
  local vm_id="$2"
  local template_id="${TEMPLATE_MAPPING[$distro]}"
  local vm_create_script="$SCRIPT_DIR/vm-create"

  # Prepare VM name with placeholder replacement
  local vm_name="${VM_NAME:-$DEFAULT_VM_NAME}"
  vm_name="${vm_name//\{distro\}/$distro}"
  vm_name="${vm_name//\{vm_id\}/$vm_id}"

  log_info "Creating VM for $distro from template $template_id..."

  # Build the vm-create command with all appropriate parameters
  local vm_create_cmd=("$vm_create_script" "--template-id" "$template_id" "--vm-id" "$vm_id")

  # Add optional parameters if they are set
  [[ -n "$PROXMOX_STORAGE" ]] && vm_create_cmd+=(-s "$PROXMOX_STORAGE")
  [[ -n "$vm_name" ]] && vm_create_cmd+=(-n "$vm_name")
  [[ -n "$CPU_CORES" ]] && vm_create_cmd+=(-c "$CPU_CORES")
  [[ -n "$MEMORY_SIZE" ]] && vm_create_cmd+=(-m "$MEMORY_SIZE")
  [[ -n "$DISK_SIZE" ]] && vm_create_cmd+=(-d "$DISK_SIZE")
  [[ -n "$USERNAME" ]] && vm_create_cmd+=(-u "$USERNAME")
  [[ -n "$PASSWORD" ]] && vm_create_cmd+=(-p "$PASSWORD")
  [[ -n "$SSH_KEY" ]] && vm_create_cmd+=(-k "$SSH_KEY")

  # Execute the vm-create script with all parameters
  if "${vm_create_cmd[@]}"; then
    log_success "$distro VM created successfully (ID: $vm_id)"
    return 0
  else
    log_error "Failed to create $distro VM"
    return 1
  fi
}

# Main function
main() {
  echo "ðŸš€ Starting VM creation from all templates"

  parse_arguments "$@"

  if [[ "$LIST_ONLY" == "true" ]]; then
    list_distributions
    exit 0
  fi

  # Check prerequisites
  if ! command -v qm >/dev/null 2>&1; then
    log_error "The 'qm' command is required. This script must be run on a Proxmox host."
    exit 1
  fi

  # Detect storage if not specified
  if [[ -z "$PROXMOX_STORAGE" ]]; then
    log_info "No storage specified, detecting suitable storage..."
    if ! storage=$(detect_storage); then
      log_error "Failed to detect suitable storage"
      exit 1
    fi
    PROXMOX_STORAGE="$storage"
    log_info "Auto-detected storage: $storage"
  fi

  local distributions_to_process
  read -ra distributions_to_process <<<"$(get_distributions_to_process)"

  if [[ ${#distributions_to_process[@]} -eq 0 ]]; then
    log_info "No distributions to process. This could mean:"
    log_info "  - No templates exist yet (run vm-templates-create-all first)"
    log_info "  - All VMs have already been created"
    log_info "  - Use --list to see available templates and VMs"
    exit 0
  fi

  log_info "Processing distributions: ${distributions_to_process[*]}"

  local failed_distributions=()
  local successful_distributions=()
  local vm_id=$START_VM_ID

  for distro in "${distributions_to_process[@]}"; do
    if ! template_exists "$distro"; then
      log_warn "$distro template does not exist, skipping..."
      ((vm_id++))
      continue
    fi

    if vm_exists "$vm_id"; then
      log_warn "$distro VM already exists (ID: $vm_id), skipping..."
      ((vm_id++))
      continue
    fi

    if create_vm "$distro" "$vm_id"; then
      successful_distributions+=("$distro")
    else
      failed_distributions+=("$distro")
    fi

    ((vm_id++))
    echo "" # Add spacing between distributions
  done

  # Summary
  echo "ðŸ“Š Summary:"
  if [[ ${#successful_distributions[@]} -gt 0 ]]; then
    log_success "Successfully created VMs for: ${successful_distributions[*]}"
  fi

  if [[ ${#failed_distributions[@]} -gt 0 ]]; then
    log_error "Failed to create VMs for: ${failed_distributions[*]}"
    echo ""
    log_info "You can retry only the failed distributions with:"
    log_info "  $SCRIPT_NAME -f"
    exit 1
  fi

  log_success "All VMs created successfully!"
}

# Execute main function if script is run directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
