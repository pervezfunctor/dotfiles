#!/usr/bin/env bash

set -euo pipefail -o errtrace

# Default configuration
DEFAULT_GROUP="admins"
DEFAULT_LOGFILE="/var/log/create-proxmox-user.log"
DEFAULT_SSH_CONFIG="/etc/ssh/sshd_config"
DRY_RUN=false
ROLLBACK_FILE=""

# Global variables for rollback
ROLLBACK_ACTIONS=()

# Initialize LOGFILE later after parsing arguments

log() { echo "[$(date '+%F %T')] [INFO] â„¹ï¸  $*"; }
warn() { echo "[$(date '+%F %T')] [WARN] âš ï¸  $*" >&2; }
error() {
  echo "[$(date '+%F %T')] [ERROR] âŒ $*" >&2
  if [[ -n "$ROLLBACK_FILE" ]]; then
    rollback_changes
  fi
  exit 1
}

dry_run_log() {
  if "$DRY_RUN"; then
    echo "[$(date '+%F %T')] [DRY-RUN] ğŸ” $*"
  fi
}

add_rollback_action() {
  local action="$1"
  ROLLBACK_ACTIONS+=("$action")
  if [[ -n "$ROLLBACK_FILE" ]]; then
    echo "$action" >>"$ROLLBACK_FILE"
  fi
}

rollback_changes() {
  log "Initiating rollback due to error... ğŸ”„"
  for action in "${ROLLBACK_ACTIONS[@]}"; do
    log "Rolling back: $action"
    eval "$action" 2>/dev/null || warn "Failed to rollback: $action"
  done
  log "Rollback completed. âš ï¸"
}

usage() {
  cat <<EOF
Usage: $0 <username> [OPTIONS]

Required:
  username        Username for the new user

Options:
  --admin         Grant full Administrator privileges
  --auditor       Grant Auditor (read-only) privileges (default)
  --group NAME    Set group name (default: $DEFAULT_GROUP)
  --ssh-key FILE  Add SSH key from file (disables password auth for user)
  --password-auth Enable password authentication (default: yes)
  --no-ssh-config Skip SSH configuration changes
  --dry-run       Show what would be done without making changes
  --logfile FILE  Log to specific file (default: $DEFAULT_LOGFILE)
  --help          Show this help message

Privilege levels:
  --admin         Full Administrator access
  --auditor       Read-only Auditor access
  --user          Basic user access (no special privileges)

Examples:
  $0 myuser --admin
  $0 myuser --auditor --ssh-key ~/.ssh/id_rsa.pub
  $0 myuser --group developers --no-ssh-config
EOF
  exit 1
}

validate_username() {
  local username="$1"

  # Check if username is provided
  if [[ -z "$username" ]]; then
    error "Username cannot be empty."
  fi

  # Check username format (alphanumeric, underscores, hyphens, no spaces)
  if [[ ! "$username" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    error "Invalid username format. Only alphanumeric characters, underscores, and hyphens are allowed."
  fi

  # Check username length
  if [[ ${#username} -lt 3 || ${#username} -gt 32 ]]; then
    error "Username must be between 3 and 32 characters."
  fi

  # Check if username starts with a letter or underscore
  if [[ ! "$username" =~ ^[a-zA-Z_] ]]; then
    error "Username must start with a letter or underscore."
  fi

  # Check if username is a reserved name
  local reserved_names=("root" "admin" "daemon" "bin" "sys" "sync" "games" "man" "lp" "mail" "news" "uucp" "proxy" "www-data" "backup" "list" "irc" "gnats" "nobody" "systemd-network" "systemd-resolve" "syslog" "messagebus" "uuidd" "dnsmasq" "usbmux" "rtkit" "pulse" "speech-dispatcher" "avahi" "saned" "colord" "hplip" "geoclue" "gnome-initial-setup" "gdm")
  for reserved in "${reserved_names[@]}"; do
    if [[ "$username" == "$reserved" ]]; then
      error "Username '$username' is reserved and cannot be used."
    fi
  done
}

check_root() {
  if ! "$DRY_RUN" && [[ $EUID -ne 0 ]]; then
    error "Must be run as root."
  elif "$DRY_RUN" && [[ $EUID -ne 0 ]]; then
    warn "Dry-run mode: Not checking for root privileges."
  fi
}

ensure_group() {
  local group="$1"
  if ! pveum group list | awk '{print $1}' | grep -qx "$group"; then
    dry_run_log "Creating Proxmox group '$group'. ğŸ‘¥"
    if ! "$DRY_RUN"; then
      pveum groupadd "$group" -comment "Administrative users"
      add_rollback_action "pveum groupdel $group 2>/dev/null || true"
    fi
  else
    log "Group '$group' already exists. âœ…"
  fi
}

create_system_user() {
  local user="$1"
  local ssh_key_file="$2"
  local password_auth="$3"

  if ! id "$user" &>/dev/null; then
    dry_run_log "Creating system user '$user'. ğŸ‘¤"
    if ! "$DRY_RUN"; then
      useradd -m -s /bin/bash "$user"
      add_rollback_action "userdel -r $user 2>/dev/null || true"

      if [[ -n "$ssh_key_file" ]]; then
        # Setup SSH key authentication
        local user_home="/home/$user"
        local ssh_dir="$user_home/.ssh"
        mkdir -p "$ssh_dir"
        chmod 700 "$ssh_dir"
        cp "$ssh_key_file" "$ssh_dir/authorized_keys"
        chmod 600 "$ssh_dir/authorized_keys"
        chown -R "$user:$user" "$ssh_dir"

        # Disable password for this user if SSH key is provided
        passwd -l "$user" 2>/dev/null || true
        log "SSH key added and password disabled for '$user'. ğŸ”"
      elif "$password_auth"; then
        # Prompt for password
        log "Setting password for '$user'. Please enter a secure password."
        passwd "$user"
      else
        # Lock the account if no password auth and no SSH key
        passwd -l "$user" 2>/dev/null || true
        log "Account '$user' created but locked. No authentication method enabled. âš ï¸"
      fi
    fi
  else
    log "System user '$user' already exists. âœ…"
  fi
}

create_proxmox_user() {
  local user="$1"
  local group="$2"

  if ! pveum user list | awk '{print $1}' | grep -qx "${user}@pam"; then
    dry_run_log "Creating Proxmox user '${user}@pam'. ğŸ”"
    if ! "$DRY_RUN"; then
      pveum useradd "${user}@pam" -comment "PAM user for Proxmox"
      add_rollback_action "pveum userdel ${user}@pam 2>/dev/null || true"
    fi
  else
    log "Proxmox user '${user}@pam' already exists. âœ…"
  fi

  # Add user to group
  dry_run_log "Adding '${user}@pam' to group '$group'."
  if ! "$DRY_RUN"; then
    pveum usermod "${user}@pam" -group "$group"
  fi
}

assign_privileges() {
  local user="$1"
  local privilege="$2"

  case "$privilege" in
  "admin")
    dry_run_log "Assigning Administrator privileges. ğŸ‘‘"
    if ! "$DRY_RUN"; then
      pveum aclmod / -user "${user}@pam" -role Administrator
    fi
    ;;
  "auditor")
    dry_run_log "Assigning Auditor (read-only) privileges. ğŸ‘ï¸"
    if ! "$DRY_RUN"; then
      pveum aclmod / -user "${user}@pam" -role PVEAuditor
    fi
    ;;
  "user")
    dry_run_log "Assigning basic user privileges. ğŸ‘¤"
    if ! "$DRY_RUN"; then
      pveum aclmod / -user "${user}@pam" -role PVEUser
    fi
    ;;
  *)
    error "Unknown privilege level: $privilege"
    ;;
  esac
}

configure_ssh() {
  local user="$1"
  local ssh_key_file="$2"
  local password_auth="$3"
  local conf="$DEFAULT_SSH_CONFIG"
  local backup
  backup="${conf}.backup.$(date +%Y%m%d_%H%M%S)"

  dry_run_log "Creating backup of SSH config at $backup ğŸ’¾"
  if ! "$DRY_RUN"; then
    cp "$conf" "$backup"
    add_rollback_action "mv $backup $conf 2>/dev/null || true"
  fi

  dry_run_log "Hardening SSH configuration. ğŸ”’"
  if ! "$DRY_RUN"; then
    # Disable root login
    sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' "$conf"

    # Configure password authentication based on settings
    if [[ -n "$ssh_key_file" ]] && ! "$password_auth"; then
      sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' "$conf"
      log "Password authentication disabled for SSH. ğŸ”’"
    else
      sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' "$conf"
      log "Password authentication enabled for SSH. ğŸ”“"
    fi

    # Configure AllowUsers
    if ! grep -q "^AllowUsers" "$conf"; then
      echo "AllowUsers $user" >>"$conf"
    elif ! grep -q "$user" "$conf"; then
      sed -i "s/^AllowUsers.*/& $user/" "$conf"
    fi

    # Restart SSH service
    if systemctl reload ssh 2>/dev/null; then
      log "Reloaded SSH service. ğŸ”„"
    else
      systemctl restart ssh
      log "Restarted SSH service. ğŸ”„"
    fi
  fi
}

main() {
  # Default values
  local privilege="auditor"
  local group="$DEFAULT_GROUP"
  local ssh_key_file=""
  local password_auth=true
  local configure_ssh_setting=true

  # Parse command line arguments
  while [[ $# -gt 0 ]]; do
    case $1 in
    --admin)
      privilege="admin"
      shift
      ;;
    --auditor)
      privilege="auditor"
      shift
      ;;
    --user)
      privilege="user"
      shift
      ;;
    --group)
      group="$2"
      shift 2
      ;;
    --ssh-key)
      ssh_key_file="$2"
      if [[ ! -f "$ssh_key_file" ]]; then
        error "SSH key file not found: $ssh_key_file"
      fi
      password_auth=false
      shift 2
      ;;
    --password-auth)
      password_auth=true
      shift
      ;;
    --no-password-auth)
      password_auth=false
      shift
      ;;
    --no-ssh-config)
      configure_ssh_setting=false
      shift
      ;;
    --dry-run)
      DRY_RUN=true
      shift
      ;;
    --logfile)
      LOGFILE="$2"
      shift 2
      ;;
    --help)
      usage
      ;;
    -*)
      error "Unknown option: $1"
      ;;
    *)
      if [[ -z "${username:-}" ]]; then
        username="$1"
      else
        error "Multiple usernames provided. Only one username is allowed."
      fi
      shift
      ;;
    esac
  done

  # Check if username is provided
  if [[ -z "${username:-}" ]]; then
    usage
  fi

  # Setup logging after parsing arguments
  exec > >(tee -a "$LOGFILE") 2>&1

  # Setup rollback file
  if ! "$DRY_RUN"; then
    ROLLBACK_FILE="/tmp/proxmox-user-rollback-$(date +%Y%m%d_%H%M%S).sh"
    echo "#!/bin/bash" >"$ROLLBACK_FILE"
    chmod +x "$ROLLBACK_FILE"
    log "Rollback file created: $ROLLBACK_FILE"
  fi

  check_root
  validate_username "$username"
  log "Starting user setup for '$username' (privilege=$privilege, group=$group). ğŸš€"

  ensure_group "$group"
  create_system_user "$username" "$ssh_key_file" "$password_auth"
  create_proxmox_user "$username" "$group"
  assign_privileges "$username" "$privilege"

  if "$configure_ssh_setting"; then
    configure_ssh "$username" "$ssh_key_file" "$password_auth"
  fi

  # Clear rollback file on success
  if [[ -n "$ROLLBACK_FILE" ]]; then
    rm -f "$ROLLBACK_FILE"
  fi

  log "User '$username' created successfully. ğŸ‰"
  case "$privilege" in
  "admin")
    log "Privileges: Full Administrator ğŸ‘‘"
    ;;
  "auditor")
    log "Privileges: Auditor (read-only) ğŸ‘ï¸"
    ;;
  "user")
    log "Privileges: Basic User ğŸ‘¤"
    ;;
  esac
  log "Login via SSH or Web UI as '${username}@pam'. ğŸ”‘"
  if "$configure_ssh_setting"; then
    log "Root SSH login disabled. See $LOGFILE for details. ğŸ“"
  fi
}

main "$@"
