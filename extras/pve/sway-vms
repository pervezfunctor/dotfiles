#!/usr/bin/env bash
# sway-vms - Open SSH connections to Proxmox VMs in Sway terminal windows
# Usage: sway-vms [OPTIONS] <vmid1> [vmid2] ...
#
# Environment Variables:
#   SWAY_CONFIG    Path to Sway config file (default: ~/.config/sway/config)
#   SSH_USER       Default SSH username (default: pervez)
#   SSH_PORT       Default SSH port (default: 22)
#   SSH_KEY        Path to SSH private key (default: none)
#   TERMINAL       Terminal emulator to use (default: auto-detect)
#   LAYOUT         Terminal layout: splitv, splith, tabbed, grid (default: splitv)
#
# Examples:
#   sway-vms 100 101 102                    # Connect to VMs 100, 101, 102
#   SSH_USER=admin sway-vms 100             # Connect as admin user
#   LAYOUT=grid sway-vms 100 101            # Use grid layout
#   SSH_KEY=~/.ssh/id_rsa sway-vms 100     # Use specific SSH key

set -euo pipefail -o errtrace

# Default configuration
DEFAULT_SSH_USER="${SSH_USER:-pervez}"
DEFAULT_SSH_PORT="${SSH_PORT:-22}"
DEFAULT_LAYOUT="${LAYOUT:-splitv}"
SWAY_CONFIG="${SWAY_CONFIG:-$HOME/.config/sway/config}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
  echo -e "${GREEN}[INFO]${NC} $1" >&2
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1" >&2
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

# Show usage information
show_usage() {
  cat <<EOF
Usage: sway-vms [OPTIONS] <vmid1> [vmid2] ...

Open SSH connections to Proxmox VMs in Sway terminal windows.

Options:
  -h, --help          Show this help message
  -u, --user USER     SSH username (default: $DEFAULT_SSH_USER)
  -p, --port PORT     SSH port (default: $DEFAULT_SSH_PORT)
  -k, --key KEY       SSH private key path
  -l, --layout LAYOUT Terminal layout: splitv, splith, tabbed, grid (default: $DEFAULT_LAYOUT)
  -t, --terminal TERM Terminal emulator (default: auto-detect)

Environment Variables:
  SSH_USER            Default SSH username
  SSH_PORT            Default SSH port
  SSH_KEY             Default SSH private key path
  TERMINAL            Default terminal emulator
  LAYOUT              Default terminal layout
  SWAY_CONFIG         Path to Sway config file

Examples:
  sway-vms 100 101 102
  SSH_USER=admin sway-vms 100
  LAYOUT=grid sway-vms 100 101
  SSH_KEY=~/.ssh/id_rsa sway-vms 100
EOF
}

# Check if required dependencies are available
check_dependencies() {
  local missing_deps=()

  for dep in qm jq swaymsg; do
    if ! command -v "$dep" >/dev/null 2>&1; then
      missing_deps+=("$dep")
    fi
  done

  if [[ ${#missing_deps[@]} -gt 0 ]]; then
    log_error "Missing required dependencies: ${missing_deps[*]}"
    log_error "Please install the missing dependencies and try again."
    exit 1
  fi
}

# Detect terminal emulator from Sway config
detect_terminal() {
  if [[ -n "${TERMINAL:-}" ]]; then
    echo "$TERMINAL"
    return
  fi

  if [[ -f "$SWAY_CONFIG" ]]; then
    local detected_terminal
    detected_terminal=$(grep -E "^set\\s+\\\$term" "$SWAY_CONFIG" | awk '{print $3}' | tail -n1 || true)

    if [[ -n "$detected_terminal" ]]; then
      echo "$detected_terminal"
      return
    fi
  fi

  # Fallback to common terminals
  for term in foot alacritty kitty wezterm gnome-terminal konsole; do
    if command -v "$term" >/dev/null 2>&1; then
      echo "$term"
      return
    fi
  done

  log_error "No suitable terminal emulator found. Please set TERMINAL environment variable."
  exit 1
}

# Validate VM ID format
validate_vmid() {
  local vmid="$1"

  if ! [[ "$vmid" =~ ^[0-9]+$ ]]; then
    log_error "Invalid VM ID: $vmid (must be a number)"
    return 1
  fi

  if [[ "$vmid" -lt 100 || "$vmid" -gt 999999999 ]]; then
    log_error "Invalid VM ID: $vmid (out of reasonable range)"
    return 1
  fi
}

# Check if VM exists and is running
check_vm_status() {
  local vmid="$1"

  if ! qm config "$vmid" >/dev/null 2>&1; then
    log_error "VM $vmid does not exist"
    return 1
  fi

  local status
  status=$(qm status "$vmid" 2>/dev/null | awk '{print $2}' || echo "unknown")

  if [[ "$status" != "running" ]]; then
    log_error "VM $vmid is not running (status: $status)"
    return 1
  fi

  return 0
}

# Get VM name for display
get_vm_name() {
  local vmid="$1"
  qm config "$vmid" 2>/dev/null | grep '^name:' | cut -d':' -f2- | xargs || echo "VM-$vmid"
}

# Get IP address of VM
get_vm_ip() {
  local vmid="$1"
  local timeout="${2:-10}"

  log_info "Getting IP address for VM $vmid..."

  local ip
  ip=$(timeout "$timeout" qm guest cmd "$vmid" network-get-interfaces 2>/dev/null |
    jq -r '.[]?."ip-addresses"[]?."ip-address"' |
    grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' |
    head -n1 || true)

  if [[ -z "$ip" ]]; then
    log_warn "Could not get IP address for VM $vmid (QEMU guest agent may not be running)"
    return 1
  fi

  echo "$ip"
}

# Build SSH command
build_ssh_command() {
  local ip="$1"
  local user="$2"
  local port="$3"
  local key="${4:-}"
  local vm_name="$5"

  local ssh_opts=()
  ssh_opts+=("-o" "ConnectTimeout=10")
  ssh_opts+=("-o" "StrictHostKeyChecking=no")
  ssh_opts+=("-o" "UserKnownHostsFile=/dev/null")

  if [[ -n "$key" ]]; then
    ssh_opts+=("-i" "$key")
  fi

  if [[ "$port" != "22" ]]; then
    ssh_opts+=("-p" "$port")
  fi

  local ssh_cmd="ssh ${ssh_opts[*]} $user@$ip"
  local fallback_cmd="read -p 'Connection failed. Press Enter to close...'"

  echo "$ssh_cmd || $fallback_cmd"
}

# Set up terminal layout
setup_layout() {
  local layout="$1"
  local vm_count="$2"

  case "$layout" in
  "splitv")
    # Vertical split (default behavior)
    if [[ "$vm_count" -gt 1 ]]; then
      swaymsg splitv
    fi
    ;;
  "splith")
    # Horizontal split
    if [[ "$vm_count" -gt 1 ]]; then
      swaymsg splith
    fi
    ;;
  "tabbed")
    # Tabbed layout
    swaymsg layout tabbed
    ;;
  "grid")
    # Grid layout (simple implementation)
    swaymsg layout splitv
    ;;
  *)
    log_warn "Unknown layout: $layout. Using default splitv."
    swaymsg splitv
    ;;
  esac
}

# Parse command line arguments
parse_args() {
  while [[ $# -gt 0 ]]; do
    case $1 in
    -h | --help)
      show_usage
      exit 0
      ;;
    -u | --user)
      SSH_USER="$2"
      shift 2
      ;;
    -p | --port)
      SSH_PORT="$2"
      shift 2
      ;;
    -k | --key)
      SSH_KEY="$2"
      shift 2
      ;;
    -l | --layout)
      LAYOUT="$2"
      shift 2
      ;;
    -t | --terminal)
      TERMINAL="$2"
      shift 2
      ;;
    -*)
      log_error "Unknown option: $1"
      show_usage
      exit 1
      ;;
    *)
      VM_IDS+=("$1")
      shift
      ;;
    esac
  done
}

# Main function
main() {
  # Initialize variables
  local VM_IDS=()
  local SSH_USER="$DEFAULT_SSH_USER"
  local SSH_PORT="$DEFAULT_SSH_PORT"
  local SSH_KEY="${SSH_KEY:-}"
  local LAYOUT="$DEFAULT_LAYOUT"
  local TERMINAL=""

  # Parse command line arguments
  parse_args "$@"

  # Check if VM IDs were provided
  if [[ ${#VM_IDS[@]} -eq 0 ]]; then
    log_error "No VM IDs provided"
    show_usage
    exit 1
  fi

  # Check dependencies
  check_dependencies

  # Detect terminal
  TERMINAL=$(detect_terminal)
  log_info "Using terminal: $TERMINAL"

  # Validate VM IDs and check status
  local valid_vm_ids=()
  for vmid in "${VM_IDS[@]}"; do
    if validate_vmid "$vmid" && check_vm_status "$vmid"; then
      valid_vm_ids+=("$vmid")
    fi
  done

  if [[ ${#valid_vm_ids[@]} -eq 0 ]]; then
    log_error "No valid VMs to connect to"
    exit 1
  fi

  # Set up layout
  setup_layout "$LAYOUT" "${#valid_vm_ids[@]}"

  # Connect to VMs
  for vmid in "${valid_vm_ids[@]}"; do
    local vm_name
    vm_name=$(get_vm_name "$vmid")

    local ip
    if ! ip=$(get_vm_ip "$vmid"); then
      log_warn "Skipping VM $vmid ($vm_name) - could not get IP address"
      continue
    fi

    log_info "Connecting to VM $vmid ($vm_name) at $ip..."

    local ssh_cmd
    ssh_cmd=$(build_ssh_command "$ip" "$SSH_USER" "$SSH_PORT" "$SSH_KEY" "$vm_name")

    # Execute in terminal with custom title
    swaymsg exec "$TERMINAL -t 'VM $vmid ($vm_name)' -e bash -c '$ssh_cmd'"
  done

  log_info "Initiated connections to ${#valid_vm_ids[@]} VM(s)"
}

# Run main function with all arguments
main "$@"
