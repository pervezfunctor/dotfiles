#!/usr/bin/env bash

# shellcheck disable=SC1091

set -euo pipefail -o errtrace

SCRIPT_NAME="$(basename "${BASH_SOURCE[0]}")"
readonly SCRIPT_NAME

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
source "$SCRIPT_DIR/utils"

log_info() {
  echo "â„¹ï¸  [INFO] $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

log_warn() {
  echo "âš ï¸  [WARN] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
}

log_error() {
  echo "âŒ [ERROR] $(date '+%Y-%m-%d %H:%M:%S') - $1" >&2
}

log_success() {
  echo "âœ… [SUCCESS] $(date '+%Y-%m-%d %H:%M:%S') - $1"
}

check_prerequisites() {
  check_root_user

  if ! has_cmd qm; then
    log_error "The 'qm' command is required. This script must be run on a Proxmox host."
    return 1
  fi

  if [[ -z "$PROXMOX_STORAGE" ]]; then
    log_info "No storage specified, detecting suitable storage..."
    if ! storage=$(detect_storage); then
      log_error "Failed to detect suitable storage"
      return 1
    fi
    PROXMOX_STORAGE="$storage"
    log_info "Auto-detected storage: $storage"
  fi

  return 0
}

usage() {
  echo
  sleep 1

  cat <<EOF
ðŸš€ Usage: $SCRIPT_NAME --template-id TEMPLATE_ID [OPTIONS]

ðŸ“‹ Required:
  --template-id TEMPLATE_ID       ðŸ”¢ Template ID to clone from

ðŸ“‹ Options:
  --vm-id VM_ID                   ðŸ”¢ VM ID for the new VM (optional, auto-assigned if not provided)
  -s, --storage STORAGE            ðŸ’¾ Proxmox storage target for cloned VM (default: local-lvm)
  -n, --name NAME                  ðŸ·ï¸  Custom name for the VM (default: vm-{vm_id})
  -c, --cpu CORES                  ðŸ”§ Number of CPU cores (default: template value)
  -m, --memory MEMORY              ðŸ’¾ Memory size in MB (default: template value)
  -d, --disk-size SIZE             ðŸ’¿ Disk size in GB (default: template value)
  -u, --username USERNAME          ðŸ‘¤ Cloud-init username (default: template value)
  -p, --password PASSWORD          ðŸ” Cloud-init password (default: template value)
  -k, --ssh-key SSH_KEY            ðŸ”‘ SSH public key for cloud-init (default: template value)
  -h, --help                        â“ Display this help message

ðŸ“ Examples:
  $SCRIPT_NAME --template-id 201                          # Create VM from template 201 with auto-assigned ID
  $SCRIPT_NAME --template-id 202 --vm-id 150              # Create VM from template 202 with specific ID 150
  $SCRIPT_NAME --template-id 203 -s local-zfs -n my-vm    # Create VM from template 203 with custom storage and name
  $SCRIPT_NAME --template-id 204 -c 4 -m 4096 -d 32       # Create VM from template 204 with 4 cores, 4GB RAM, 32GB disk
  $SCRIPT_NAME --template-id 205 -u myuser -p mypass       # Create VM from template 205 with custom credentials
  $SCRIPT_NAME --template-id 206 -k ~/.ssh/id_rsa.pub      # Create VM from template 206 with SSH key

EOF
}

parse_args() {
  PROXMOX_STORAGE=""
  VM_NAME=""
  TEMPLATE_ID=""
  VM_ID=""
  CPU_CORES=""
  MEMORY_SIZE=""
  DISK_SIZE=""
  USERNAME=""
  PASSWORD=""
  SSH_KEY=""

  while [[ "$#" -gt 0 ]]; do
    case $1 in
    --template-id)
      TEMPLATE_ID="$2"
      shift 2
      ;;
    --vm-id)
      VM_ID="$2"
      shift 2
      ;;
    -s | --storage)
      PROXMOX_STORAGE="$2"
      shift 2
      ;;
    -n | --name)
      VM_NAME="$2"
      shift 2
      ;;
    -c | --cpu)
      CPU_CORES="$2"
      shift 2
      ;;
    -m | --memory)
      MEMORY_SIZE="$2"
      shift 2
      ;;
    -d | --disk-size)
      DISK_SIZE="$2"
      shift 2
      ;;
    -u | --username)
      USERNAME="$2"
      shift 2
      ;;
    -p | --password)
      PASSWORD="$2"
      shift 2
      ;;
    -k | --ssh-key)
      SSH_KEY="$2"
      shift 2
      ;;
    -h | --help)
      usage
      exit 0
      ;;
    *)
      log_error "Unknown parameter: $1"
      usage
      exit 1
      ;;
    esac
  done
}

template_exists() {
  local template_id="$1"

  if qm list 2>/dev/null | awk -v id="$template_id" '$1 == id { found=1 } END { exit !found }'; then
    return 0
  else
    return 1
  fi
}

vm_exists() {
  local vm_id="$1"

  if qm list 2>/dev/null | awk -v id="$vm_id" '$1 == id { found=1 } END { exit !found }'; then
    return 0
  else
    return 1
  fi
}

get_vm_name() {
  local vm_id="$1"

  local distro_name
  distro_name=$(qm config "$vm_id" 2>/dev/null | grep "^name:" | awk '{print $2}' | cut -d'-' -f1 | tr -d ' ')

  if [[ -z "$distro_name" ]]; then
    log_warn "Could not extract distribution name from VM $vm_id, using 'vm' as fallback"
    echo "${vm_id}"
  else
    echo "$distro_name"
  fi
}

find_next_vm_id() {
  local next_id=100
  local max_id=999

  while [[ "$next_id" -le "$max_id" ]]; do
    if ! vm_exists "$next_id"; then
      echo "$next_id"
      return 0
    fi
    ((next_id++))
  done

  log_error "No available VM IDs found in range 100-999"
  return 1
}

create_vm() {
  local template_id="$1"
  local vm_id="$2"
  local vm_name="${VM_NAME:-${get_vm_name "$template_id"}-vm}"

  log_info "Creating VM from template $template_id..."

  if qm clone "$template_id" "$vm_id" --name "$vm_name" --storage "$PROXMOX_STORAGE" --full; then
    log_success "VM cloned successfully (ID: $vm_id, Name: $vm_name, Template: $template_id)"

    if [[ -n "$CPU_CORES" ]]; then
      log_info "Setting CPU cores to: $CPU_CORES"
      if qm set "$vm_id" --cores "$CPU_CORES"; then
        log_success "CPU cores set to $CPU_CORES"
      else
        log_error "Failed to set CPU cores"
        return 1
      fi
    fi

    if [[ -n "$MEMORY_SIZE" ]]; then
      log_info "Setting memory to: ${MEMORY_SIZE}MB"
      if qm set "$vm_id" --memory "$MEMORY_SIZE"; then
        log_success "Memory set to ${MEMORY_SIZE}MB"
      else
        log_error "Failed to set memory"
        return 1
      fi
    fi

    if [[ -n "$DISK_SIZE" ]]; then
      log_info "Setting disk size to: ${DISK_SIZE}GB"
      local current_size
      current_size=$(qm config "$vm_id" | grep "^scsi0:" | sed 's/.*size=\([0-9]*\).*/\1/' || echo "0")

      if [[ "$DISK_SIZE" -lt "$current_size" ]]; then
        log_warn "Disk shrinking is not supported (current: ${current_size}G, requested: ${DISK_SIZE}G)"
        log_info "Keeping current disk size of ${current_size}G"
      else
        if qm resize "$vm_id" scsi0 "${DISK_SIZE}G"; then
          log_success "Disk resized to ${DISK_SIZE}GB"
        else
          log_error "Failed to resize disk"
          return 1
        fi
      fi
    fi

    local cloud_init_args=("$vm_id")

    if [[ -n "$USERNAME" ]]; then
      cloud_init_args+=(--ciuser "$USERNAME")
      log_info "Setting cloud-init username to: $USERNAME"
    fi

    if [[ -n "$PASSWORD" ]]; then
      cloud_init_args+=(--cipassword "$PASSWORD")
      log_info "Setting cloud-init password"
    fi

    if [[ -n "$SSH_KEY" ]]; then
      if [[ -f "$SSH_KEY" ]]; then
        cloud_init_args+=(--sshkeys "$SSH_KEY")
        log_info "Setting cloud-init SSH key from file: $SSH_KEY"
      else
        local temp_ssh_key="/tmp/vm-create-ssh-key-$$"
        printf '%s' "$SSH_KEY" >"$temp_ssh_key"
        cloud_init_args+=(--sshkeys "$temp_ssh_key")
        log_info "Setting cloud-init SSH key from parameter (using temp file: $temp_ssh_key)"
        trap 'rm -f "$temp_ssh_key"' RETURN
      fi
    fi

    if [[ ${#cloud_init_args[@]} -gt 1 ]]; then
      if qm set "${cloud_init_args[@]}"; then
        log_success "Cloud-init configuration applied successfully"
      else
        log_error "Failed to apply cloud-init configuration"
        return 1
      fi
    fi

    log_success "VM configuration completed successfully!"
    return 0
  else
    log_error "Failed to create VM from template $template_id"
    return 1
  fi
}

main() {
  echo "ðŸš€ Starting VM creation from template"

  parse_args "$@"

  if [[ -z "$TEMPLATE_ID" ]]; then
    log_error "Template ID is required"
    usage
    exit 1
  fi

  check_prerequisites || exit 1

  if [[ -z "$VM_ID" ]]; then
    VM_ID=$(find_next_vm_id)
    log_info "Auto-assigned VM ID: $VM_ID"
  else
    if vm_exists "$VM_ID"; then
      log_error "VM with ID $VM_ID already exists"
      exit 1
    fi
  fi

  if ! template_exists "$TEMPLATE_ID"; then
    log_error "Template with ID $TEMPLATE_ID does not exist"
    exit 1
  fi

  if create_vm "$TEMPLATE_ID" "$VM_ID"; then
    log_success "VM creation completed successfully!"
  else
    log_error "VM creation failed"
    exit 1
  fi
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
