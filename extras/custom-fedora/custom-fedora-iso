#!/usr/bin/env bash
set -euo pipefail

ISO_URL="https://download.fedoraproject.org/pub/fedora/linux/releases/42/Everything/x86_64/iso/Fedora-Everything-netinst-x86_64-42-1.11.iso"
ISO_NAME="Fedora-Everything-netinst-x86_64-42-1.11.iso"
ISO_LABEL="FEDORA_CUSTOM"
KICKSTART_FILE="ks.cfg"
CUSTOM_ISO="Fedora42-custom.iso"

WORKDIR=$(mktemp -d)
EXTRACT_DIR="$WORKDIR/iso"
MOD_DIR="$WORKDIR/custom"

echo "[+] Downloading Fedora Everything ISO..."
curl -L -o "$WORKDIR/$ISO_NAME" "$ISO_URL"

echo "[+] Extracting ISO contents..."
mkdir -p "$EXTRACT_DIR"
bsdtar -C "$EXTRACT_DIR" -xf "$WORKDIR/$ISO_NAME"

echo "[+] Copying Kickstart file..."
cp "$KICKSTART_FILE" "$EXTRACT_DIR/ks.cfg"

echo "[+] Modifying GRUB config..."
GRUB_CFG="$EXTRACT_DIR/EFI/BOOT/grub.cfg"
sed -i 's/linuxefi \(.*\)/linuxefi \1 inst.ks=cdrom:\/ks.cfg/' "$GRUB_CFG"

if [[ -f "$EXTRACT_DIR/isolinux/isolinux.cfg" ]]; then
  echo "[+] Modifying ISOLINUX config..."
  sed -i 's/linux \(.*\)/linux \1 inst.ks=cdrom:\/ks.cfg/' "$EXTRACT_DIR/isolinux/isolinux.cfg"
fi

echo "[+] Rebuilding ISO..."
xorriso -as mkisofs \
  -o "$CUSTOM_ISO" \
  -isohybrid-mbr "$EXTRACT_DIR/images/boot.iso" \
  -c isolinux/boot.cat \
  -b isolinux/isolinux.bin \
  -no-emul-boot -boot-load-size 4 -boot-info-table \
  -eltorito-alt-boot \
  -e images/efiboot.img \
  -no-emul-boot \
  -isohybrid-gpt-basdat \
  -V "$ISO_LABEL" \
  "$EXTRACT_DIR"

echo "[âœ“] Custom Fedora ISO created: $CUSTOM_ISO"

# run in qemu with
# qemu-system-x86_64 -m 4096 -cdrom Fedora42-custom.iso -boot d
