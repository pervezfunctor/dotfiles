#!/bin/bash

set -euo pipefail

# shellcheck disable=SC1091
source "$(dirname "$0")/utils"

check_prerequisites() {
  for cmd in lsblk pct mountpoint; do
    if ! command -v "$cmd" &>/dev/null; then
      echo "Error: Required command '$cmd' not found."
      exit 1
    fi
  done
}

check_prerequisites

select_usb_device() {
  mapfile -t usb_devices < <(lsblk -lno NAME,TRAN | awk '$2 == "usb" {print "/dev/" $1}')
  if [ "${#usb_devices[@]}" -eq 0 ]; then
    echo "‚ö†Ô∏è No USB devices found."
    exit 1
  fi

  echo "Available USB devices:"
  for i in "${!usb_devices[@]}"; do
    echo "[$i] ${usb_devices[$i]}"
  done

  read -r -p "Select USB device number: " usb_index
  if ! [[ "$usb_index" =~ ^[0-9]+$ ]] || [ "$usb_index" -ge "${#usb_devices[@]}" ]; then
    echo "Invalid selection."
    exit 1
  fi

  selected_usb="${usb_devices[$usb_index]}"
}

select_lxc() {
  mapfile -t containers < <(pct list | awk 'NR>1 {print $1}')
  mapfile -t container_names < <(pct list | awk 'NR>1 {print $2}')

  if [ "${#containers[@]}" -eq 0 ]; then
    echo "‚ö†Ô∏è No LXC containers found."
    exit 1
  fi

  echo "Available LXC containers:"
  for i in "${!containers[@]}"; do
    echo "[$i] ${containers[$i]} ${container_names[$i]}"
  done

  read -r -p "Select LXC container number: " ct_index
  if ! [[ "$ct_index" =~ ^[0-9]+$ ]] || [ "$ct_index" -ge "${#containers[@]}" ]; then
    echo "Invalid selection."
    exit 1
  fi
  selected_ctid="${containers[$ct_index]}"
}

mount_path() {
  read -r -p "Enter container mount path (e.g., /mnt/usb): " ct_mount
  if [ -z "$ct_mount" ]; then
    echo "No mount path specified."
    exit 1
  fi

  host_mount="/mnt/usb_${selected_usb#/dev/}"

  if ! mountpoint -q "$host_mount"; then
    sudo mkdir -p "$host_mount"
    sudo mount "$selected_usb" "$host_mount"
  fi
}

next_mp() {
  conf_file="/etc/pve/lxc/${selected_ctid}.conf"
  if [ ! -f "$conf_file" ]; then
    echo "LXC config file not found: $conf_file"
    exit 1
  fi

  mapfile -t mp_indices < <(grep -oP '^mp\K\d+(?=:)' "$conf_file" || true)
  if [ "${#mp_indices[@]}" -eq 0 ]; then
    next_mp=0
  else
    max_index=$(printf '%s\n' "${mp_indices[@]}" | sort -n | tail -1)
    next_mp=$((max_index + 1))
  fi
}

add_mount() {
  conf_file="/etc/pve/lxc/${selected_ctid}.conf"
  if [ ! -f "$conf_file" ]; then
    echo "LXC config file not found: $conf_file"
    exit 1
  fi

  next_mp=$(next_mp)
  echo "mp${next_mp}: $host_mount,mp=$ct_mount" | sudo tee -a "$conf_file" >/dev/null
}

restart_container() {
  read -rp "üîÑ Restart container $selected_ctid now to apply changes? (y/n): " RESTART
  if [[ "$RESTART" =~ ^[Yy]$ ]]; then
    sudo pct restart "$selected_ctid"
    echo "‚úÖ Container restarted. USB is now available at $ct_mount"
  else
    echo "‚úÖ USB mount added. Restart container manually to use it."
  fi
}

main() {
  select_lxc
  # check_container "$selected_ctid" || exit 1
  # if ! container_privileged "$selected_ctid"; then
  #   echo "‚ö†Ô∏è Container $selected_ctid is unprivileged. USB mounts will not be available inside the container."
  # fi

  select_usb_device
  mount_path
  add_mount

  echo "‚úÖ Success! $selected_usb mounted to CT $selected_ctid at $ct_mount"

  restart_container
}

main "$@"
