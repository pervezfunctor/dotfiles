#!/usr/bin/env bash
set -euo pipefail -o errtrace

LOGDIR="${XDG_STATE_HOME:-$HOME/.local/state}/dotfiles/logs"

usage() {
  printf 'Usage: %s <level> [--fzf]\n' "$0"
  printf 'Levels:\n'
  printf '  slog | info | warn | fail | success | output | error | all\n'
  printf '\nExamples:\n'
  printf '  dotfiles-view-logs info\n'
  printf '  dotfiles-view-logs warn --fzf\n'
  printf '  dotfiles-view-logs all | less -R\n'
  exit 1
}

[ $# -ge 1 ] || usage
LEVEL="$1"
USE_FZF=0

[ $# -ge 2 ] && [ "$2" = "--fzf" ] && USE_FZF=1

case "$LEVEL" in
slog | info | warn | fail | success | output | error | all) ;;
*) usage ;;
esac

cd "$LOGDIR" || {
  echo "No logs found at $LOGDIR"
  exit 1
}

# ------------------------------------------------------------
# Severity cascade
# ------------------------------------------------------------
declare -a levels_to_show

case "$LEVEL" in
error) levels_to_show=(error) ;;
fail) levels_to_show=(fail error) ;;
warn) levels_to_show=(warn fail error) ;;
success) levels_to_show=(success warn fail error) ;;
info) levels_to_show=(info success warn fail error) ;;
slog) levels_to_show=(slog info success warn fail error) ;;
output) levels_to_show=(output) ;;
all) levels_to_show=(slog info warn fail success output error) ;;
esac

# ------------------------------------------------------------
# Collect files
# ------------------------------------------------------------
declare -a files
for lvl in "${levels_to_show[@]}"; do
  while IFS= read -r f; do
    files+=("$f")
  done < <(find . -maxdepth 1 -type f -name "*_${lvl}.log" -printf "%f\n")
done

if [ ${#files[@]} -eq 0 ]; then
  echo "No matching log entries for level '$LEVEL'."
  exit 0
fi

# ------------------------------------------------------------
# Colorization rules (ANSI)
# ------------------------------------------------------------
colorize() {
  local line="$1"

  case "$line" in
  *" FAIL "*) printf "\033[1;31m%s\033[0m\n" "$line" ;;  # red
  *" WARN "*) printf "\033[1;33m%s\033[0m\n" "$line" ;;  # yellow
  *" INFO "*) printf "\033[1;36m%s\033[0m\n" "$line" ;;  # cyan
  *" SLOG "*) printf "\033[1;35m%s\033[0m\n" "$line" ;;  # magenta
  *" OK "*) printf "\033[1;32m%s\033[0m\n" "$line" ;;    # green
  *" error "*) printf "\033[1;31m%s\033[0m\n" "$line" ;; # red
  *) printf "%s\n" "$line" ;;
  esac
}

# ------------------------------------------------------------
# Gather + sort + colorize
# ------------------------------------------------------------
merge_sorted() {
  grep -h . "${files[@]}" |
    sort |
    while IFS= read -r line; do colorize "$line"; done
}

# ------------------------------------------------------------
# FZF MODE (interactive)
# ------------------------------------------------------------
if [ "$USE_FZF" -eq 1 ]; then
  command -v fzf >/dev/null 2>&1 || {
    echo "fzf not installed."
    exit 1
  }

  merge_sorted | fzf --ansi --no-sort --height=100% --prompt="logs> "
  exit 0
fi

# ------------------------------------------------------------
# DEFAULT MODE
# ------------------------------------------------------------
merge_sorted
