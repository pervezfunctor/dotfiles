#! /usr/bin/env bash

# shellcheck disable=SC2120

export BOXES_DIR=${USE_BOXES_DIR:-${BOXES_DIR}}

has_cmd distrobox || return 0

dt-logs() {
  podman logs "$1"
}

dt_enter() {
  local CONTAINER_NAME=${1}
  shift
  distrobox enter -nw --clean-path --name "${CONTAINER_NAME}" -- "$@"
}

dt_enter_root() {
  local CONTAINER_NAME=${1}
  shift
  distrobox enter -nw --clean-path --root --name "${CONTAINER_NAME}" -- "$@"
}

dt_exec() {
  local CONTAINER_NAME=${1}
  shift

  dt_enter "${CONTAINER_NAME}" "$@"
}

dt_exec_root() {
  local CONTAINER_NAME=${1}
  shift

  dt_enter_root "${CONTAINER_NAME}" "$@"
}

dt_bash_exec() {
  local CONTAINER_NAME=${1}
  shift

  dt_enter "${CONTAINER_NAME}" bash -c "$*"
}

dt_create() {
  local CONTAINER_NAME=${1}
  local IMAGE=${2}
  shift 2

  if distrobox list | grep -q "^${CONTAINER_NAME}$"; then
    slog "Distrobox ${CONTAINER_NAME} already exists, skipping creation"
    return 0
  fi

  if dir_exists "${BOXES_DIR}/${CONTAINER_NAME}"; then
    fail "Directory ${BOXES_DIR}/${CONTAINER_NAME} already exists, refusing to create distrobox"
    return 1
  fi

  slog "Creating Ubuntu distrobox: ${CONTAINER_NAME}"
  if distrobox create \
    --hostname "${CONTAINER_NAME}" \
    --yes \
    --image "$IMAGE" \
    --home "${BOXES_DIR}/${CONTAINER_NAME}" \
    --name "$CONTAINER_NAME" \
    "$@"; then
    slog "Distrobox ${CONTAINER_NAME} created successfully"
    slog "Use dte ${CONTAINER_NAME} to enter"
    return 0
  else
    fail "Failed to create distrobox ${CONTAINER_NAME}"
    return 1
  fi
}

dt_create_root() {
  local CONTAINER_NAME=${1}
  local IMAGE=${2}
  shift 2

  if dt_create_root "$CONTAINER_NAME" "$IMAGE" "$@"; then
    slog "Distrobox ${CONTAINER_NAME} created successfully"
    slog "Use rdte ${CONTAINER_NAME} to enter"
    return 0
  else
    fail "Failed to create distrobox ${CONTAINER_NAME}"
    return 1
  fi
}

dt-ubuntu-noinit() {
  local CONTAINER_NAME=${1:-ubuntu-noinit}
  dt_create "${CONTAINER_NAME}" ubuntu:questing
}

dt-arch-noinit() {
  local CONTAINER_NAME=${1:-arch-noinit}
  dt_create "${CONTAINER_NAME}" archlinux:latest
}

dt-fedora-minimal-noinit() {
  local CONTAINER_NAME=${1:-fedora-minimal-noinit}
  dt_create "${CONTAINER_NAME}" registry.fedoraproject.org/fedora-minimal:latest
}

dt-debian-slim-noinit() {
  local CONTAINER_NAME=${1:-debian-slim-noinit}
  dt_create "${CONTAINER_NAME}" debian:trixie-slim
}

dt-fedora-noinit() {
  local CONTAINER_NAME=${1:-fedora-noinit}
  dt_create "${CONTAINER_NAME}" fedora:latest
}

dt-centos-noinit() {
  local CONTAINER_NAME=${1:-centos-noinit}
  dt_create "${CONTAINER_NAME}" centos:latest
}

dt-debian-noinit() {
  local CONTAINER_NAME=${1:-debian-noinit}
  dt_create "${CONTAINER_NAME}" debian:latest
}

dt-rocky-noinit() {
  local CONTAINER_NAME=${1:-rocky-noinit}
  dt_create "${CONTAINER_NAME}" rockylinux:9
}

dt-tw-noinit() {
  local CONTAINER_NAME=${1:-tw-noinit}
  dt_create "${CONTAINER_NAME}" opensuse/tumbleweed
}

dt-bluefin() {
  local CONTAINER_NAME=${1:-bluefin-cli}
  dt_create "${CONTAINER_NAME}" ghcr.io/ublue-os/bluefin-cli
}

dt-wolfi() {
  local CONTAINER_NAME=${1:-wolfi-ublue}
  dt_create "${CONTAINER_NAME}" ghcr.io/ublue-os/wolfi-toolbox
}

dt-virt-manager() {
  local CONTAINER_NAME=${1:-virt-manager}

  local PKGS=(
    openssh-server
    patterns-server-kvm_server
    patterns-server-kvm_tools
    qemu-extra
    qemu-linux-user
    qemu-hw-display-virtio-gpu
    qemu-ui-opengl
    qemu-spice
    spice-gtk
    libvirglrenderer1
    xmlstarlet
    jq
  )

  local services=(
    sshd.service
    virtqemud.socket
    virtnetworkd.socket
    virtstoraged.socket
    virtnodedevd.socket
  )

  dt_create_root "${CONTAINER_NAME}" registry.opensuse.org/opensuse/distrobox:latest \
    --pull \
    --init \
    --unshare-all \
    --additional-flags "-p 2222:22" \
    --init-hooks "zypper in -y --no-recommends ${PKGS[*]} && systemctl enable ${services[*]} && usermod -aG libvirt $USER"
}

dt-fedora-virt-manager() {
  local CONTAINER_NAME=${1:-fedora-virt-manager}
  local PKGS=(
    openssh-server
    libvirt
    virt-install
    virt-manager
  )
  local services=(
    sshd.service
    virtqemud.socket
    virtnetworkd.socket
    virtstoraged.socket
    virtnodedevd.socket
  )
  dt_create_root "${CONTAINER_NAME}" registry.fedoraproject.org/fedora:latest \
    --pull --init --unshare-all \
    --additional-flags "-p 2222:22" \
    --init-hooks "dnf install -y --skip-unavailable ${PKGS[*]} && systemctl enable ${services[*]} && usermod -aG libvirt $USER"
}

dt-docker-base() {
  local CONTAINER_NAME=${1:-docker-base}

  dt_create_root "${CONTAINER_NAME}" fedora:latest \
    --additional-packages "systemd docker" \
    --init \
    --unshare-all

  dt_exec_root "${CONTAINER_NAME}" sudo systemctl enable --now docker
  dt_exec_root "${CONTAINER_NAME}" sudo usermod -aG docker "$USER"
}

dt-docker-slim() {
  local CONTAINER_NAME=${1:-docker}
  slog "Creating Docker distrobox: ${CONTAINER_NAME}"
  sudo mkdir -p /var/lib/docker

  dt_create_root "${CONTAINER_NAME}" ghcr.io/ublue-os/docker-distrobox:latest \
    --init --unshare-all --no-entry \
    --volume /var/lib/docker \
    --additional-packages "systemd libpam-systemd"
}

dt-docker() {
  local CONTAINER_NAME=${1:-docker}
  dt-docker-slim "${CONTAINER_NAME}"

  # dt-ilm_exec "${CONTAINER_NAME}"
}

dt-incus() {
  local CONTAINER_NAME=${1:-incus}
  slog "Creating Incus distrobox: ${CONTAINER_NAME}"
  sudo mkdir -p /var/lib/incus

  dt_create_root "${CONTAINER_NAME}" ghcr.io/ublue-os/incus-distrobox:latest \
    --init --unshare-all --no-entry \
    --volume /var/lib/incus:/var/lib/incus \
    --volume /lib/modules:/lib/modules:ro \
    --additional-packages "systemd libpam-systemd" \
    --init-hooks "usermod -aG incus-admin ${USER}"
}

dt_create_ilm() {
  local CONTAINER_NAME=${1:-ilm}
  dt_create "$@"
  dt_exec "${CONTAINER_NAME}" bash -c "$(curl -sSL "${ILM_SETUP_URL}")" -- dt-slim
}

dt-alpine-edge() {
  local CONTAINER_NAME=${1:-alpine-edge}
  dt_create_ilm "${CONTAINER_NAME}" quay.io/toolbx-images/alpine-toolbox:edge \
    --init \
    --additional-packages "openrc openssh-server"

  dt_exec "${CONTAINER_NAME}" sudo rc-update add sshd default || true
}

dt-alpine() {
  local CONTAINER_NAME=${1:-alpine}
  dt_create_ilm "${CONTAINER_NAME}" quay.io/toolbx-images/alpine-toolbox:latest \
    --init --additional-packages "openrc openssh-server"

  dt_exec "${CONTAINER_NAME}" sudo rc-update add sshd default || true
}

dt-debian() {
  local CONTAINER_NAME=${1:-debian}
  if dt_create_ilm "${CONTAINER_NAME}" \
    quay.io/toolbx-images/debian-toolbox:latest \
    --init \
    --additional-packages "systemd libpam-systemd openssh-server"; then
    dt_exec "${CONTAINER_NAME}" sudo systemctl enable sshd || true
  fi
}

dt-ubuntu() {
  local CONTAINER_NAME=${1:-ubuntu}
  if dt_create_ilm "${CONTAINER_NAME}" quay.io/toolbx/ubuntu-toolbox:latest \
  --init \
    --additional-packages "systemd libpam-systemd openssh-server"; then
    dt_exec "${CONTAINER_NAME}" sudo systemctl enable sshd || true
  fi
}

dt-arch() {
  local CONTAINER_NAME=${1:-arch}
  if dt_create_ilm "${CONTAINER_NAME}" quay.io/toolbx/arch-toolbox:latest \
    --yes \
    --init \
    --additional-packages "systemd openssh"; then
    dt_exec "${CONTAINER_NAME}" sudo systemctl enable sshd || true
  fi
}

dt-tw() {
  local CONTAINER_NAME=${1:-tw}
  if dt_create_ilm "${CONTAINER_NAME}" \
    registry.opensuse.org/opensuse/tumbleweed:latest \
    --init \
    --additional-packages "systemd openssh-server"; then
    dt_exec "${CONTAINER_NAME}" sudo systemctl enable sshd || true
  fi
}

dt-fedora() {
  local CONTAINER_NAME=${1:-fedora}
  if dt_create_ilm "${CONTAINER_NAME}" quay.io/fedora/fedora-toolbox:43 \
    --init \
    --additional-packages "systemd openssh-server"; then
    dt_exec "${CONTAINER_NAME}" sudo systemctl enable sshd || true
  fi
}

dt-centos() {
  local CONTAINER_NAME=${1:-centos}
  if dt_create_ilm "${CONTAINER_NAME}" quay.io/centos/centos:stream10 \
    --init \
    --additional-packages "systemd openssh-server"; then
    dt_exec "${CONTAINER_NAME}" sudo systemctl enable sshd | true
  fi
}

dt-nix() {
  local CONTAINER_NAME=${1:-deb-nix}
  if dt-debian "$CONTAINER_NAME"; then
    dt_enter "${CONTAINER_NAME}" bash -c "$(curl -sSL "${ILM_SETUP_URL}")" -- nix
  fi
}

dt-alpine-noinit() {
  local CONTAINER_NAME=${1:-alpine-noinit}

  dt_create "${CONTAINER_NAME}" quay.io/toolbx-images/alpine-toolbox:latest \
    --additional-packages "gcc libc-dev make gzip zsh git curl neovim tmux ripgrep luarocks fzf eza zoxide github-cli delta bat trash-cli"
}

dt-alpine-edge-noinit() {
  local CONTAINER_NAME=${1:-alpine-edge-noinit}

  dt_create "${CONTAINER_NAME}" \
    quay.io/toolbx-images/alpine-toolbox:edge \
    --additional-packages "gcc libc-dev make gzip zsh git curl neovim tmux ripgrep luarocks fzf eza zoxide github-cli delta bat trash-cli"
}

dt-dev-default() {
  distrobox create --yes
  distrobox enter -nw --clean-path -- bash -c "$(curl -sSL "${ILM_SETUP_URL}")" -- dt-dev-atomic
  slog "Default distrobox created!"
}

# shellcheck disable=SC2120
dt-dev() {
  slog "Creating default distrobox"

  local os
  os=${1:-fedora}
  local CONTAINER_NAME=${2:-dev}

  if [[ ! "$os" =~ ^(ubuntu|debian|arch|tw|fedora)$ ]]; then
    fail "Invalid OS type: $os"
    slog "Valid options are: ubuntu, debian, arch, tw, fedora"
    return 1
  fi

  "dt-$os" "$CONTAINER_NAME"

  if dt_enter "${CONTAINER_NAME}" bash -c "$(curl -sSL "${ILM_SETUP_URL}")" -- dt-dev-atomic; then
    slog "Distrobox ${CONTAINER_NAME} setup successfully"
    slog "Use dte ${CONTAINER_NAME} to enter"
    return 0
  else
    fail "Failed to setup distrobox ${CONTAINER_NAME}"
    return 1
  fi
}

dt-main-install() {
  if [[ $# -lt 2 ]]; then
    fail "Usage: dt-main-install <distro> <mainstall> [name]"
    return 1
  fi
  local distro=$1
  local mainstall=$2
  local CONTAINER_NAME=${3:-"${distro}-${mainstall}"}

  "dt-$distro" "$name"
  dt_enter "$CONTAINER_NAME" bash -c "$(curl -sSL "${ILM_SETUP_URL}")" -- "$mainstall"
}

dt-group-install() {
  if [[ $# -lt 2 ]]; then
    fail "Usage: dt-group-install <distro> <groupstall> [name]"
    return 1
  fi
  local distro=$1
  local groupstall=$2
  local name=${3:-"${distro}-${groupstall}-test"}

  "dt-$distro" "$name"
  dt_enter "$name" bash -c "$(curl -sSL "${ILM_SETUP_URL}")"
  dt_enter "$name" ilmg "@$groupstall"
}

dt-ublue-all() {
  slog "Creating Bluefin, Wolfi and Ublue distroboxes"
  dt-bluefin
  dt-wolfi
  dt-docker
  dt-incus

  distrobox create \
    --hostname ubuntu-ublue \
    --yes \
    --image ghcr.io/ublue-os/ubuntu-toolbox:latest \
    --init \
    --additional-packages "systemd libpam-systemd" \
    --home "${BOXES_DIR}"/ubuntu-ublue \
    --name ubuntu-ublue

  distrobox create \
    --hostname fedora-ublue \
    --yes \
    --image ghcr.io/ublue-os/fedora-toolbox:latest \
    --init \
    --additional-packages "systemd" \
    --home "${BOXES_DIR}"/fedora-ublue \
    --name fedora-ublue

  distrobox create \
    --hostname arch-ublue \
    --yes \
    --image ghcr.io/ublue-os/arch-distrobox:latest \
    --init \
    --additional-packages "systemd" \
    --home "${BOXES_DIR}"/arch-ublue \
    --name arch-ublue

  slog "Creating Bluefin, Wolfi and Ublue distroboxes done!"
}

dt-alpine-toolbox() {
  dt_create alpine-toolbox quay.io/toolbx-images/alpine-toolbox:latest
}

dt-arch-toolbox() {
  dt_create arch-toolbox quay.io/toolbx/arch-toolbox:latest \
    --init \
    --additional-packages "systemd"
}

dt-fedora-toolbox() {
  dt_create fedora-toolbox quay.io/fedora/fedora-toolbox:43 \
    --init \
    --additional-packages "systemd"
}

dt-centos-toolbox() {
  dt_create centos-toolbox quay.io/toolbx-images/centos-toolbox:latest \
    --init \
    --additional-packages "systemd"
}

dt-debian-toolbox() {
  dt_create debian-toolbox quay.io/toolbx-images/debian-toolbox:latest \
    --init \
    --additional-packages "systemd"
}

dt-rockylinux-toolbox() {
  dt_create rockylinux-toolbox quay.io/toolbx-images/rockylinux-toolbox:latest \
    --init \
    --additional-packages "systemd"
}

dt-ubuntu-toolbox() {
  dt_create ubuntu-toolbox quay.io/toolbx/ubuntu-toolbox:latest \
    --init \
    --additional-packages "systemd libpam-systemd"
}

dt-toolbox-all() {
  dt-alpine-toolbox
  dt-arch-toolbox
  dt-fedora-toolbox
  dt-centos-toolbox
  dt-debian-toolbox
  dt-rockylinux-toolbox
  dt-ubuntu-toolbox
}

dt-nvidia-container-toolkit() {
  if has_cmd podman; then
    dt_create example-nvidia-toolkit docker.io/nvidia/cuda \
      --additional-flags "--gpus all"
  elif has_cmd docker; then
    dt_create example-nvidia-toolkit docker.io/nvidia/cuda \
      --additional-flags "--gpus all --device=nvidia.com/gpu=all"
  else
    warn "podman or docker not found"
  fi
}

dt-to-image() {
  if has_cmd podman; then
    podman container commit -p dt-name "$1"
    podman save "$1":latest | bzip2 >"$1".tar.bz
  elif has_cmd docker; then
    docker container commit -p dt-name "$1"
    docker save "${1}:latest" | gzip >"$1".tar.gz
  fi
}

dt-from-image() {
  local CONTAINER_NAME="${1:dt}"
  slog "Creating distrobox from image $1"

  if distrobox create \
    --hostname "${CONTAINER_NAME}" \
    --yes \
    --image "$1":latest \
    --name "$CONTAINER_NAME"; then
    dt_enter "$CONTAINER_NAME"
    slog "Done creating distrobox from image $1"
  fi
}

dt-containers() {
  podman ps -a -s
}

dt-static-network-create() {
  local network=${1:-default}
  local subnet=${2:-"192.168.100.0/24"}

  podman network create --subnet="${subnet}" "${network}"
}

dt-static-network-remove() {
  local network=${1:-default}

  podman network rm "${network}"
}

dt-static-ip() {
  local CONTAINER_NAME=${1:-static-box}
  local IP_ADDR=${2:-"192.168.100.10"}

  slog "Creating distrobox ${CONTAINER_NAME} with static IP ${IP_ADDR}"
  distrobox create \
    --yes \
    --image ubuntu:22.04 \
    --name "${CONTAINER_NAME}" \
    --unshare-netns \
    --additional-flags "--network default --ip ${IP_ADDR}"
}

dt-root_list() {
  distrobox list --root --no-color | tail -n +2 | awk '{print $3}'
}

dt-root_exists() {
  distrobox list --root | grep -Fq -- "${CONTAINER_NAME}"
}

dt-root-ip() {
  local CONTAINER_NAME=${1}
  local CONTAINER_ENGINE
  local IP_ADDRESS

  if [[ -z "${CONTAINER_NAME}" ]]; then
    echo "Usage: dt-root-ip <container-name>" >&2
    echo "Shows the IP address of a distrobox container" >&2
    return 1
  fi

  if ! dt-root_exists "${CONTAINER_NAME}"; then
    echo "Error: Container '${CONTAINER_NAME}' not found" >&2
    return 1
  fi

  if has_cmd podman && sudo podman ps -a --format "{{.Names}}" | grep -Fqx -- "${CONTAINER_NAME}"; then
    CONTAINER_ENGINE="podman"
  elif has_cmd docker && docker ps -a --format "{{.Names}}" | grep -Fqx -- "${CONTAINER_NAME}"; then
    CONTAINER_ENGINE="docker"
  else
    echo "Error: Could not find container '${CONTAINER_NAME}' with podman or docker" >&2
    return 1
  fi

  case "${CONTAINER_ENGINE}" in
  podman)
    if ! IP_ADDRESS=$(sudo podman inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "${CONTAINER_NAME}"); then
      echo "Error: Failed to inspect podman container '${CONTAINER_NAME}'" >&2
      return 1
    fi
    ;;
  docker)
    if ! IP_ADDRESS=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' "${CONTAINER_NAME}"); then
      echo "Error: Failed to inspect docker container '${CONTAINER_NAME}'" >&2
      return 1
    fi
    ;;
  esac

  if [[ -z "${IP_ADDRESS}" ]]; then
    echo "Error: Container '${CONTAINER_NAME}' does not have an assigned IP address" >&2
    return 1
  fi

  printf '%s\n' "${IP_ADDRESS}"
}

dt-root-ssh() {
  local CONTAINER_NAME=${1}
  local USER=${2:-$USER}
  local PORT=${3:-22}
  local CONTAINER_IP

  if [[ -z "${CONTAINER_NAME}" ]]; then
    echo "Usage: dt-root-ssh <container-name> [user] [port]" >&2
    return 1
  fi

  if ! CONTAINER_IP=$(dt-root-ip "${CONTAINER_NAME}"); then
    echo "Error: Could not determine IP address for container '${CONTAINER_NAME}'" >&2
    return 1
  fi

  echo "Connecting to ${CONTAINER_NAME} at ${CONTAINER_IP}:${PORT} as ${USER}..."
  ssh -p "${PORT}" "${USER}@${CONTAINER_IP}"
}

check_whiptail() {
  has_cmd whiptail && return 0

  echo "Error: whiptail is not installed. Please install it to use dt-root-ssh-tui."
  echo "On Ubuntu/Debian: sudo apt install whiptail"
  echo "On Fedora: sudo dnf install newt"
  echo "On Arch: sudo pacman -S newt"
}

dt-root-ssh-tui() {
  local CONTAINER_LIST
  local CONTAINER_NAME
  local CONTAINER_IP
  local USER=${1:-$USER}
  local PORT=${2:-22}
  local MENU_ITEMS=()
  local i=0

  check_whiptail || return 1

  CONTAINER_LIST=$(dt-root_list)

  if [[ -z "${CONTAINER_LIST}" ]]; then
    whiptail --title "Distrobox SSH" --msgbox "No distrobox containers found." 10 40
    return 0
  fi

  while IFS= read -r CONTAINER_NAME; do
    if [[ -n "${CONTAINER_NAME}" ]]; then
      if CONTAINER_IP=$(dt-root-ip "${CONTAINER_NAME}" 2>/dev/null); then
        MENU_ITEMS+=("${CONTAINER_NAME}" "${CONTAINER_IP}")
      else
        MENU_ITEMS+=("${CONTAINER_NAME}" "IP not available")
      fi
      ((i++))
    fi
  done <<<"${CONTAINER_LIST}"

  CONTAINER_NAME=$(whiptail --title "Distrobox SSH" \
    --menu "Select a container to SSH into (as ${USER} on port ${PORT}):" \
    20 60 10 "${MENU_ITEMS[@]}" 3>&1 1>&2 2>&3)

  if [[ $? -ne 0 || -z "${CONTAINER_NAME}" ]]; then
    echo "Cancelled."
    return 0
  fi

  if ! CONTAINER_IP=$(dt-root-ip "${CONTAINER_NAME}"); then
    whiptail --title "Error" --msgbox "Could not determine IP address for container '${CONTAINER_NAME}'" 10 40
    return 1
  fi

  echo "Connecting to ${CONTAINER_NAME} at ${CONTAINER_IP}:${PORT} as ${USER}..."
  ssh -p "${PORT}" "${USER}@${CONTAINER_IP}"
}

dt-root_list-ips() {
  local CONTAINER_LIST
  local CONTAINER_NAME
  local CONTAINER_IP

  CONTAINER_LIST=$(dt-root_list)

  if [[ -z "${CONTAINER_LIST}" ]]; then
    echo "No distrobox containers found."
    return 0
  fi

  echo "Distrobox Containers and IP Addresses:"
  echo "====================================="
  printf "%-20s %-15s\n" "Container Name" "IP Address"
  echo "-------------------------------------"

  while IFS= read -r CONTAINER_NAME; do
    if [[ -n "${CONTAINER_NAME}" ]]; then
      if CONTAINER_IP=$(dt-root-ip "${CONTAINER_NAME}" 2>/dev/null); then
        printf "%-20s %-15s\n" "${CONTAINER_NAME}" "${CONTAINER_IP}"
      else
        printf "%-20s %-15s\n" "${CONTAINER_NAME}" "N/A"
      fi
    fi
  done <<<"${CONTAINER_LIST}"
}

vscode-dt-root-ssh() {
  local CONTAINER_NAME=${1:-docker}
  local USER=${2:-$USER}
  local PORT=${3:-22}

  if [[ -z "${CONTAINER_NAME}" ]]; then
    echo "Usage: vscode-dt-root-ssh <container-name> [user] [port] [open-code] [pubkey] [known-dir] [strict-host-key-checking]" >&2
    echo "Connect VS Code to a root distrobox container via SSH" >&2
    return 1
  fi

  local CONTAINER_IP
  if ! CONTAINER_IP=$(dt-root-ip "${CONTAINER_NAME}"); then
    echo "Error: Could not determine IP address for container '${CONTAINER_NAME}'" >&2
    return 1
  fi

  if ! has_cmd code; then
    echo "VS Code not found."
  fi

  echo "Connecting to ${CONTAINER_NAME} at ${CONTAINER_IP}:${PORT} as ${USER}..."
  code --remote "ssh-remote+${USER}@${CONTAINER_IP}" # -- "~-container-${CONTAINER_NAME}"
}

show_completion_info() {
  local distro="$1"
  local dt-name="$2"

  success "ðŸŽ‰ === Distrobox Creation Complete ==="
  echo
  slog "ðŸ“¦ Container Details:"
  echo "  Name: $dt-name"
  echo "  Distribution: $distro"
  echo "  Home Directory: ${BOXES_DIR}/${dt-name}"
  echo

  slog "ðŸš€ Useful Commands:"
  echo "  List containers:      dt list"
  echo "  Enter container:      dt enter $dt-name"
  echo "  Delete container:     dt delete $dt-name"
  echo "  Stop container:       dt stop $dt-name"
  echo "If you need ssh access to the container, run inside container:"
  echo "   dt-ssh-enable <port-no>"
  echo "Afterwards you can ssh to the container from host using:"
  echo "   ssh -p <port-no> $USER@$dt-name"
  # echo "Or use vscode to connect to the container:"
  # echo "   code --remote ssh-remote+${USER}@${CONTAINER_IP}"
}
